var dr=Object.defineProperty;var ur=(n,e,t)=>e in n?dr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>ur(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();var We=(n=>(n.NETWORK="network",n.TIMEOUT="timeout",n.PERMISSION="permission",n.VALIDATION="validation",n.EXECUTION="execution",n.EMPTY_RESULT="empty_result",n.UNTRUSTED_RESULT="untrusted_result",n.BUDGET_EXCEEDED="budget_exceeded",n.UNKNOWN="unknown",n))(We||{});function hr(n,e){const t=Date.now();return{id:mr(),conversation:{messages:[],toolResultsSummary:[]},task:{goal:n,steps:[],currentNode:"",currentStepIndex:0,progress:0},memory:{shortTerm:{},longTermKeys:[]},artifacts:{},telemetry:{totalDuration:0,tokenCount:0,toolCallCount:0,errorCount:0,retryCount:0,nodeTimings:{}},policy:{maxToolCalls:20,maxDuration:3e5,maxRetries:3,permissions:{},useStreaming:!0,...e},createdAt:t,updatedAt:t}}function O(n,e){const t=nt(n),r=e(t)||t;return r.updatedAt=Date.now(),r}function mr(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function nt(n){if(typeof structuredClone=="function")return structuredClone(n);if(n===null||typeof n!="object")return n;if(n instanceof Date)return new Date(n.getTime());if(n instanceof Array)return n.map(e=>nt(e));if(n instanceof Object){const e={};for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=nt(n[t]));return e}return n}const U={addMessage(n,e,t){return O(n,s=>{s.conversation.messages.push({role:e,content:t,timestamp:Date.now()})})},updateProgress(n,e){return O(n,t=>{t.task.progress=Math.min(100,Math.max(0,e))})},setCurrentNode(n,e){return O(n,t=>{t.task.currentNode=e})},incrementToolCall(n){return O(n,e=>{e.telemetry.toolCallCount+=1})},incrementError(n){return O(n,e=>{e.telemetry.errorCount+=1})},incrementRetry(n){return O(n,e=>{e.telemetry.retryCount+=1})},recordNodeTiming(n,e,t){return O(n,s=>{s.telemetry.nodeTimings[e]=(s.telemetry.nodeTimings[e]||0)+t,s.telemetry.totalDuration+=t})},addTokenUsage(n,e){return O(n,t=>{e.prompt&&(t.telemetry.tokenCount+=e.prompt),e.completion&&(t.telemetry.tokenCount+=e.completion),!e.prompt&&!e.completion&&e.total&&(t.telemetry.tokenCount+=e.total)})},checkBudget(n){const{telemetry:e,policy:t}=n;return e.toolCallCount>=t.maxToolCalls?{exceeded:!0,reason:`工具调用次数超限 (${e.toolCallCount}/${t.maxToolCalls})`}:e.totalDuration>=t.maxDuration?{exceeded:!0,reason:`总耗时超限 (${e.totalDuration}ms/${t.maxDuration}ms)`}:e.retryCount>=t.maxRetries?{exceeded:!0,reason:`重试次数超限 (${e.retryCount}/${t.maxRetries})`}:{exceeded:!1}}};class pr{constructor(){u(this,"events",[]);u(this,"listeners",new Map);u(this,"payloadStore",new Map)}emit(e,t,s,r){const a={id:this.generateEventId(),timestamp:Date.now(),type:e,status:t,summary:s,nodeId:r==null?void 0:r.nodeId,metadata:r==null?void 0:r.metadata};if((r==null?void 0:r.payload)!==void 0){const i=`payload-${a.id}`;this.payloadStore.set(i,r.payload),a.payloadRef=i}return this.events.push(a),this.events.length>1e3&&this.cleanup(),this.notifyListeners(e,a),this.notifyListeners("*",a),a}cleanup(){const e=this.events.length-1e3;if(e<=0)return;this.events.splice(0,e).forEach(s=>{s.payloadRef&&this.payloadStore.delete(s.payloadRef)})}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>{var s;(s=this.listeners.get(e))==null||s.delete(t)}}getEvents(){return[...this.events]}getPayload(e){return this.payloadStore.get(e)}clear(){this.events=[],this.payloadStore.clear()}export(){const e={};return this.payloadStore.forEach((t,s)=>{e[s]=t}),{events:this.events,payloads:e}}import(e){this.events=e.events,this.payloadStore=new Map(Object.entries(e.payloads))}notifyListeners(e,t){const s=this.listeners.get(e);s&&s.forEach(r=>{try{r(t)}catch(a){console.error(`Error in event listener for ${e}:`,a)}})}generateEventId(){return`evt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}var I;(function(n){n.assertEqual=r=>{};function e(r){}n.assertIs=e;function t(r){throw new Error}n.assertNever=t,n.arrayToEnum=r=>{const a={};for(const i of r)a[i]=i;return a},n.getValidEnumValues=r=>{const a=n.objectKeys(r).filter(o=>typeof r[r[o]]!="number"),i={};for(const o of a)i[o]=r[o];return n.objectValues(i)},n.objectValues=r=>n.objectKeys(r).map(function(a){return r[a]}),n.objectKeys=typeof Object.keys=="function"?r=>Object.keys(r):r=>{const a=[];for(const i in r)Object.prototype.hasOwnProperty.call(r,i)&&a.push(i);return a},n.find=(r,a)=>{for(const i of r)if(a(i))return i},n.isInteger=typeof Number.isInteger=="function"?r=>Number.isInteger(r):r=>typeof r=="number"&&Number.isFinite(r)&&Math.floor(r)===r;function s(r,a=" | "){return r.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}n.joinValues=s,n.jsonStringifyReplacer=(r,a)=>typeof a=="bigint"?a.toString():a})(I||(I={}));var Qt;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Qt||(Qt={}));const b=I.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ae=n=>{switch(typeof n){case"undefined":return b.undefined;case"string":return b.string;case"number":return Number.isNaN(n)?b.nan:b.number;case"boolean":return b.boolean;case"function":return b.function;case"bigint":return b.bigint;case"symbol":return b.symbol;case"object":return Array.isArray(n)?b.array:n===null?b.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?b.promise:typeof Map<"u"&&n instanceof Map?b.map:typeof Set<"u"&&n instanceof Set?b.set:typeof Date<"u"&&n instanceof Date?b.date:b.object;default:return b.unknown}},f=I.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class W extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=s=>{this.issues=[...this.issues,s]},this.addIssues=(s=[])=>{this.issues=[...this.issues,...s]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(a){return a.message},s={_errors:[]},r=a=>{for(const i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(r);else if(i.code==="invalid_return_type")r(i.returnTypeError);else if(i.code==="invalid_arguments")r(i.argumentsError);else if(i.path.length===0)s._errors.push(t(i));else{let o=s,l=0;for(;l<i.path.length;){const c=i.path[l];l===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],l++}}};return r(this),s}static assert(e){if(!(e instanceof W))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,I.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},s=[];for(const r of this.issues)if(r.path.length>0){const a=r.path[0];t[a]=t[a]||[],t[a].push(e(r))}else s.push(e(r));return{formErrors:s,fieldErrors:t}}get formErrors(){return this.flatten()}}W.create=n=>new W(n);const at=(n,e)=>{let t;switch(n.code){case f.invalid_type:n.received===b.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case f.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,I.jsonStringifyReplacer)}`;break;case f.unrecognized_keys:t=`Unrecognized key(s) in object: ${I.joinValues(n.keys,", ")}`;break;case f.invalid_union:t="Invalid input";break;case f.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${I.joinValues(n.options)}`;break;case f.invalid_enum_value:t=`Invalid enum value. Expected ${I.joinValues(n.options)}, received '${n.received}'`;break;case f.invalid_arguments:t="Invalid function arguments";break;case f.invalid_return_type:t="Invalid function return type";break;case f.invalid_date:t="Invalid date";break;case f.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:I.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case f.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="bigint"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case f.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case f.custom:t="Invalid input";break;case f.invalid_intersection_types:t="Intersection results could not be merged";break;case f.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case f.not_finite:t="Number must be finite";break;default:t=e.defaultError,I.assertNever(n)}return{message:t}};let fr=at;function gr(){return fr}const yr=n=>{const{data:e,path:t,errorMaps:s,issueData:r}=n,a=[...t,...r.path||[]],i={...r,path:a};if(r.message!==void 0)return{...r,path:a,message:r.message};let o="";const l=s.filter(c=>!!c).slice().reverse();for(const c of l)o=c(i,{data:e,defaultError:o}).message;return{...r,path:a,message:o}};function v(n,e){const t=gr(),s=yr({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===at?void 0:at].filter(r=>!!r)});n.common.issues.push(s)}class j{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const s=[];for(const r of t){if(r.status==="aborted")return x;r.status==="dirty"&&e.dirty(),s.push(r.value)}return{status:e.value,value:s}}static async mergeObjectAsync(e,t){const s=[];for(const r of t){const a=await r.key,i=await r.value;s.push({key:a,value:i})}return j.mergeObjectSync(e,s)}static mergeObjectSync(e,t){const s={};for(const r of t){const{key:a,value:i}=r;if(a.status==="aborted"||i.status==="aborted")return x;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value<"u"||r.alwaysSet)&&(s[a.value]=i.value)}return{status:e.value,value:s}}}const x=Object.freeze({status:"aborted"}),Ce=n=>({status:"dirty",value:n}),V=n=>({status:"valid",value:n}),Jt=n=>n.status==="aborted",Yt=n=>n.status==="dirty",ye=n=>n.status==="valid",Be=n=>typeof Promise<"u"&&n instanceof Promise;var k;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(k||(k={}));class ee{constructor(e,t,s,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=s,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Xt=(n,e)=>{if(ye(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new W(n.common.issues);return this._error=t,this._error}}};function _(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:s,description:r}=n;if(e&&(t||s))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(i,o)=>{const{message:l}=n;return i.code==="invalid_enum_value"?{message:l??o.defaultError}:typeof o.data>"u"?{message:l??s??o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:l??t??o.defaultError}},description:r}}class E{get description(){return this._def.description}_getType(e){return ae(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:ae(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new j,ctx:{common:e.parent.common,data:e.data,parsedType:ae(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Be(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const s=this.safeParse(e,t);if(s.success)return s.data;throw s.error}safeParse(e,t){const s={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ae(e)},r=this._parseSync({data:e,path:s.path,parent:s});return Xt(s,r)}"~validate"(e){var s,r;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ae(e)};if(!this["~standard"].async)try{const a=this._parseSync({data:e,path:[],parent:t});return ye(a)?{value:a.value}:{issues:t.common.issues}}catch(a){(r=(s=a==null?void 0:a.message)==null?void 0:s.toLowerCase())!=null&&r.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(a=>ye(a)?{value:a.value}:{issues:t.common.issues})}async parseAsync(e,t){const s=await this.safeParseAsync(e,t);if(s.success)return s.data;throw s.error}async safeParseAsync(e,t){const s={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ae(e)},r=this._parse({data:e,path:s.path,parent:s}),a=await(Be(r)?r:Promise.resolve(r));return Xt(s,a)}refine(e,t){const s=r=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(r):t;return this._refinement((r,a)=>{const i=e(r),o=()=>a.addIssue({code:f.custom,...s(r)});return typeof Promise<"u"&&i instanceof Promise?i.then(l=>l?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((s,r)=>e(s)?!0:(r.addIssue(typeof t=="function"?t(s,r):t),!1))}_refinement(e){return new ke({schema:this,typeName:S.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return ie.create(this,this._def)}nullable(){return we.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Y.create(this)}promise(){return Ze.create(this,this._def)}or(e){return ze.create([this,e],this._def)}and(e){return je.create(this,e,this._def)}transform(e){return new ke({..._(this._def),schema:this,typeName:S.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new lt({..._(this._def),innerType:this,defaultValue:t,typeName:S.ZodDefault})}brand(){return new jr({typeName:S.ZodBranded,type:this,..._(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new ct({..._(this._def),innerType:this,catchValue:t,typeName:S.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return xt.create(this,e)}readonly(){return dt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const vr=/^c[^\s-]{8,}$/i,br=/^[0-9a-z]+$/,kr=/^[0-9A-HJKMNP-TV-Z]{26}$/i,wr=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Sr=/^[a-z0-9_-]{21}$/i,xr=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,_r=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Tr=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Cr="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Ye;const Er=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Lr=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Ir=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ar=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Rr=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Mr=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ms="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",$r=new RegExp(`^${Ms}$`);function $s(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Dr(n){return new RegExp(`^${$s(n)}$`)}function Pr(n){let e=`${Ms}T${$s(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Or(n,e){return!!((e==="v4"||!e)&&Er.test(n)||(e==="v6"||!e)&&Ir.test(n))}function Br(n,e){if(!xr.test(n))return!1;try{const[t]=n.split(".");if(!t)return!1;const s=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),r=JSON.parse(atob(s));return!(typeof r!="object"||r===null||"typ"in r&&(r==null?void 0:r.typ)!=="JWT"||!r.alg||e&&r.alg!==e)}catch{return!1}}function Nr(n,e){return!!((e==="v4"||!e)&&Lr.test(n)||(e==="v6"||!e)&&Ar.test(n))}class se extends E{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==b.string){const a=this._getOrReturnCtx(e);return v(a,{code:f.invalid_type,expected:b.string,received:a.parsedType}),x}const s=new j;let r;for(const a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),v(r,{code:f.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="max")e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),v(r,{code:f.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),s.dirty());else if(a.kind==="length"){const i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(r=this._getOrReturnCtx(e,r),i?v(r,{code:f.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&v(r,{code:f.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),s.dirty())}else if(a.kind==="email")Tr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"email",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="emoji")Ye||(Ye=new RegExp(Cr,"u")),Ye.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"emoji",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="uuid")wr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"uuid",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="nanoid")Sr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"nanoid",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid")vr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"cuid",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="cuid2")br.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"cuid2",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="ulid")kr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"ulid",code:f.invalid_string,message:a.message}),s.dirty());else if(a.kind==="url")try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),v(r,{validation:"url",code:f.invalid_string,message:a.message}),s.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"regex",code:f.invalid_string,message:a.message}),s.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),s.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:{startsWith:a.value},message:a.message}),s.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:{endsWith:a.value},message:a.message}),s.dirty()):a.kind==="datetime"?Pr(a).test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:"datetime",message:a.message}),s.dirty()):a.kind==="date"?$r.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:"date",message:a.message}),s.dirty()):a.kind==="time"?Dr(a).test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{code:f.invalid_string,validation:"time",message:a.message}),s.dirty()):a.kind==="duration"?_r.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"duration",code:f.invalid_string,message:a.message}),s.dirty()):a.kind==="ip"?Or(e.data,a.version)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"ip",code:f.invalid_string,message:a.message}),s.dirty()):a.kind==="jwt"?Br(e.data,a.alg)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"jwt",code:f.invalid_string,message:a.message}),s.dirty()):a.kind==="cidr"?Nr(e.data,a.version)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"cidr",code:f.invalid_string,message:a.message}),s.dirty()):a.kind==="base64"?Rr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"base64",code:f.invalid_string,message:a.message}),s.dirty()):a.kind==="base64url"?Mr.test(e.data)||(r=this._getOrReturnCtx(e,r),v(r,{validation:"base64url",code:f.invalid_string,message:a.message}),s.dirty()):I.assertNever(a);return{status:s.value,value:e.data}}_regex(e,t,s){return this.refinement(r=>e.test(r),{validation:t,code:f.invalid_string,...k.errToObj(s)})}_addCheck(e){return new se({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...k.errToObj(e)})}url(e){return this._addCheck({kind:"url",...k.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...k.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...k.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...k.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...k.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...k.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...k.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...k.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...k.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...k.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...k.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...k.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...k.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...k.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...k.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...k.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...k.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...k.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...k.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...k.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...k.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...k.errToObj(t)})}nonempty(e){return this.min(1,k.errToObj(e))}trim(){return new se({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new se({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new se({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}se.create=n=>new se({checks:[],typeName:S.ZodString,coerce:(n==null?void 0:n.coerce)??!1,..._(n)});function zr(n,e){const t=(n.toString().split(".")[1]||"").length,s=(e.toString().split(".")[1]||"").length,r=t>s?t:s,a=Number.parseInt(n.toFixed(r).replace(".","")),i=Number.parseInt(e.toFixed(r).replace(".",""));return a%i/10**r}class ve extends E{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==b.number){const a=this._getOrReturnCtx(e);return v(a,{code:f.invalid_type,expected:b.number,received:a.parsedType}),x}let s;const r=new j;for(const a of this._def.checks)a.kind==="int"?I.isInteger(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{code:f.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):a.kind==="multipleOf"?zr(e.data,a.value)!==0&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(s=this._getOrReturnCtx(e,s),v(s,{code:f.not_finite,message:a.message}),r.dirty()):I.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,k.toString(t))}gt(e,t){return this.setLimit("min",e,!1,k.toString(t))}lte(e,t){return this.setLimit("max",e,!0,k.toString(t))}lt(e,t){return this.setLimit("max",e,!1,k.toString(t))}setLimit(e,t,s,r){return new ve({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:k.toString(r)}]})}_addCheck(e){return new ve({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:k.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:k.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:k.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:k.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:k.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:k.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:k.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:k.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:k.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&I.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const s of this._def.checks){if(s.kind==="finite"||s.kind==="int"||s.kind==="multipleOf")return!0;s.kind==="min"?(t===null||s.value>t)&&(t=s.value):s.kind==="max"&&(e===null||s.value<e)&&(e=s.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ve.create=n=>new ve({checks:[],typeName:S.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,..._(n)});class Re extends E{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==b.bigint)return this._getInvalidInput(e);let s;const r=new j;for(const a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(s=this._getOrReturnCtx(e,s),v(s,{code:f.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):I.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return v(t,{code:f.invalid_type,expected:b.bigint,received:t.parsedType}),x}gte(e,t){return this.setLimit("min",e,!0,k.toString(t))}gt(e,t){return this.setLimit("min",e,!1,k.toString(t))}lte(e,t){return this.setLimit("max",e,!0,k.toString(t))}lt(e,t){return this.setLimit("max",e,!1,k.toString(t))}setLimit(e,t,s,r){return new Re({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:s,message:k.toString(r)}]})}_addCheck(e){return new Re({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:k.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:k.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:k.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:k.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:k.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Re.create=n=>new Re({checks:[],typeName:S.ZodBigInt,coerce:(n==null?void 0:n.coerce)??!1,..._(n)});class es extends E{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==b.boolean){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.boolean,received:s.parsedType}),x}return V(e.data)}}es.create=n=>new es({typeName:S.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,..._(n)});class Ne extends E{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==b.date){const a=this._getOrReturnCtx(e);return v(a,{code:f.invalid_type,expected:b.date,received:a.parsedType}),x}if(Number.isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return v(a,{code:f.invalid_date}),x}const s=new j;let r;for(const a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),v(r,{code:f.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),s.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),v(r,{code:f.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),s.dirty()):I.assertNever(a);return{status:s.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Ne({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:k.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:k.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Ne.create=n=>new Ne({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:S.ZodDate,..._(n)});class ts extends E{_parse(e){if(this._getType(e)!==b.symbol){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.symbol,received:s.parsedType}),x}return V(e.data)}}ts.create=n=>new ts({typeName:S.ZodSymbol,..._(n)});class ss extends E{_parse(e){if(this._getType(e)!==b.undefined){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.undefined,received:s.parsedType}),x}return V(e.data)}}ss.create=n=>new ss({typeName:S.ZodUndefined,..._(n)});class rs extends E{_parse(e){if(this._getType(e)!==b.null){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.null,received:s.parsedType}),x}return V(e.data)}}rs.create=n=>new rs({typeName:S.ZodNull,..._(n)});class ns extends E{constructor(){super(...arguments),this._any=!0}_parse(e){return V(e.data)}}ns.create=n=>new ns({typeName:S.ZodAny,..._(n)});class it extends E{constructor(){super(...arguments),this._unknown=!0}_parse(e){return V(e.data)}}it.create=n=>new it({typeName:S.ZodUnknown,..._(n)});class oe extends E{_parse(e){const t=this._getOrReturnCtx(e);return v(t,{code:f.invalid_type,expected:b.never,received:t.parsedType}),x}}oe.create=n=>new oe({typeName:S.ZodNever,..._(n)});class as extends E{_parse(e){if(this._getType(e)!==b.undefined){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.void,received:s.parsedType}),x}return V(e.data)}}as.create=n=>new as({typeName:S.ZodVoid,..._(n)});class Y extends E{_parse(e){const{ctx:t,status:s}=this._processInputParams(e),r=this._def;if(t.parsedType!==b.array)return v(t,{code:f.invalid_type,expected:b.array,received:t.parsedType}),x;if(r.exactLength!==null){const i=t.data.length>r.exactLength.value,o=t.data.length<r.exactLength.value;(i||o)&&(v(t,{code:i?f.too_big:f.too_small,minimum:o?r.exactLength.value:void 0,maximum:i?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),s.dirty())}if(r.minLength!==null&&t.data.length<r.minLength.value&&(v(t,{code:f.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),s.dirty()),r.maxLength!==null&&t.data.length>r.maxLength.value&&(v(t,{code:f.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),s.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>r.type._parseAsync(new ee(t,i,t.path,o)))).then(i=>j.mergeArray(s,i));const a=[...t.data].map((i,o)=>r.type._parseSync(new ee(t,i,t.path,o)));return j.mergeArray(s,a)}get element(){return this._def.type}min(e,t){return new Y({...this._def,minLength:{value:e,message:k.toString(t)}})}max(e,t){return new Y({...this._def,maxLength:{value:e,message:k.toString(t)}})}length(e,t){return new Y({...this._def,exactLength:{value:e,message:k.toString(t)}})}nonempty(e){return this.min(1,e)}}Y.create=(n,e)=>new Y({type:n,minLength:null,maxLength:null,exactLength:null,typeName:S.ZodArray,..._(e)});function fe(n){if(n instanceof P){const e={};for(const t in n.shape){const s=n.shape[t];e[t]=ie.create(fe(s))}return new P({...n._def,shape:()=>e})}else return n instanceof Y?new Y({...n._def,type:fe(n.element)}):n instanceof ie?ie.create(fe(n.unwrap())):n instanceof we?we.create(fe(n.unwrap())):n instanceof ce?ce.create(n.items.map(e=>fe(e))):n}class P extends E{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=I.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==b.object){const c=this._getOrReturnCtx(e);return v(c,{code:f.invalid_type,expected:b.object,received:c.parsedType}),x}const{status:s,ctx:r}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof oe&&this._def.unknownKeys==="strip"))for(const c in r.data)i.includes(c)||o.push(c);const l=[];for(const c of i){const d=a[c],p=r.data[c];l.push({key:{status:"valid",value:c},value:d._parse(new ee(r,p,r.path,c)),alwaysSet:c in r.data})}if(this._def.catchall instanceof oe){const c=this._def.unknownKeys;if(c==="passthrough")for(const d of o)l.push({key:{status:"valid",value:d},value:{status:"valid",value:r.data[d]}});else if(c==="strict")o.length>0&&(v(r,{code:f.unrecognized_keys,keys:o}),s.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const d of o){const p=r.data[d];l.push({key:{status:"valid",value:d},value:c._parse(new ee(r,p,r.path,d)),alwaysSet:d in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const c=[];for(const d of l){const p=await d.key,h=await d.value;c.push({key:p,value:h,alwaysSet:d.alwaysSet})}return c}).then(c=>j.mergeObjectSync(s,c)):j.mergeObjectSync(s,l)}get shape(){return this._def.shape()}strict(e){return k.errToObj,new P({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,s)=>{var a,i;const r=((i=(a=this._def).errorMap)==null?void 0:i.call(a,t,s).message)??s.defaultError;return t.code==="unrecognized_keys"?{message:k.errToObj(e).message??r}:{message:r}}}:{}})}strip(){return new P({...this._def,unknownKeys:"strip"})}passthrough(){return new P({...this._def,unknownKeys:"passthrough"})}extend(e){return new P({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new P({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:S.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new P({...this._def,catchall:e})}pick(e){const t={};for(const s of I.objectKeys(e))e[s]&&this.shape[s]&&(t[s]=this.shape[s]);return new P({...this._def,shape:()=>t})}omit(e){const t={};for(const s of I.objectKeys(this.shape))e[s]||(t[s]=this.shape[s]);return new P({...this._def,shape:()=>t})}deepPartial(){return fe(this)}partial(e){const t={};for(const s of I.objectKeys(this.shape)){const r=this.shape[s];e&&!e[s]?t[s]=r:t[s]=r.optional()}return new P({...this._def,shape:()=>t})}required(e){const t={};for(const s of I.objectKeys(this.shape))if(e&&!e[s])t[s]=this.shape[s];else{let a=this.shape[s];for(;a instanceof ie;)a=a._def.innerType;t[s]=a}return new P({...this._def,shape:()=>t})}keyof(){return Ds(I.objectKeys(this.shape))}}P.create=(n,e)=>new P({shape:()=>n,unknownKeys:"strip",catchall:oe.create(),typeName:S.ZodObject,..._(e)});P.strictCreate=(n,e)=>new P({shape:()=>n,unknownKeys:"strict",catchall:oe.create(),typeName:S.ZodObject,..._(e)});P.lazycreate=(n,e)=>new P({shape:n,unknownKeys:"strip",catchall:oe.create(),typeName:S.ZodObject,..._(e)});class ze extends E{_parse(e){const{ctx:t}=this._processInputParams(e),s=this._def.options;function r(a){for(const o of a)if(o.result.status==="valid")return o.result;for(const o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const i=a.map(o=>new W(o.ctx.common.issues));return v(t,{code:f.invalid_union,unionErrors:i}),x}if(t.common.async)return Promise.all(s.map(async a=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(r);{let a;const i=[];for(const l of s){const c={...t,common:{...t.common,issues:[]},parent:null},d=l._parseSync({data:t.data,path:t.path,parent:c});if(d.status==="valid")return d;d.status==="dirty"&&!a&&(a={result:d,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;const o=i.map(l=>new W(l));return v(t,{code:f.invalid_union,unionErrors:o}),x}}get options(){return this._def.options}}ze.create=(n,e)=>new ze({options:n,typeName:S.ZodUnion,..._(e)});function ot(n,e){const t=ae(n),s=ae(e);if(n===e)return{valid:!0,data:n};if(t===b.object&&s===b.object){const r=I.objectKeys(e),a=I.objectKeys(n).filter(o=>r.indexOf(o)!==-1),i={...n,...e};for(const o of a){const l=ot(n[o],e[o]);if(!l.valid)return{valid:!1};i[o]=l.data}return{valid:!0,data:i}}else if(t===b.array&&s===b.array){if(n.length!==e.length)return{valid:!1};const r=[];for(let a=0;a<n.length;a++){const i=n[a],o=e[a],l=ot(i,o);if(!l.valid)return{valid:!1};r.push(l.data)}return{valid:!0,data:r}}else return t===b.date&&s===b.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class je extends E{_parse(e){const{status:t,ctx:s}=this._processInputParams(e),r=(a,i)=>{if(Jt(a)||Jt(i))return x;const o=ot(a.value,i.value);return o.valid?((Yt(a)||Yt(i))&&t.dirty(),{status:t.value,value:o.data}):(v(s,{code:f.invalid_intersection_types}),x)};return s.common.async?Promise.all([this._def.left._parseAsync({data:s.data,path:s.path,parent:s}),this._def.right._parseAsync({data:s.data,path:s.path,parent:s})]).then(([a,i])=>r(a,i)):r(this._def.left._parseSync({data:s.data,path:s.path,parent:s}),this._def.right._parseSync({data:s.data,path:s.path,parent:s}))}}je.create=(n,e,t)=>new je({left:n,right:e,typeName:S.ZodIntersection,..._(t)});class ce extends E{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==b.array)return v(s,{code:f.invalid_type,expected:b.array,received:s.parsedType}),x;if(s.data.length<this._def.items.length)return v(s,{code:f.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),x;!this._def.rest&&s.data.length>this._def.items.length&&(v(s,{code:f.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const a=[...s.data].map((i,o)=>{const l=this._def.items[o]||this._def.rest;return l?l._parse(new ee(s,i,s.path,o)):null}).filter(i=>!!i);return s.common.async?Promise.all(a).then(i=>j.mergeArray(t,i)):j.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new ce({...this._def,rest:e})}}ce.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new ce({items:n,typeName:S.ZodTuple,rest:null,..._(e)})};class qe extends E{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==b.object)return v(s,{code:f.invalid_type,expected:b.object,received:s.parsedType}),x;const r=[],a=this._def.keyType,i=this._def.valueType;for(const o in s.data)r.push({key:a._parse(new ee(s,o,s.path,o)),value:i._parse(new ee(s,s.data[o],s.path,o)),alwaysSet:o in s.data});return s.common.async?j.mergeObjectAsync(t,r):j.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,s){return t instanceof E?new qe({keyType:e,valueType:t,typeName:S.ZodRecord,..._(s)}):new qe({keyType:se.create(),valueType:e,typeName:S.ZodRecord,..._(t)})}}class is extends E{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==b.map)return v(s,{code:f.invalid_type,expected:b.map,received:s.parsedType}),x;const r=this._def.keyType,a=this._def.valueType,i=[...s.data.entries()].map(([o,l],c)=>({key:r._parse(new ee(s,o,s.path,[c,"key"])),value:a._parse(new ee(s,l,s.path,[c,"value"]))}));if(s.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const l of i){const c=await l.key,d=await l.value;if(c.status==="aborted"||d.status==="aborted")return x;(c.status==="dirty"||d.status==="dirty")&&t.dirty(),o.set(c.value,d.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const l of i){const c=l.key,d=l.value;if(c.status==="aborted"||d.status==="aborted")return x;(c.status==="dirty"||d.status==="dirty")&&t.dirty(),o.set(c.value,d.value)}return{status:t.value,value:o}}}}is.create=(n,e,t)=>new is({valueType:e,keyType:n,typeName:S.ZodMap,..._(t)});class Me extends E{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.parsedType!==b.set)return v(s,{code:f.invalid_type,expected:b.set,received:s.parsedType}),x;const r=this._def;r.minSize!==null&&s.data.size<r.minSize.value&&(v(s,{code:f.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),r.maxSize!==null&&s.data.size>r.maxSize.value&&(v(s,{code:f.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const a=this._def.valueType;function i(l){const c=new Set;for(const d of l){if(d.status==="aborted")return x;d.status==="dirty"&&t.dirty(),c.add(d.value)}return{status:t.value,value:c}}const o=[...s.data.values()].map((l,c)=>a._parse(new ee(s,l,s.path,c)));return s.common.async?Promise.all(o).then(l=>i(l)):i(o)}min(e,t){return new Me({...this._def,minSize:{value:e,message:k.toString(t)}})}max(e,t){return new Me({...this._def,maxSize:{value:e,message:k.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Me.create=(n,e)=>new Me({valueType:n,minSize:null,maxSize:null,typeName:S.ZodSet,..._(e)});class os extends E{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}os.create=(n,e)=>new os({getter:n,typeName:S.ZodLazy,..._(e)});class ls extends E{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return v(t,{received:t.data,code:f.invalid_literal,expected:this._def.value}),x}return{status:"valid",value:e.data}}get value(){return this._def.value}}ls.create=(n,e)=>new ls({value:n,typeName:S.ZodLiteral,..._(e)});function Ds(n,e){return new be({values:n,typeName:S.ZodEnum,..._(e)})}class be extends E{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),s=this._def.values;return v(t,{expected:I.joinValues(s),received:t.parsedType,code:f.invalid_type}),x}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),s=this._def.values;return v(t,{received:t.data,code:f.invalid_enum_value,options:s}),x}return V(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return be.create(e,{...this._def,...t})}exclude(e,t=this._def){return be.create(this.options.filter(s=>!e.includes(s)),{...this._def,...t})}}be.create=Ds;class cs extends E{_parse(e){const t=I.getValidEnumValues(this._def.values),s=this._getOrReturnCtx(e);if(s.parsedType!==b.string&&s.parsedType!==b.number){const r=I.objectValues(t);return v(s,{expected:I.joinValues(r),received:s.parsedType,code:f.invalid_type}),x}if(this._cache||(this._cache=new Set(I.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const r=I.objectValues(t);return v(s,{received:s.data,code:f.invalid_enum_value,options:r}),x}return V(e.data)}get enum(){return this._def.values}}cs.create=(n,e)=>new cs({values:n,typeName:S.ZodNativeEnum,..._(e)});class Ze extends E{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==b.promise&&t.common.async===!1)return v(t,{code:f.invalid_type,expected:b.promise,received:t.parsedType}),x;const s=t.parsedType===b.promise?t.data:Promise.resolve(t.data);return V(s.then(r=>this._def.type.parseAsync(r,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Ze.create=(n,e)=>new Ze({type:n,typeName:S.ZodPromise,..._(e)});class ke extends E{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===S.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:s}=this._processInputParams(e),r=this._def.effect||null,a={addIssue:i=>{v(s,i),i.fatal?t.abort():t.dirty()},get path(){return s.path}};if(a.addIssue=a.addIssue.bind(a),r.type==="preprocess"){const i=r.transform(s.data,a);if(s.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return x;const l=await this._def.schema._parseAsync({data:o,path:s.path,parent:s});return l.status==="aborted"?x:l.status==="dirty"||t.value==="dirty"?Ce(l.value):l});{if(t.value==="aborted")return x;const o=this._def.schema._parseSync({data:i,path:s.path,parent:s});return o.status==="aborted"?x:o.status==="dirty"||t.value==="dirty"?Ce(o.value):o}}if(r.type==="refinement"){const i=o=>{const l=r.refinement(o,a);if(s.common.async)return Promise.resolve(l);if(l instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(s.common.async===!1){const o=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});return o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(o=>o.status==="aborted"?x:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(r.type==="transform")if(s.common.async===!1){const i=this._def.schema._parseSync({data:s.data,path:s.path,parent:s});if(!ye(i))return x;const o=r.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:s.data,path:s.path,parent:s}).then(i=>ye(i)?Promise.resolve(r.transform(i.value,a)).then(o=>({status:t.value,value:o})):x);I.assertNever(r)}}ke.create=(n,e,t)=>new ke({schema:n,typeName:S.ZodEffects,effect:e,..._(t)});ke.createWithPreprocess=(n,e,t)=>new ke({schema:e,effect:{type:"preprocess",transform:n},typeName:S.ZodEffects,..._(t)});class ie extends E{_parse(e){return this._getType(e)===b.undefined?V(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ie.create=(n,e)=>new ie({innerType:n,typeName:S.ZodOptional,..._(e)});class we extends E{_parse(e){return this._getType(e)===b.null?V(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}we.create=(n,e)=>new we({innerType:n,typeName:S.ZodNullable,..._(e)});class lt extends E{_parse(e){const{ctx:t}=this._processInputParams(e);let s=t.data;return t.parsedType===b.undefined&&(s=this._def.defaultValue()),this._def.innerType._parse({data:s,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}lt.create=(n,e)=>new lt({innerType:n,typeName:S.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,..._(e)});class ct extends E{_parse(e){const{ctx:t}=this._processInputParams(e),s={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:s.data,path:s.path,parent:{...s}});return Be(r)?r.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new W(s.common.issues)},input:s.data})})):{status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new W(s.common.issues)},input:s.data})}}removeCatch(){return this._def.innerType}}ct.create=(n,e)=>new ct({innerType:n,typeName:S.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,..._(e)});class ds extends E{_parse(e){if(this._getType(e)!==b.nan){const s=this._getOrReturnCtx(e);return v(s,{code:f.invalid_type,expected:b.nan,received:s.parsedType}),x}return{status:"valid",value:e.data}}}ds.create=n=>new ds({typeName:S.ZodNaN,..._(n)});class jr extends E{_parse(e){const{ctx:t}=this._processInputParams(e),s=t.data;return this._def.type._parse({data:s,path:t.path,parent:t})}unwrap(){return this._def.type}}class xt extends E{_parse(e){const{status:t,ctx:s}=this._processInputParams(e);if(s.common.async)return(async()=>{const a=await this._def.in._parseAsync({data:s.data,path:s.path,parent:s});return a.status==="aborted"?x:a.status==="dirty"?(t.dirty(),Ce(a.value)):this._def.out._parseAsync({data:a.value,path:s.path,parent:s})})();{const r=this._def.in._parseSync({data:s.data,path:s.path,parent:s});return r.status==="aborted"?x:r.status==="dirty"?(t.dirty(),{status:"dirty",value:r.value}):this._def.out._parseSync({data:r.value,path:s.path,parent:s})}}static create(e,t){return new xt({in:e,out:t,typeName:S.ZodPipeline})}}class dt extends E{_parse(e){const t=this._def.innerType._parse(e),s=r=>(ye(r)&&(r.value=Object.freeze(r.value)),r);return Be(t)?t.then(r=>s(r)):s(t)}unwrap(){return this._def.innerType}}dt.create=(n,e)=>new dt({innerType:n,typeName:S.ZodReadonly,..._(e)});var S;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(S||(S={}));const ge=se.create,Le=ve.create,qr=it.create;oe.create;const ut=Y.create,Ie=P.create;ze.create;je.create;ce.create;const Zr=qe.create;be.create;Ze.create;ie.create;we.create;class Ur{constructor(){u(this,"tools",new Map)}register(e){if(this.tools.has(e.name))throw new Error(`工具 "${e.name}" 已注册`);this.tools.set(e.name,e)}registerAll(e){e.forEach(t=>this.register(t))}get(e){return this.tools.get(e)}has(e){return this.tools.has(e)}list(){return Array.from(this.tools.keys())}validateInput(e,t){const s=this.tools.get(e);if(!s)return{valid:!1,error:`工具 "${e}" 不存在`};try{return{valid:!0,data:s.inputSchema.parse(t)}}catch(r){return r instanceof W?{valid:!1,error:`输入校验失败: ${r.errors.map(a=>a.message).join(", ")}`}:{valid:!1,error:String(r)}}}validateOutput(e,t){const s=this.tools.get(e);if(!s)return{valid:!1,error:`工具 "${e}" 不存在`};try{return{valid:!0,data:s.outputSchema.parse(t)}}catch(r){return r instanceof W?{valid:!1,error:`输出校验失败: ${r.errors.map(a=>a.message).join(", ")}`}:{valid:!1,error:String(r)}}}checkPermission(e,t){const s=this.tools.get(e);return s?!s.permissions||s.permissions.length===0?!0:s.permissions.every(r=>t[r]===!0):!1}checkNodeAllowed(e,t){const s=this.tools.get(e);return s?!s.allowedNodes||s.allowedNodes.length===0?!0:s.allowedNodes.includes(t):!1}async execute(e,t,s){const r=this.tools.get(e);if(!r)return{success:!1,error:`工具 "${e}" 不存在`};if(s!=null&&s.nodeId&&!this.checkNodeAllowed(e,s.nodeId))return{success:!1,error:`节点 "${s.nodeId}" 不允许调用工具 "${e}"`};if(s!=null&&s.permissions&&!this.checkPermission(e,s.permissions))return{success:!1,error:`缺少必需权限: ${r.permissions.join(", ")}`};const a=this.validateInput(e,t);if(!a.valid)return{success:!1,error:a.error};try{const i=await this.executeWithTimeout(r.execute(a.data,{onStream:s==null?void 0:s.onStream}),r.timeout),o=this.validateOutput(e,i);return o.valid?{success:!0,output:o.data}:{success:!1,error:`契约错误: ${o.error}`}}catch(i){return{success:!1,error:String(i)}}}executeWithTimeout(e,t){let s;const r=new Promise((a,i)=>{s=setTimeout(()=>{i(new Error(`工具执行超时 (${t}ms)`))},t)});return Promise.race([e,r]).finally(()=>{clearTimeout(s)})}}function _t(n,e,t){return{type:n,message:e,nodeId:t==null?void 0:t.nodeId,toolName:t==null?void 0:t.toolName,retryable:(t==null?void 0:t.retryable)??Fr(n),originalError:t==null?void 0:t.originalError,timestamp:Date.now()}}function Fr(n){switch(n){case"network":case"timeout":case"execution":return!0;case"permission":case"validation":case"budget_exceeded":return!1;default:return!1}}function Vr(n,e,t){return n.type==="budget_exceeded"?{shouldRetry:!1,shouldDegrade:!1,shouldRollback:!1,shouldTerminate:!0,suggestion:"已达到预算限制，请检查配置或优化工具调用"}:n.type==="permission"?{shouldRetry:!1,shouldDegrade:!1,shouldRollback:!1,shouldTerminate:!0,suggestion:"权限不足，请检查工具权限配置"}:n.type==="validation"?{shouldRetry:!1,shouldDegrade:!0,shouldRollback:!1,shouldTerminate:!n.retryable,suggestion:"输入或输出校验失败，请检查工具契约"}:n.retryable&&e<t?{shouldRetry:!0,shouldDegrade:!1,shouldRollback:!1,shouldTerminate:!1,suggestion:`将在 ${Ps(e)}ms 后重试 (${e+1}/${t})`}:e>=t?{shouldRetry:!1,shouldDegrade:!0,shouldRollback:!1,shouldTerminate:!1,suggestion:"重试次数已耗尽，尝试降级策略"}:{shouldRetry:!1,shouldDegrade:!1,shouldRollback:!1,shouldTerminate:!0,suggestion:"无法恢复的错误"}}function Ps(n,e=1e3,t=2){return e*Math.pow(t,n)}class ue{constructor(e,t){this.id=e,this.name=t}createResult(e,t=[]){return{state:e,events:t}}}class Hr{constructor(e){this.deps=e}async run(e,t){var i,o,l,c;await((o=(i=this.deps.hooks)==null?void 0:i.onNodeStart)==null?void 0:o.call(i,e.id,t)),this.deps.eventStream.emit("node_start","info",`开始执行节点: ${e.name}`,{nodeId:e.id,metadata:{nodeName:e.name}});let s=0,r;const a={emitEvent:(d,p,h,m)=>{this.deps.eventStream.emit(d,p,h,{nodeId:e.id,payload:m})}};for(;s<=t.policy.maxRetries;){const d=Date.now();try{const p=await e.execute(t,a),h=Date.now()-d;return p.state=U.recordNodeTiming(p.state,e.id,h),await((c=(l=this.deps.hooks)==null?void 0:l.onNodeEnd)==null?void 0:c.call(l,e.id,p)),this.deps.eventStream.emit("node_end","success",`完成节点: ${e.name}`,{nodeId:e.id,metadata:{nodeName:e.name,durationMs:h}}),p}catch(p){r=p instanceof Error?p:new Error(String(p));const h=Date.now()-d,m=_t(We.EXECUTION,r.message,{nodeId:e.id,retryable:!0,originalError:r}),g=Vr(m,s,t.policy.maxRetries);if(g.shouldRetry){s++;const y=Ps(s-1);this.deps.eventStream.emit("retry","warning",g.suggestion||"重试中...",{nodeId:e.id,metadata:{retryCount:s,delay:y}}),t=U.incrementRetry(t),await new Promise(w=>setTimeout(w,y))}else throw t=U.incrementError(t),this.deps.eventStream.emit("node_end","failure",`节点执行失败: ${e.name}`,{nodeId:e.id,metadata:{nodeName:e.name,error:r.message,attemptedRetries:s,durationMs:h}}),r}}throw r}}function Gr(n,e,t,s){if(s)return s;const r=n.edges.filter(a=>a.from===e);for(const a of r)if(a.condition){if(a.condition(t))return a.to}else return a.to;return null}class Wr{constructor(e,t,s){this.persistence=e,this.eventStream=t,this.hooks=s}async save(e){var s,r;if(!this.persistence)return;const t={id:`checkpoint-${Date.now()}`,stateId:e.id,state:e,eventIndex:this.eventStream.getEvents().length,timestamp:Date.now()};await this.persistence.saveCheckpoint(t),this.eventStream.emit("checkpoint","success",`已保存 checkpoint ${t.id}`,{metadata:{checkpointId:t.id}}),await((r=(s=this.hooks)==null?void 0:s.onCheckpoint)==null?void 0:r.call(s,t))}async load(e){if(!this.persistence)throw new Error("未配置持久化适配器，无法恢复");const t=await this.persistence.loadCheckpoint(e);if(!t)throw new Error(`Checkpoint "${e}" 不存在`);return t}}class Kr{constructor(e,t,s,r){u(this,"eventStream");u(this,"checkpointInterval");u(this,"nodeExecutor");u(this,"checkpointManager");this.graph=e,this.persistence=t,this.hooks=s,this.eventStream=new pr,this.checkpointInterval=(r==null?void 0:r.checkpointInterval)??1,this.nodeExecutor=new Hr({eventStream:this.eventStream,hooks:this.hooks}),this.checkpointManager=new Wr(this.persistence,this.eventStream,this.hooks)}async execute(e){var i,o,l,c;let t=e,s=this.graph.entryNode,r=0;const a=Date.now();try{for(;s&&r<this.graph.maxSteps;){const p=U.checkBudget(t);if(p.exceeded){this.eventStream.emit("budget_exceeded","failure",p.reason),await((o=(i=this.hooks)==null?void 0:i.onBudgetWarning)==null?void 0:o.call(i,"budget",0,0));break}const h=this.graph.nodes.find(y=>y.id===s);if(!h)throw new Error(`节点 "${s}" 不存在`);t=U.setCurrentNode(t,s);const m=await this.nodeExecutor.run(h,t);t=m.state,m.events.forEach(y=>{this.eventStream.emit(y.type,y.status,y.summary,{nodeId:y.nodeId,payload:y.payloadRef?this.eventStream.getPayload(y.payloadRef):void 0,metadata:y.metadata})}),r%this.checkpointInterval===0&&await this.checkpointManager.save(t);const g=Gr(this.graph,s,t,m.nextNode);if(!g)break;s=g,r++}r>=this.graph.maxSteps&&this.eventStream.emit("budget_exceeded","warning",`已达到最大步数限制 (${this.graph.maxSteps})`);const d=Date.now()-a;return this.eventStream.emit("health_metrics","info","Execution health metrics",{metadata:{totalDurationMs:d,tokenCount:t.telemetry.tokenCount,toolCallCount:t.telemetry.toolCallCount,errorCount:t.telemetry.errorCount}}),{state:t,events:this.eventStream}}catch(d){const p=_t(We.EXECUTION,String(d),{originalError:d instanceof Error?d:void 0});throw this.eventStream.emit("error","failure",p.message,{payload:p}),await((c=(l=this.hooks)==null?void 0:l.onError)==null?void 0:c.call(l,p)),d}}async resume(e){const t=await this.checkpointManager.load(e);return this.eventStream.emit("checkpoint","info",`从 checkpoint ${e} 恢复`),this.execute(t.state)}getEventStream(){return this.eventStream}getGraphDefinition(){return this.graph}}class Tt{constructor(e){u(this,"config");this.config={temperature:.7,timeout:6e4,...e}}getModel(){return this.config.model}async complete(e,t){const s=[];return t&&s.push({role:"system",content:t}),s.push({role:"user",content:e}),(await this.chat({messages:s})).content}buildMessages(e){return e.messages}mergeConfig(e){return{temperature:e.temperature??this.config.temperature??.7}}}class N extends Error{constructor(e,t,s,r){super(e),this.provider=t,this.originalError=s,this.statusCode=r,this.name="LLMProviderError"}}class Qr extends Tt{constructor(t){super(t);u(this,"apiKey");u(this,"baseURL");this.apiKey=t.apiKey,this.baseURL=t.baseURL||"https://api.openai.com"}getProviderName(){return"OpenAI"}async chat(t){var a,i;const{temperature:s}=this.mergeConfig(t),r={model:this.config.model,messages:t.messages,temperature:s,...t.topP&&{top_p:t.topP},...t.stopSequences&&{stop:t.stopSequences}};try{const o=AbortSignal.timeout(this.config.timeout||6e4),l=new AbortController,c=()=>l.abort();(a=t.signal)==null||a.addEventListener("abort",c),o.addEventListener("abort",c);const d=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(r),signal:l.signal});if((i=t.signal)==null||i.removeEventListener("abort",c),!d.ok){const h=await d.text();throw new N(`OpenAI API error: ${d.statusText}`,"OpenAI",void 0,d.status)}const p=await d.json();return{content:p.choices[0].message.content,finishReason:this.mapFinishReason(p.choices[0].finish_reason),usage:p.usage?{promptTokens:p.usage.prompt_tokens,completionTokens:p.usage.completion_tokens,totalTokens:p.usage.total_tokens}:void 0,model:p.model}}catch(o){throw o instanceof N?o:new N(`Failed to call OpenAI: ${o instanceof Error?o.message:String(o)}`,"OpenAI",o instanceof Error?o:void 0)}}async*chatStream(t){var a,i,o,l;const{temperature:s}=this.mergeConfig(t),r={model:this.config.model,messages:t.messages,temperature:s,stream:!0,stream_options:{include_usage:!0},...t.topP&&{top_p:t.topP},...t.stopSequences&&{stop:t.stopSequences}};try{const c=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(r),signal:t.signal});if(!c.ok)throw new N(`OpenAI API error: ${c.statusText}`,"OpenAI",void 0,c.status);const d=(a=c.body)==null?void 0:a.getReader();if(!d)throw new Error("No response body");const p=new TextDecoder;let h="";for(;;){const{done:m,value:g}=await d.read();if(m)break;h+=p.decode(g,{stream:!0});const y=h.split(`
`);h=y.pop()||"";for(const w of y)if(w.startsWith("data: ")){const R=w.slice(6);if(R==="[DONE]")continue;try{const $=JSON.parse(R),D=(o=(i=$.choices[0])==null?void 0:i.delta)==null?void 0:o.content,q=(l=$.choices[0])==null?void 0:l.finish_reason;D&&(yield{delta:D}),q&&(yield{delta:"",finishReason:this.mapFinishReason(q)}),$.usage&&(yield{delta:"",usage:{promptTokens:$.usage.prompt_tokens,completionTokens:$.usage.completion_tokens,totalTokens:$.usage.total_tokens}})}catch{}}}}catch(c){throw c instanceof N?c:new N(`Failed to stream from OpenAI: ${c instanceof Error?c.message:String(c)}`,"OpenAI",c instanceof Error?c:void 0)}}mapFinishReason(t){switch(t){case"stop":return"stop";case"length":return"length";case"content_filter":return"content_filter";case"tool_calls":return"tool_calls";default:return"stop"}}}class Jr extends Tt{constructor(t){super(t);u(this,"apiKey");this.apiKey=t.apiKey}getProviderName(){return"Gemini"}async chat(t){var i,o,l,c,d,p,h;const{temperature:s}=this.mergeConfig(t),a={contents:this.convertMessages(t.messages),generationConfig:{temperature:s,...t.topP&&{topP:t.topP},...t.stopSequences&&{stopSequences:t.stopSequences}}};try{const m=AbortSignal.timeout(this.config.timeout||6e4),g=new AbortController,y=()=>g.abort();(i=t.signal)==null||i.addEventListener("abort",y),m.addEventListener("abort",y);const w=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.config.model}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:g.signal});if((o=t.signal)==null||o.removeEventListener("abort",y),!w.ok){const $=await w.text();throw new N(`Gemini API error: ${w.statusText}`,"Gemini",void 0,w.status)}const R=await w.json();if(!((h=(p=(d=(c=(l=R.candidates)==null?void 0:l[0])==null?void 0:c.content)==null?void 0:d.parts)==null?void 0:p[0])!=null&&h.text))throw new N("Invalid Gemini response format","Gemini");return{content:R.candidates[0].content.parts[0].text,finishReason:this.mapFinishReason(R.candidates[0].finishReason),usage:R.usageMetadata?{promptTokens:R.usageMetadata.promptTokenCount||0,completionTokens:R.usageMetadata.candidatesTokenCount||0,totalTokens:R.usageMetadata.totalTokenCount||0}:void 0,model:this.config.model}}catch(m){throw m instanceof N?m:new N(`Failed to call Gemini: ${m instanceof Error?m.message:String(m)}`,"Gemini",m instanceof Error?m:void 0)}}async*chatStream(t){var i,o,l,c,d,p,h,m;const{temperature:s}=this.mergeConfig(t),a={contents:this.convertMessages(t.messages),generationConfig:{temperature:s,...t.topP&&{topP:t.topP},...t.stopSequences&&{stopSequences:t.stopSequences}}};try{const g=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.config.model}:streamGenerateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:t.signal});if(!g.ok)throw new N(`Gemini API error: ${g.statusText}`,"Gemini",void 0,g.status);const y=(i=g.body)==null?void 0:i.getReader();if(!y)throw new Error("No response body");const w=new TextDecoder;let R="";for(;;){const{done:$,value:D}=await y.read();if($)break;R+=w.decode(D,{stream:!0});const q=R.split(`
`);R=q.pop()||"";for(const K of q)if(K.trim())try{const B=JSON.parse(K),Z=(p=(d=(c=(l=(o=B.candidates)==null?void 0:o[0])==null?void 0:l.content)==null?void 0:c.parts)==null?void 0:d[0])==null?void 0:p.text,re=(m=(h=B.candidates)==null?void 0:h[0])==null?void 0:m.finishReason;Z&&(yield{delta:Z}),re&&(yield{delta:"",finishReason:this.mapFinishReason(re)})}catch{}}}catch(g){throw g instanceof N?g:new N(`Failed to stream from Gemini: ${g instanceof Error?g.message:String(g)}`,"Gemini",g instanceof Error?g:void 0)}}convertMessages(t){const s=[];for(const r of t)r.role==="system"?(s.push({role:"user",parts:[{text:`System: ${r.content}`}]}),s.push({role:"model",parts:[{text:"Understood. I will follow these instructions."}]})):r.role==="user"?s.push({role:"user",parts:[{text:r.content}]}):r.role==="assistant"&&s.push({role:"model",parts:[{text:r.content}]});return s}mapFinishReason(t){switch(t){case"STOP":return"stop";case"MAX_TOKENS":return"length";case"SAFETY":return"content_filter";default:return"stop"}}}class Yr extends Tt{constructor(t){super(t);u(this,"baseURL");this.baseURL=t.baseURL}getProviderName(){return"LM Studio"}async chat(t){var a,i;const{temperature:s}=this.mergeConfig(t),r={model:this.config.model,messages:t.messages,temperature:s,...t.topP&&{top_p:t.topP},...t.stopSequences&&{stop:t.stopSequences}};try{const o=AbortSignal.timeout(this.config.timeout||6e4),l=new AbortController,c=()=>l.abort();(a=t.signal)==null||a.addEventListener("abort",c),o.addEventListener("abort",c);const d=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:l.signal});if((i=t.signal)==null||i.removeEventListener("abort",c),!d.ok){const h=await d.text();throw new N(`LM Studio API error: ${d.statusText}`,"LM Studio",void 0,d.status)}const p=await d.json();return{content:p.choices[0].message.content,finishReason:this.mapFinishReason(p.choices[0].finish_reason),usage:p.usage?{promptTokens:p.usage.prompt_tokens,completionTokens:p.usage.completion_tokens,totalTokens:p.usage.total_tokens}:void 0,model:p.model}}catch(o){throw o instanceof N?o:new N(`Failed to call LM Studio: ${o instanceof Error?o.message:String(o)}`,"LM Studio",o instanceof Error?o:void 0)}}async*chatStream(t){var a,i,o,l,c,d,p;const{temperature:s}=this.mergeConfig(t),r={model:this.config.model,messages:t.messages,temperature:s,stream:!0,stream_options:{include_usage:!0},...t.topP&&{top_p:t.topP},...t.stopSequences&&{stop:t.stopSequences}};try{const h=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r),signal:t.signal});if(!h.ok)throw new N(`LM Studio API error: ${h.statusText}`,"LM Studio",void 0,h.status);const m=(a=h.body)==null?void 0:a.getReader();if(!m)throw new Error("No response body");const g=new TextDecoder;let y="",w=!1;for(;;){if((i=t.signal)!=null&&i.aborted){await m.cancel();break}const{done:R,value:$}=await m.read();if(R)break;y+=g.decode($,{stream:!0});const D=y.split(`
`);y=D.pop()||"";for(const q of D)if(q.startsWith("data: ")){const K=q.slice(6);if(K==="[DONE]")continue;try{const B=JSON.parse(K),Z=(l=(o=B.choices[0])==null?void 0:o.delta)==null?void 0:l.content,re=(d=(c=B.choices[0])==null?void 0:c.delta)==null?void 0:d.reasoning_content,Se=(p=B.choices[0])==null?void 0:p.finish_reason;if(re){const me=w?"":"<think>";w=!0,yield{delta:`${me}${re}`}}if(Z){const me=w?"</think>":"";w=!1,yield{delta:`${me}${Z}`}}Se&&(w&&(w=!1,yield{delta:"</think>"}),yield{delta:"",finishReason:this.mapFinishReason(Se)}),B.usage&&(yield{delta:"",usage:{promptTokens:B.usage.prompt_tokens,completionTokens:B.usage.completion_tokens,totalTokens:B.usage.total_tokens}})}catch{}}}w&&(yield{delta:"</think>"})}catch(h){throw h instanceof N?h:new N(`Failed to stream from LM Studio: ${h instanceof Error?h.message:String(h)}`,"LM Studio",h instanceof Error?h:void 0)}}mapFinishReason(t){switch(t){case"stop":return"stop";case"length":return"length";case"content_filter":return"content_filter";default:return"stop"}}}function Oe(n){switch(n.type){case"openai":return new Qr({apiKey:n.apiKey,model:n.model,baseURL:n.baseURL,temperature:n.temperature,timeout:n.timeout});case"gemini":return new Jr({apiKey:n.apiKey,model:n.model,temperature:n.temperature,timeout:n.timeout});case"lm-studio":return new Yr({baseURL:n.baseURL,model:n.model,temperature:n.temperature,timeout:n.timeout});default:throw new Error(`Unknown provider type: ${n.type}`)}}function Xr(n){switch(n.provider){case"openai":return Oe({type:"openai",apiKey:n.openai.apiKey,model:n.openai.model,baseURL:n.openai.baseURL});case"gemini":return Oe({type:"gemini",apiKey:n.gemini.apiKey,model:n.gemini.model});case"lm-studio":return Oe({type:"lm-studio",baseURL:n.lmStudio.baseURL,model:n.lmStudio.model});default:throw new Error(`Unknown provider: ${n.provider}`)}}class en extends ue{constructor(t,s){super("planner","LLM Planner");u(this,"provider");this.toolRegistry=t,this.provider=s==null?void 0:s.provider}setProvider(t){this.provider=t}async execute(t,s){const r=[];try{const{content:a,usage:i}=await this.generatePlanWithLLM(t,t.task.goal,s),o=this.parseSteps(a);let l=O(t,c=>{c.task.plan=a,c.task.steps=o,c.task.progress=10});return i&&(l=U.addTokenUsage(l,{prompt:i.promptTokens,completion:i.completionTokens,total:i.totalTokens})),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:`LLM 生成了 ${o.length} 个子任务 (Tokens: ${(i==null?void 0:i.totalTokens)||"unknown"})`,metadata:{stepCount:o.length,usage:i}}),this.createResult(l,r)}catch(a){throw r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"failure",summary:`规划失败: ${a}`}),a}}async generatePlanWithLLM(t,s,r){const a=`你是一个任务规划助手。用户会给你一个目标，你需要将其拆解为清晰的步骤。

要求：
1. 每个步骤一行，格式为 "1. 步骤描述"
2. 步骤要具体、可执行
3. 步骤数量控制在 3-6 个
4. 只输出步骤列表，不要其他内容

示例：
用户目标：优化这段 SQL 并保持结果一致
你的输出：
1. 分析当前 SQL 语句结构
2. 识别性能瓶颈和优化点
3. 生成优化后的 SQL 语句
4. 验证优化前后结果一致性`,i=`用户目标：${s}

请生成任务步骤：`;return this.provider?this.callWithProvider(a,i,t,r):this.callWithToolRegistry(a,i,t,r)}async callWithProvider(t,s,r,a){const i=[{role:"system",content:t},{role:"user",content:s}];if(r.policy.useStreaming!==!1&&(a!=null&&a.emitEvent)){let l="";const c=this.provider.chatStream({messages:i,temperature:.3});for await(const d of c)d.delta&&(l+=d.delta,a.emitEvent("stream_chunk","info","generating plan...",{chunk:d.delta}));return console.log("[LLMPlanner] LLM Raw Output:",l),{content:l.trim(),usage:void 0}}else{const l=await this.provider.chat({messages:i,temperature:.3});return console.log("[LLMPlanner] LLM Raw Output:",l.content),{content:l.content.trim(),usage:l.usage}}}async callWithToolRegistry(t,s,r,a){const i=r.policy.useStreaming!==!1,o=await this.toolRegistry.execute("lm-studio-llm",{prompt:s,systemPrompt:t,temperature:.3,onStream:i?c=>{a==null||a.emitEvent("stream_chunk","info","generating plan...",{chunk:c})}:void 0});if(!o.success||!o.output)throw console.error("[LLMPlanner] ❌ LLM 调用失败"),new Error("LLM 调用失败");const l=o.output;return console.log("[LLMPlanner] LLM Raw Output:",l.content),{content:l.content.trim(),usage:l.usage}}parseSteps(t){return t.split(`
`).filter(r=>r.trim()).map((r,a)=>({id:`step-${a+1}`,description:r.replace(/^\d+\.\s*/,""),status:"pending"}))}}function tn(n){var e,t;if(!n||!n._def)return{};try{const s=(t=(e=n._def).shape)==null?void 0:t.call(e);if(!s)return{};const r={};for(const[a,i]of Object.entries(s)){const o=i==null?void 0:i._def;o&&(r[a]={type:rn(o.typeName),description:o.description||a})}return r}catch{return{}}}function sn(n){var e,t;if(!n||!n._def)return[];try{const s=(t=(e=n._def).shape)==null?void 0:t.call(e);if(!s)return[];const r=[];for(const[a,i]of Object.entries(s)){const o=i==null?void 0:i._def;o&&o.typeName!=="ZodOptional"&&r.push(a)}return r}catch{return[]}}function rn(n){return{ZodString:"string",ZodNumber:"number",ZodBoolean:"boolean",ZodArray:"array",ZodObject:"object"}[n]||"string"}function Os(n,e=["lm-studio-llm"]){return n.list().filter(t=>!e.includes(t)).map(t=>{const s=n.get(t);return{type:"function",function:{name:t,description:s.description,parameters:{type:"object",properties:tn(s.inputSchema),required:sn(s.inputSchema)}}}})}async function nn(n,e,t={}){if(t.provider)return an(n,e,t.provider);const s=t.providerConfig;return s!=null&&s.baseURL?us(n,e,s.baseURL,s.model||"default-model"):us(n,e,"http://127.0.0.1:6354","zai-org/glm-4.6v-flash")}async function an(n,e,t){const s=Os(n);if(s.length===0)return{call:null,usage:void 0};const r=[{role:"system",content:`You are an assistant. Available tools:
${s.map(a=>`- ${a.function.name}: ${a.function.description}`).join(`
`)}

Respond with JSON: {"tool": "name", "input": {}} or {"tool": null}`},{role:"user",content:`Task: ${e}`}];try{const a=await t.chat({messages:r,temperature:.1}),i=on(a.content);return i!=null&&i.tool&&n.has(i.tool)?{call:{toolName:i.tool,input:i.input||{}},usage:a.usage}:{call:null,usage:a.usage}}catch(a){return console.error("[ToolRunner] Provider error:",a),{call:ht(e),usage:void 0}}}async function us(n,e,t,s){var a,i,o;const r=Os(n);if(r.length===0)return{call:null,usage:void 0};try{const l=await fetch(`${t}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:s,messages:[{role:"system",content:"Select appropriate tool if needed."},{role:"user",content:`Task: ${e}`}],tools:r,temperature:.1})});if(!l.ok)return{call:ht(e),usage:void 0};const c=await l.json(),d=(o=(i=(a=c.choices)==null?void 0:a[0])==null?void 0:i.message)==null?void 0:o.tool_calls;if(d!=null&&d[0]){const{name:p,arguments:h}=d[0].function;if(n.has(p))return{call:{toolName:p,input:JSON.parse(h)},usage:c.usage}}return{call:null,usage:c.usage}}catch{return{call:ht(e),usage:void 0}}}function on(n){try{const e=n.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0])}catch{}return null}function ht(n){const e=n.toLowerCase();return e.includes("sql")||e.includes("查询")?{toolName:"sql-query",input:{query:"SELECT * FROM users LIMIT 10"}}:e.includes("文档")||e.includes("搜索")?{toolName:"document-search",input:{keywords:["优化"]}}:null}class ln extends ue{constructor(t,s){super("tool-runner","ToolRunner");u(this,"provider");this.toolRegistry=t,this.provider=s==null?void 0:s.provider}setProvider(t){this.provider=t}async execute(t,s){const r=[];let a=t;const i=t.task.steps[t.task.currentStepIndex];if(!i)throw new Error("没有可执行的步骤");a=O(a,o=>{const l=o.task.steps[o.task.currentStepIndex];l&&(l.status="running")});try{const o=a.task.pendingToolCall;if(o)if(o.stepId!==i.id)a=O(a,p=>{delete p.task.pendingToolCall});else{if(o.status==="pending")return this.createResult(a,r);if(o.status==="approved")return await this.executeToolCall(a,i,o,s,r);if(o.status==="denied")return a=this.handleDeniedToolCall(a,o),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"tool_result",nodeId:this.id,status:"warning",summary:`工具 ${o.toolName} 已被拒绝`,metadata:{toolName:o.toolName,stepId:o.stepId,reason:o.decisionReason,success:!1}}),this.createResult(a,r)}const{call:l,usage:c}=await nn(this.toolRegistry,i.description,{provider:this.provider,providerConfig:t.artifacts.providerConfig});if(c&&(a=U.addTokenUsage(a,{prompt:c.promptTokens,completion:c.completionTokens,total:c.totalTokens})),!l)return a=O(a,p=>{p.task.steps[p.task.currentStepIndex].status="completed",p.task.steps[p.task.currentStepIndex].result="已完成",delete p.task.pendingToolCall}),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"info",summary:`步骤 "${i.description}" 无需工具调用`}),this.createResult(a,r);if(a.policy.allowedTools&&a.policy.allowedTools.length>0&&!a.policy.allowedTools.includes(l.toolName))return a=O(a,p=>{const h=p.task.steps[p.task.currentStepIndex];h&&(h.status="failed",h.error=`Tool "${l.toolName}" is not allowed by policy.`),delete p.task.pendingToolCall}),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"tool_result",nodeId:this.id,status:"warning",summary:`工具 ${l.toolName} 被策略禁止`,metadata:{toolName:l.toolName,stepId:i.id,success:!1,reason:"policy"}}),s==null||s.emitEvent("audit","warning","tool_policy_block",{toolName:l.toolName,stepId:i.id,reason:"policy"}),this.createResult(a,r);const d=this.toolRegistry.get(l.toolName);if(d&&d.requiresConfirmation){const p=this.buildPendingToolCall(l.toolName,l.input,i,d);return a=O(a,h=>{h.task.pendingToolCall=p}),this.createResult(a,r)}return await this.executeToolCall(a,i,l,s,r)}catch(o){throw a=U.incrementError(a),a=O(a,l=>{const c=l.task.steps[l.task.currentStepIndex];c&&(c.status="failed",c.error=String(o)),delete l.task.pendingToolCall}),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"failure",summary:`工具执行失败: ${o}`}),o}}buildPendingToolCall(t,s,r,a){return{toolName:t,input:s,stepId:r.id,stepDescription:r.description,permissions:a.permissions||[],confirmationMessage:a.confirmationMessage,requestedAt:Date.now(),status:"pending"}}handleDeniedToolCall(t,s){return O(t,r=>{const a=r.task.steps[r.task.currentStepIndex];a&&(a.status="failed",a.error=s.decisionReason||"Tool execution denied"),delete r.task.pendingToolCall})}async executeToolCall(t,s,r,a,i){i.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"tool_call",nodeId:this.id,status:"info",summary:`调用工具: ${r.toolName}`,metadata:{toolName:r.toolName,stepId:s.id,input:r.input}}),a==null||a.emitEvent("audit","info","tool_call",{toolName:r.toolName,stepId:s.id});const l=t.policy.useStreaming!==!1&&(a!=null&&a.emitEvent)?h=>{const m=cn(h);a.emitEvent("stream_chunk","info",`tool stream: ${r.toolName}`,{toolName:r.toolName,stepId:s.id,chunk:m.content,raw:m.raw,chunkType:m.type})}:void 0,c=Date.now(),d=await this.toolRegistry.execute(r.toolName,r.input,{nodeId:this.id,permissions:t.policy.permissions,onStream:l}),p=Date.now()-c;if(!d.success)throw a==null||a.emitEvent("audit","failure","tool_result",{toolName:r.toolName,stepId:s.id,success:!1,error:d.error}),i.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"tool_result",nodeId:this.id,status:"failure",summary:`工具 ${r.toolName} 执行失败`,metadata:{toolName:r.toolName,stepId:s.id,success:!1,error:d.error}}),_t(We.EXECUTION,d.error||"工具执行失败",{nodeId:this.id,toolName:r.toolName});return t=U.incrementToolCall(t),t=U.recordNodeTiming(t,this.id,p),t=O(t,h=>{const m=h.task.steps[h.task.currentStepIndex];m&&(m.status="completed",m.result=d.output),delete h.task.pendingToolCall,h.artifacts.toolResults||(h.artifacts.toolResults=[]),h.artifacts.toolResults.push({stepId:s.id,toolName:r.toolName,output:d.output,timestamp:Date.now()})}),i.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"tool_result",nodeId:this.id,status:"success",summary:`工具 ${r.toolName} 执行成功 (${p}ms)`,metadata:{durationMs:p,toolName:r.toolName,stepId:s.id,success:!0}}),a==null||a.emitEvent("audit","success","tool_result",{toolName:r.toolName,stepId:s.id,success:!0,durationMs:p}),this.createResult(t,i)}}function cn(n){return typeof n=="string"?{content:n,type:"text"}:{content:n.content,type:n.type,raw:n.data}}class dn extends ue{constructor(t){super("confirmation","Confirmation");u(this,"onConfirm");u(this,"autoApprove");this.onConfirm=t==null?void 0:t.onConfirm,this.autoApprove=(t==null?void 0:t.autoApprove)??!0}setConfirmationHandler(t){this.onConfirm=t}async execute(t,s){const r=[],a=t.task.pendingToolCall;if(!a||a.status!=="pending")return r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"info",summary:"没有需要确认的工具调用"}),this.createResult(t,r);const i={toolName:a.toolName,input:a.input,stepId:a.stepId,stepDescription:a.stepDescription,permissions:a.permissions,confirmationMessage:a.confirmationMessage,requestedAt:a.requestedAt};s==null||s.emitEvent("confirmation_required","warning",`等待工具确认: ${a.toolName}`,i);const o=await this.resolveDecision(i),l=O(t,c=>{c.task.pendingToolCall&&(c.task.pendingToolCall.status=o.approved?"approved":"denied",c.task.pendingToolCall.decidedAt=Date.now(),o.reason&&(c.task.pendingToolCall.decisionReason=o.reason))});return r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"confirmation_result",nodeId:this.id,status:o.approved?"success":"warning",summary:o.approved?`已批准工具: ${a.toolName}`:`已拒绝工具: ${a.toolName}`,metadata:{toolName:a.toolName,approved:o.approved,reason:o.reason}}),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:o.approved?"success":"warning",summary:o.approved?"工具已批准":"工具已拒绝"}),this.createResult(l,r)}async resolveDecision(t){if(this.onConfirm){const s=await this.onConfirm(t);return typeof s=="boolean"?{approved:s}:s}return this.autoApprove?{approved:!0,reason:"auto-approved"}:{approved:!1,reason:"no confirmation handler"}}}class un extends ue{constructor(){super("verifier","Verifier")}async execute(e){const t=[];try{const s=e.task.steps[e.task.currentStepIndex];if(!s)throw new Error("没有可验证的步骤");if(s.status==="failed"){const c=Math.min(e.task.currentStepIndex+1,e.task.steps.length),d=e.task.steps.length||1,p=c/d*80+10,h=O(e,m=>{m.task.currentStepIndex=c,m.task.progress=Math.round(p)});return t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"warning",summary:`步骤 "${s.description}" 已失败，跳过到下一步`}),this.createResult(h,t)}if(!this.verify(s.result))return t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"warning",summary:`步骤 "${s.description}" 验证失败`}),this.createResult(e,t);const a=Math.min(e.task.currentStepIndex+1,e.task.steps.length),i=e.task.steps.length||1,o=a/i*80+10,l=O(e,c=>{c.task.currentStepIndex=a,c.task.progress=Math.round(o)});return t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:`步骤验证通过 (进度: ${Math.round(o)}%)`}),this.createResult(l,t)}catch(s){throw t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"failure",summary:`验证失败: ${s}`}),s}}verify(e){return!(e==null||Array.isArray(e)&&e.length===0||typeof e=="object"&&Object.keys(e).length===0)}}class hn extends ue{constructor(){super("responder","Responder")}async execute(e){const t=[];try{const s=this.summarizeResults(e),r=this.generateResponse(e,s);let a=U.addMessage(e,"assistant",r);return a=U.updateProgress(a,100),t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:"已生成最终答复",metadata:{responseLength:r.length}}),this.createResult(a,t)}catch(s){throw t.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"failure",summary:`生成答复失败: ${s}`}),s}}summarizeResults(e){const t=e.task.steps.filter(a=>a.status==="completed"),s=e.task.steps.filter(a=>a.status==="failed");let r=`## 任务执行摘要

`;return r+=`**目标**: ${e.task.goal}

`,r+=`**完成步骤**: ${t.length}/${e.task.steps.length}

`,t.length>0&&(r+=`### 已完成步骤
`,t.forEach(a=>{r+=`- ${a.description}
`}),r+=`
`),s.length>0&&(r+=`### 失败步骤
`,s.forEach(a=>{r+=`- ${a.description}: ${a.error}
`}),r+=`
`),r}generateResponse(e,t){let s=t;const r=e.artifacts.toolResults;return r&&r.length>0&&(s+=`### 工具执行结果

`,r.forEach(a=>{s+=`**${a.toolName}**:
`,s+=`\`\`\`json
${JSON.stringify(a.output,null,2)}
\`\`\`

`})),s+=`### 性能统计
`,s+=`- 总耗时: ${e.telemetry.totalDuration}ms
`,s+=`- 工具调用次数: ${e.telemetry.toolCallCount}
`,s+=`- 错误次数: ${e.telemetry.errorCount}
`,s+=`- 重试次数: ${e.telemetry.retryCount}
`,s}}class mn extends ue{constructor(t){super("responder","LLM Responder");u(this,"provider");u(this,"includeStats");u(this,"language");this.provider=t==null?void 0:t.provider,this.includeStats=(t==null?void 0:t.includeStats)??!1,this.language=(t==null?void 0:t.language)??"auto"}setProvider(t){this.provider=t}async execute(t,s){const r=[];try{const a=this.buildExecutionContext(t),i=this.provider?await this.generateWithLLM(t,a,s):this.generateTemplateResponse(t,a);let o=U.addMessage(t,"assistant",i);return o=U.updateProgress(o,100),r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:"已生成最终答复",metadata:{responseLength:i.length,usedLLM:!!this.provider}}),this.createResult(o,r)}catch(a){throw r.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"failure",summary:`生成答复失败: ${a}`}),a}}buildExecutionContext(t){const s=t.task.steps.filter(i=>i.status==="completed"),r=t.task.steps.filter(i=>i.status==="failed"),a=t.artifacts.toolResults;return{goal:t.task.goal,totalSteps:t.task.steps.length,completedSteps:s.map(i=>({description:i.description,result:i.result})),failedSteps:r.map(i=>({description:i.description,error:i.error})),toolResults:a||[],stats:{duration:t.telemetry.totalDuration,toolCalls:t.telemetry.toolCallCount,tokenCount:t.telemetry.tokenCount}}}async generateWithLLM(t,s,r){const a=this.buildSystemPrompt(),i=this.buildUserPrompt(s),o=[{role:"system",content:a},{role:"user",content:i}];if(t.policy.useStreaming!==!1&&(r!=null&&r.emitEvent)){let d="";const p=this.provider.chatStream({messages:o,temperature:.7});for await(const h of p)h.delta&&(d+=h.delta,r.emitEvent("stream_chunk","info","generating response...",{chunk:h.delta}));return this.appendStats(d.trim(),s)}const c=await this.provider.chat({messages:o,temperature:.7});return this.appendStats(c.content.trim(),s)}buildSystemPrompt(){return`你是一个智能助手，正在向用户汇报任务执行结果。

要求：
1. 用自然、友好的语言总结任务完成情况
2. 突出重要的结果和发现
3. 如果有失败的步骤，简要说明原因
4. 回复要简洁明了，避免冗长的技术细节
5. ${this.language==="zh"?"请用中文回复。":this.language==="en"?"Please respond in English.":"请根据用户的原始问题语言来回复。"}

示例回复风格：
- "我已经完成了您的请求！以下是主要发现：..."
- "任务执行完毕。关于您询问的内容，我发现..."
- "好的，我为您查询了相关信息。结果显示..."`}buildUserPrompt(t){let s=`用户的原始目标：${t.goal}

`;return s+=`执行情况：
`,s+=`- 总步骤数：${t.totalSteps}
`,s+=`- 完成：${t.completedSteps.length}
`,s+=`- 失败：${t.failedSteps.length}

`,t.completedSteps.length>0&&(s+=`已完成的步骤：
`,t.completedSteps.forEach((r,a)=>{s+=`${a+1}. ${r.description}
`,r.result&&(s+=`   结果: ${JSON.stringify(r.result).substring(0,200)}
`)}),s+=`
`),t.toolResults.length>0&&(s+=`工具执行结果：
`,t.toolResults.forEach(r=>{s+=`- ${r.toolName}: ${JSON.stringify(r.output).substring(0,300)}
`}),s+=`
`),t.failedSteps.length>0&&(s+=`失败的步骤：
`,t.failedSteps.forEach(r=>{s+=`- ${r.description}: ${r.error}
`})),s+=`
请根据以上执行情况，用自然语言向用户汇报结果。`,s}appendStats(t,s){return this.includeStats?t+`

---
*执行统计: ${s.stats.toolCalls} 次工具调用, ${s.stats.tokenCount} tokens, ${s.stats.duration}ms*`:t}generateTemplateResponse(t,s){let a=s.failedSteps.length===0?`✅ 任务已完成！

`:`⚠️ 任务部分完成。

`;return a+=`**目标**: ${s.goal}

`,s.completedSteps.length>0&&(a+=`**已完成的步骤**:
`,s.completedSteps.forEach((i,o)=>{a+=`${o+1}. ${i.description}
`}),a+=`
`),s.toolResults.length>0&&(a+=`**执行结果**:
`,s.toolResults.forEach(i=>{a+=`- **${i.toolName}**: `;const o=JSON.stringify(i.output);a+=o.length>100?o.substring(0,100)+"...":o,a+=`
`})),s.failedSteps.length>0&&(a+=`
**失败的步骤**:
`,s.failedSteps.forEach(i=>{a+=`- ${i.description}: ${i.error}
`})),this.appendStats(a,s)}}const Bs=[/i prefer/i,/i like/i,/i want/i,/i need/i,/i always/i,/please.*always/i,/by default/i,/make sure/i],Ns=[/^remember\b/i,/^remember that\b/i,/^save\b/i,/^save this\b/i,/^store\b/i,/^store this\b/i,/^add to memory\b/i,/^note that\b/i];function zs(n,e=Bs){const t=n.toLowerCase();return e.some(s=>s.test(t))}function pn(n,e=Ns){const t=n.trim();if(!t)return null;for(const s of e)if(s.test(t))return t.replace(s,"").trim()||t;return null}function js(n){if(typeof n=="string")return n;try{return JSON.stringify(n)}catch{return String(n)}}class fn extends ue{constructor(t){super("memory","Memory Saver");u(this,"memory");u(this,"config");this.memory=t.memoryManager,this.config={memoryManager:t.memoryManager,saveCompletedTasks:t.saveCompletedTasks??!0,saveUserPreferences:t.saveUserPreferences??!0,saveToolResults:t.saveToolResults??!1,taskImportanceScorer:t.taskImportanceScorer}}async execute(t){const s=[];try{if(t.policy.memoryEnabled===!1)return this.createResult(t,s);const r=t.task.steps.every(o=>o.status==="completed"||o.status==="failed"),a=t.task.steps.some(o=>o.status==="completed");if(this.config.saveCompletedTasks&&r&&a&&(await this.saveCompletedTask(t)&&s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"memory_save",nodeId:this.id,status:"success",summary:"Saved completed task to memory",metadata:{kind:"completed-task",tags:["completed-task","execution"]}}),s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:"Saved completed task to memory"})),this.config.saveUserPreferences&&await this.saveUserPreferences(t)&&(s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"memory_save",nodeId:this.id,status:"success",summary:"Saved user preference to memory",metadata:{kind:"user-preference",tags:["user-preference","conversation"]}}),s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"node_end",nodeId:this.id,status:"success",summary:"Saved user preference to memory"})),this.config.saveToolResults){const o=await this.saveToolResults(t);o>0&&s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"memory_save",nodeId:this.id,status:"success",summary:`Saved ${o} tool results to memory`,metadata:{kind:"tool-result",count:o,tags:["tool-result","execution"]}})}const i=await this.saveArtifacts(t);return i>0&&s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"memory_save",nodeId:this.id,status:"success",summary:`Saved ${i} artifacts to memory`,metadata:{kind:"artifact",count:i}}),this.createResult(t,s)}catch(r){return console.error("[MemoryNode] Failed to save memories:",r),s.push({id:`evt-${Date.now()}`,timestamp:Date.now(),type:"error",nodeId:this.id,status:"warning",summary:`Memory save failed: ${r instanceof Error?r.message:String(r)}`}),this.createResult(t,s)}}async saveCompletedTask(t){const s=this.config.taskImportanceScorer?this.config.taskImportanceScorer(t):this.calculateTaskImportance(t),r=t.task.steps.filter(i=>i.status==="completed"),a={goal:t.task.goal,stepsCompleted:r.length,totalSteps:t.task.steps.length,steps:r.map(i=>({description:i.description,status:i.status})),completedAt:Date.now()};return await this.memory.remember(a,{tags:["completed-task","execution"],importance:s,longTerm:s>=.6}),!0}async saveUserPreferences(t){const s=t.conversation.messages.filter(i=>i.role==="user"),r=s[s.length-1];return r&&zs(r.content)?(await this.memory.remember(r.content,{tags:["user-preference","conversation"],importance:.85,longTerm:!0}),!0):!1}async saveToolResults(t){let s=0;for(const r of t.task.steps)r.status==="completed"&&r.result&&JSON.stringify(r.result).length>50&&(await this.memory.remember({description:r.description,result:r.result},{tags:["tool-result","execution"],importance:.5}),s+=1);return s}async saveArtifacts(t){let s=0;return t.artifacts.sql&&t.artifacts.sql.length>0&&(await this.memory.remember({type:"sql",queries:t.artifacts.sql,goal:t.task.goal},{tags:["artifact","sql","query"],importance:.6,longTerm:!0}),s+=1),t.artifacts.files&&t.artifacts.files.length>0&&(await this.memory.remember({type:"files",files:t.artifacts.files,goal:t.task.goal},{tags:["artifact","files","reference"],importance:.7,longTerm:!0}),s+=1),s}calculateTaskImportance(t){let s=.5;const r=t.task.steps.length;s+=Math.min(r*.05,.2);const a=t.task.steps.filter(o=>o.status==="failed").length;return a>0&&(s-=a*.1),(t.artifacts.sql&&t.artifacts.sql.length>0||t.artifacts.files&&t.artifacts.files.length>0)&&(s+=.15),t.conversation.messages.length>10&&(s+=.1),Math.min(Math.max(s,.1),1)}}const gn=["hi","hello","hey","你好","嗨","thanks","thank you","谢谢"],yn=[/^what is your name/,/^who are you/,/^你是谁/,/^how are you/,/^你好吗/],vn=["search","find","query","analyze","research","create","generate","build","make","write","搜索","查询","分析","研究","创建","生成","编写","sql","database","数据库","optimize","优化","calculate","计算","summarize","总结"];function qs(n,e){if(!e)return!1;const t=n.toLowerCase().trim();return gn.some(s=>t===s||t.startsWith(s+" "))||yn.some(s=>s.test(t))?!1:!!vn.some(s=>t.includes(s))}function hs(n,e){const t=e.filter(r=>r.status==="completed");let s=`任务已完成！

`;return s+=`**目标**: ${n}

`,t.length>0&&(s+=`**执行步骤**:
`,t.forEach((r,a)=>{s+=`${a+1}. ${r.description}
`})),s}class bn{constructor(){u(this,"controller");u(this,"abortState",{aborted:!1});u(this,"checkpoints",new Map);this.controller=new AbortController}get signal(){return this.controller.signal}get isAborted(){return this.abortState.aborted}getAbortState(){return{...this.abortState}}abort(e){this.abortState.aborted||(this.abortState={aborted:!0,reason:e||"User initiated abort",timestamp:Date.now()},this.controller.abort(e))}reset(){this.controller=new AbortController,this.abortState={aborted:!1}}saveCheckpoint(e){this.checkpoints.set(e.id,e),this.abortState.checkpoint=e}getCheckpoint(e){return this.checkpoints.get(e)}getLatestCheckpoint(){return this.abortState.checkpoint}listCheckpoints(){return Array.from(this.checkpoints.values()).sort((e,t)=>t.timestamp-e.timestamp)}clearCheckpoints(){this.checkpoints.clear(),this.abortState.checkpoint&&delete this.abortState.checkpoint}throwIfAborted(){if(this.controller.signal.aborted){const e=new Error(this.abortState.reason||"Operation aborted");throw e.name="AbortError",e}}wrapWithAbort(e){return new Promise((t,s)=>{if(this.controller.signal.aborted){const a=new Error(this.abortState.reason||"Operation aborted");a.name="AbortError",s(a);return}const r=()=>{const a=new Error(this.abortState.reason||"Operation aborted");a.name="AbortError",s(a)};this.controller.signal.addEventListener("abort",r),e.then(t).catch(s).finally(()=>{this.controller.signal.removeEventListener("abort",r)})})}}function ms(n){return n instanceof Error?n.name==="AbortError"||n.message.includes("aborted"):!1}class kn{async route(e){return{mode:qs(e.message,e.hasTools)?"agent":"chat",reason:"rule-based"}}}const wn='You are a routing assistant. Decide whether to use chat or agent mode. Return JSON only with fields: {"mode":"chat|agent","allowedTools"?:string[],"enableMemory"?:boolean,"enableChatMemory"?:boolean,"reason"?:string}.';class Sn{constructor(e,t={}){u(this,"fallbackRouter");this.provider=e,this.options=t,this.fallbackRouter=t.fallbackRouter??new kn}async route(e){if(!e.hasTools)return{mode:"chat",reason:"no-tools"};const t=[{role:"system",content:this.options.systemPrompt||wn},{role:"user",content:[`User message: ${e.message}`,`Available tools: ${e.availableTools.join(", ")||"none"}`].join(`
`)}];try{const s=await this.provider.chat({messages:t,temperature:this.options.temperature??.1}),r=xn(s.content);return r?_n(r,e):await this.fallbackRouter.route(e)}catch(s){return console.error("[IntentRouter] Failed to route with LLM:",s),await this.fallbackRouter.route(e)}}}function xn(n){const e=n.match(/\{[\s\S]*\}/);if(!e)return null;try{return JSON.parse(e[0])}catch{return null}}function _n(n,e){var o,l,c;const t=n.mode==="agent"?"agent":"chat",s=((o=n.toolPolicy)==null?void 0:o.allowedTools)||n.allowedTools,r=((l=n.memoryPolicy)==null?void 0:l.enableMemory)??n.enableMemory,a=((c=n.memoryPolicy)==null?void 0:c.enableChatMemory)??n.enableChatMemory,i={mode:t,reason:n.reason,toolPolicy:void 0,memoryPolicy:void 0};return Array.isArray(s)&&s.length>0&&(i.toolPolicy={allowedTools:s.filter(d=>e.availableTools.includes(d))}),(r!==void 0||a!==void 0)&&(i.memoryPolicy={enableMemory:r===void 0?void 0:!!r,enableChatMemory:a===void 0?void 0:!!a}),e.hasTools||(i.mode="chat"),i}function Tn(n){return{log(e){const t=e.timestamp??Date.now();n.emit("audit",e.status,e.action,{metadata:{actor:e.actor,roles:e.roles,...e.metadata},payload:{...e,timestamp:t}})}}}function ps(n,e){return e&&e.length>0?e:n.defaultRoles?[...n.defaultRoles]:[]}function Cn(n,e){const t={};for(const s of e){const r=n.roles[s]||[];for(const a of r)t[a]=!0}return t}const mt={limit:5,messageRole:"system"},Zs={saveUserPreferences:!0,saveConversationTurns:!1,saveIntentMessages:!1,minMessageLength:20,importance:.85,longTerm:!0};function En(n,e){let t=n;e.minImportance!==void 0&&(t=t.filter(r=>r.metadata.importance>=e.minImportance)),e.tags&&e.tags.length>0&&(t=t.filter(r=>r.metadata.tags?r.metadata.tags.some(a=>e.tags.includes(a)):!1));const s=e.limit??mt.limit;return t.slice(0,s)}function Ln(n){const e=n.map(t=>js(t.content)).filter(Boolean);return e.length===0?"":e.length===1?`Relevant memory: ${e[0]}`:`Relevant memories:
${e.map(t=>`- ${t}`).join(`
`)}`}async function In(n,e,t,s={}){const r={...Zs,...s},a=s.tags??[];if(r.saveIntentMessages){const i=s.intentPatterns??Ns,o=pn(e,i);o&&await n.remember(o,{tags:Xe(["explicit-memory","conversation",...a]),importance:r.intentImportance??Math.max(.9,r.importance),longTerm:r.longTerm})}if(r.saveUserPreferences){const i=s.preferencePatterns??Bs;zs(e,i)&&await n.remember(e,{tags:Xe(["user-preference","conversation",...a]),importance:r.importance,longTerm:r.longTerm})}if(r.saveConversationTurns){const i=e.trim();i.length>=r.minMessageLength&&await n.remember({user:i,assistant:t},{tags:Xe(["conversation-turn",...a]),importance:Math.min(r.importance,.7),longTerm:r.longTerm})}}function Xe(n){return Array.from(new Set(n)).filter(Boolean)}class An{constructor(e){u(this,"provider");u(this,"toolRegistry");u(this,"runner",null);u(this,"eventStream",null);u(this,"abortController");u(this,"isRunning",!1);u(this,"lastState",null);u(this,"config");u(this,"intentRouter");u(this,"conversationHistory",[]);u(this,"auditLogger");this.config={provider:e.provider,tools:e.tools||[],mode:e.mode||"auto",systemPrompt:e.systemPrompt||"You are a helpful AI assistant.",streaming:e.streaming??!0,maxSteps:e.maxSteps||15,hooks:e.hooks||{},useLLMResponder:e.useLLMResponder??!1,confirmTool:e.confirmTool,memory:e.memory,enableMemory:e.enableMemory??!1,rbac:e.rbac,auditLogger:e.auditLogger,enableIntentRouter:e.enableIntentRouter??!1,intentRouter:e.intentRouter,intentRouterOptions:e.intentRouterOptions,enableChatMemory:e.enableChatMemory??!1,chatMemorySavePolicy:e.chatMemorySavePolicy,chatMemoryRecallPolicy:e.chatMemoryRecallPolicy},this.provider=this.createProvider(this.config.provider),this.toolRegistry=new Ur,this.abortController=new bn,this.intentRouter=this.createIntentRouter(),this.config.tools.forEach(t=>this.toolRegistry.register(t)),this.initializeRunner(),this.auditLogger=this.config.auditLogger??(this.eventStream?Tn(this.eventStream):void 0)}createProvider(e){return"type"in e?Oe(e):Xr(e)}createIntentRouter(){if(this.config.intentRouter)return this.config.intentRouter;if(this.config.enableIntentRouter)return new Sn(this.provider,this.config.intentRouterOptions)}initializeRunner(){const e=new en(this.toolRegistry,{provider:this.provider}),t=new ln(this.toolRegistry,{provider:this.provider}),s=new dn({onConfirm:this.config.confirmTool}),r=new un,a=this.config.useLLMResponder?new mn({provider:this.provider}):new hn,i=[e,t,s,r,a];let o=null;this.config.enableMemory&&this.config.memory&&(o=new fn({memoryManager:this.config.memory,saveCompletedTasks:!0,saveUserPreferences:!0,saveToolResults:!1}),i.push(o));const l={nodes:i,edges:[{from:"planner",to:"tool-runner"},{from:"tool-runner",to:"confirmation",condition:c=>{var d;return((d=c.task.pendingToolCall)==null?void 0:d.status)==="pending"}},{from:"tool-runner",to:"verifier"},{from:"confirmation",to:"tool-runner"},{from:"verifier",to:"responder",condition:c=>c.task.currentStepIndex>=c.task.steps.length},{from:"verifier",to:"tool-runner",condition:c=>c.task.currentStepIndex<c.task.steps.length},...o?[{from:"responder",to:"memory"}]:[]],entryNode:"planner",maxSteps:this.config.maxSteps};this.runner=new Kr(l,void 0,this.config.hooks),this.eventStream=this.runner.getEventStream()}async chat(e,t={}){var i;if(this.isRunning)throw new Error("Agent is already running. Call abort() first.");this.isRunning=!0,this.abortController.reset();const s=Date.now(),r=await this.determineRouting(e),a=r.mode;this.logAudit({action:"route_decision",status:"info",metadata:{mode:a,reason:r.reason,allowedTools:(i=r.toolPolicy)==null?void 0:i.allowedTools,memoryPolicy:r.memoryPolicy}}),this.conversationHistory.push({role:"user",content:e});try{return a==="chat"?await this.handleChatMode(e,t,s,r):await this.handleAgentMode(e,s,r)}catch(o){if(ms(o))return{content:"[任务已中断]",mode:a,duration:Date.now()-s,aborted:!0,abortReason:this.abortController.getAbortState().reason};throw o}finally{this.isRunning=!1}}async determineRouting(e){if(this.config.mode==="chat")return{mode:"chat",reason:"config"};if(this.config.mode==="agent")return{mode:"agent",reason:"config"};const t=this.toolRegistry.list().length>0;if(!this.intentRouter)return{mode:qs(e,t)?"agent":"chat",reason:"rule-based"};const s=await this.intentRouter.route({message:e,hasTools:t,availableTools:this.toolRegistry.list()});return!t&&s.mode==="agent"?{...s,mode:"chat"}:s}async handleChatMode(e,t,s,r){var h;const a=[{role:"system",content:this.config.systemPrompt}],i=this.resolveRBAC(),o=this.isPermissionAllowed(i.permissions,"memory:read"),l=this.isPermissionAllowed(i.permissions,"memory:write"),c=t.useChatMemory??((h=r==null?void 0:r.memoryPolicy)==null?void 0:h.enableChatMemory)??this.config.enableChatMemory;if(c&&this.config.memory){const m=this.mergeChatMemoryRecallPolicy(t.chatMemoryRecallPolicy);if(o){const g=await this.buildChatMemoryMessage(e,m);g&&a.push(g)}else this.logAudit({action:"memory_recall_blocked",status:"warning",metadata:{scope:"chat",reason:"permission"}})}if(a.push(...this.conversationHistory),(t.stream??this.config.streaming)&&t.onStream){let m="",g;const y=this.provider.chatStream({messages:a,temperature:t.temperature,signal:this.abortController.signal});for await(const w of y)w.delta&&(m+=w.delta,t.onStream(w.delta)),w.usage&&(g=w.usage);return this.conversationHistory.push({role:"assistant",content:m}),c&&this.config.memory&&(l?await this.saveChatMemory(e,m,t.chatMemorySavePolicy):this.logAudit({action:"memory_save_blocked",status:"warning",metadata:{scope:"chat",reason:"permission"}})),{content:m,mode:"chat",duration:Date.now()-s,usage:g}}const p=await this.provider.chat({messages:a,temperature:t.temperature,signal:this.abortController.signal});return this.conversationHistory.push({role:"assistant",content:p.content}),c&&this.config.memory&&(l?await this.saveChatMemory(e,p.content,t.chatMemorySavePolicy):this.logAudit({action:"memory_save_blocked",status:"warning",metadata:{scope:"chat",reason:"permission"}})),{content:p.content,usage:p.usage,mode:"chat",duration:Date.now()-s}}async handleAgentMode(e,t,s){var R,$;if(!this.runner)throw new Error("GraphRunner not initialized");let r=[];const a=((R=s==null?void 0:s.memoryPolicy)==null?void 0:R.enableMemory)??this.config.enableMemory,i=this.resolveRBAC(),o=i.permissions??{"sql:read":!0,"document:read":!0},l=i.roles,c=this.isPermissionAllowed(i.permissions,"memory:read"),d=this.isPermissionAllowed(i.permissions,"memory:write"),p=a&&d;a&&this.config.memory&&(c?r=await this.recallRelevantMemories(e):this.logAudit({action:"memory_recall_blocked",status:"warning",metadata:{scope:"agent",reason:"permission"}}));const h=hr(e,{permissions:o,allowedTools:($=s==null?void 0:s.toolPolicy)==null?void 0:$.allowedTools,memoryEnabled:p,roles:l});r.length>0&&(h.memory.shortTerm.recalled_context=r);const g=(await this.abortController.wrapWithAbort(this.runner.execute(h))).state;this.lastState=g;const y=g.conversation.messages.filter(D=>D.role==="assistant").pop(),w=(y==null?void 0:y.content)||hs(g.task.goal,g.task.steps.map(D=>({description:D.description,status:D.status})));return this.conversationHistory.push({role:"assistant",content:w}),{content:w,mode:"agent",steps:g.task.steps.map(D=>({description:D.description,status:D.status,result:D.result})),duration:Date.now()-t,usage:{promptTokens:0,completionTokens:0,totalTokens:g.telemetry.tokenCount}}}async recallRelevantMemories(e){var t;if(!this.config.memory)return[];try{const s=await this.config.memory.recall(e);return(t=this.eventStream)==null||t.emit("memory_recall","info","Recalled agent memories",{metadata:{query:e,count:s.length,source:"agent"}}),this.logAudit({action:"memory_recall",status:"info",metadata:{scope:"agent",query:e,count:s.length}}),s.slice(0,5).map(r=>js(r.content))}catch(s){return console.error("[Agent] Failed to recall memories:",s),[]}}mergeChatMemoryRecallPolicy(e){return{...mt,...this.config.chatMemoryRecallPolicy,...e}}mergeChatMemorySavePolicy(e){return{...Zs,...this.config.chatMemorySavePolicy,...e}}async buildChatMemoryMessage(e,t){var s;if(!this.config.memory)return null;try{const r=await this.config.memory.recall(e);(s=this.eventStream)==null||s.emit("memory_recall","info","Recalled chat memories",{metadata:{query:e,count:r.length,source:"chat"}}),this.logAudit({action:"memory_recall",status:"info",metadata:{scope:"chat",query:e,count:r.length}});const a=En(r,t),i=Ln(a);return i?{role:t.messageRole??mt.messageRole,content:i}:null}catch(r){return console.error("[Agent] Failed to recall chat memories:",r),null}}async saveChatMemory(e,t,s){var a;if(!this.config.memory)return;const r=this.mergeChatMemorySavePolicy(s);try{await In(this.config.memory,e,t,r),(a=this.eventStream)==null||a.emit("memory_save","info","Saved chat memory",{metadata:{source:"chat",saveIntentMessages:!!r.saveIntentMessages,saveUserPreferences:!!r.saveUserPreferences,saveConversationTurns:!!r.saveConversationTurns}}),this.logAudit({action:"memory_save",status:"info",metadata:{scope:"chat",saveIntentMessages:!!r.saveIntentMessages,saveUserPreferences:!!r.saveUserPreferences,saveConversationTurns:!!r.saveConversationTurns}})}catch(i){console.error("[Agent] Failed to save chat memories:",i)}}resolveRBAC(){var r,a;const e=(r=this.config.rbac)==null?void 0:r.policy;if(!e)return{};const t=ps(e,(a=this.config.rbac)==null?void 0:a.roles),s=Cn(e,t);return{roles:t,permissions:s}}isPermissionAllowed(e,t){return e?e[t]===!0:!0}logAudit(e){var r,a,i,o;if(!this.auditLogger)return;const t=(r=this.config.rbac)==null?void 0:r.policy,s=t?ps(t,(a=this.config.rbac)==null?void 0:a.roles):(i=this.config.rbac)==null?void 0:i.roles;this.auditLogger.log({...e,actor:(o=this.config.rbac)==null?void 0:o.actor,roles:s})}getEventStream(){if(!this.eventStream)throw new Error("EventStream not initialized");return this.eventStream}getToolRegistry(){return this.toolRegistry}getProvider(){return this.provider}getHistory(){return[...this.conversationHistory]}getMemory(){return this.config.memory}getGraphDefinition(){var e;return(e=this.runner)==null?void 0:e.getGraphDefinition()}registerTool(e){this.toolRegistry.register(e)}clearHistory(){this.conversationHistory=[]}setHistory(e){this.conversationHistory=[...e]}abort(e){var t;if(!this.isRunning){console.warn("Agent is not running, nothing to abort.");return}this.abortController.abort(e),(t=this.eventStream)==null||t.emit("abort","warning",e||"User initiated abort")}async resume(e={}){var a;if(this.isRunning)throw new Error("Agent is already running.");const t=e.fromCheckpoint;let s=null;if(t){const i=this.abortController.getCheckpoint(t);if(!i)throw new Error(`Checkpoint "${t}" not found.`);s=i.state}else{const i=this.abortController.getLatestCheckpoint();s=(i==null?void 0:i.state)||this.lastState}if(!s)throw new Error("No state available to resume from.");e.modifiedState&&(s={...s,...e.modifiedState,updatedAt:Date.now()}),this.isRunning=!0,this.abortController.reset();const r=Date.now();try{if(!this.runner)throw new Error("GraphRunner not initialized");(a=this.eventStream)==null||a.emit("resume","info","Resuming from checkpoint");const o=(await this.runner.execute(s)).state;this.lastState=o;const l=o.conversation.messages.filter(d=>d.role==="assistant").pop(),c=(l==null?void 0:l.content)||hs(o.task.goal,o.task.steps.map(d=>({description:d.description,status:d.status})));return this.conversationHistory.push({role:"assistant",content:c}),{content:c,mode:"agent",steps:o.task.steps.map(d=>({description:d.description,status:d.status,result:d.result})),duration:Date.now()-r,usage:{promptTokens:0,completionTokens:0,totalTokens:o.telemetry.tokenCount}}}catch(i){if(ms(i))return{content:"[任务已中断]",mode:"agent",duration:Date.now()-r,aborted:!0,abortReason:this.abortController.getAbortState().reason};throw i}finally{this.isRunning=!1}}isAgentRunning(){return this.isRunning}getAbortController(){return this.abortController}listCheckpoints(){return this.abortController.listCheckpoints()}}function Rn(n){return new An(n)}const Mn={name:"sql-query",description:'Execute SQL SELECT queries on the database. Use this tool when the user wants to query data, list records, or get information from the database. Examples: "show all users", "list products", "get customer data".',inputSchema:Ie({query:ge().min(1,"Query cannot be empty").describe("The SQL SELECT query to execute"),database:ge().optional().describe("Optional database name")}),outputSchema:Ie({rows:ut(Zr(qr())),rowCount:Le(),executionTime:Le()}),timeout:5e3,retryPolicy:{maxRetries:3,backoffMs:1e3,backoffMultiplier:2},permissions:["sql:read"],requiresConfirmation:!0,confirmationMessage:"Execute database query?",allowedNodes:["tool-runner"],async execute(n){const{query:e}=n;if(!e.trim().toUpperCase().startsWith("SELECT"))throw new Error("Only SELECT queries are allowed");return console.log("[SQL-Query] Executing:",e),await new Promise(s=>setTimeout(s,100)),{rows:[{id:1,name:"Alice",email:"alice@example.com"},{id:2,name:"Bob",email:"bob@example.com"},{id:3,name:"Charlie",email:"charlie@example.com"}],rowCount:3,executionTime:100}}},$n={name:"document-search",description:'Search for documents and articles in the knowledge base. Use this tool when the user wants to find documentation, tutorials, guides, or articles. Examples: "find SQL optimization docs", "search for performance guide", "look up tutorial".',inputSchema:Ie({keywords:ut(ge()).min(1,"At least one keyword required").describe("Keywords to search for"),limit:Le().min(1).max(50).optional().default(10).describe("Maximum number of results")}),outputSchema:Ie({documents:ut(Ie({id:ge(),title:ge(),snippet:ge(),relevance:Le()})),totalCount:Le()}),timeout:3e3,retryPolicy:{maxRetries:2,backoffMs:500,backoffMultiplier:2},permissions:["document:read"],async execute(n){const{keywords:e,limit:t=10}=n;await new Promise(r=>setTimeout(r,200));const s=[{id:"doc-1",title:"SQL 优化最佳实践",snippet:"本文介绍了常见的 SQL 优化技巧，包括索引使用、查询重写等...",relevance:.95},{id:"doc-2",title:"数据库性能调优指南",snippet:"深入探讨数据库性能调优的各个方面，从硬件到查询优化...",relevance:.87},{id:"doc-3",title:"PostgreSQL 查询优化器原理",snippet:"详细解析 PostgreSQL 查询优化器的工作原理和优化策略...",relevance:.76}];return{documents:s.slice(0,t),totalCount:s.length}}};function Dn(){return[Mn,$n]}const pt=(n,e)=>e.some(t=>n instanceof t);let fs,gs;function Pn(){return fs||(fs=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function On(){return gs||(gs=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ft=new WeakMap,et=new WeakMap,Ke=new WeakMap;function Bn(n){const e=new Promise((t,s)=>{const r=()=>{n.removeEventListener("success",a),n.removeEventListener("error",i)},a=()=>{t(le(n.result)),r()},i=()=>{s(n.error),r()};n.addEventListener("success",a),n.addEventListener("error",i)});return Ke.set(e,n),e}function Nn(n){if(ft.has(n))return;const e=new Promise((t,s)=>{const r=()=>{n.removeEventListener("complete",a),n.removeEventListener("error",i),n.removeEventListener("abort",i)},a=()=>{t(),r()},i=()=>{s(n.error||new DOMException("AbortError","AbortError")),r()};n.addEventListener("complete",a),n.addEventListener("error",i),n.addEventListener("abort",i)});ft.set(n,e)}let gt={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return ft.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return le(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Us(n){gt=n(gt)}function zn(n){return On().includes(n)?function(...e){return n.apply(yt(this),e),le(this.request)}:function(...e){return le(n.apply(yt(this),e))}}function jn(n){return typeof n=="function"?zn(n):(n instanceof IDBTransaction&&Nn(n),pt(n,Pn())?new Proxy(n,gt):n)}function le(n){if(n instanceof IDBRequest)return Bn(n);if(et.has(n))return et.get(n);const e=jn(n);return e!==n&&(et.set(n,e),Ke.set(e,n)),e}const yt=n=>Ke.get(n);function qn(n,e,{blocked:t,upgrade:s,blocking:r,terminated:a}={}){const i=indexedDB.open(n,e),o=le(i);return s&&i.addEventListener("upgradeneeded",l=>{s(le(i.result),l.oldVersion,l.newVersion,le(i.transaction),l)}),t&&i.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),o.then(l=>{a&&l.addEventListener("close",()=>a()),r&&l.addEventListener("versionchange",c=>r(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}const Zn=["get","getKey","getAll","getAllKeys","count"],Un=["put","add","delete","clear"],tt=new Map;function ys(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(tt.get(e))return tt.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,r=Un.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(r||Zn.includes(t)))return;const a=async function(i,...o){const l=this.transaction(i,r?"readwrite":"readonly");let c=l.store;return s&&(c=c.index(o.shift())),(await Promise.all([c[t](...o),r&&l.done]))[0]};return tt.set(e,a),a}Us(n=>({...n,get:(e,t,s)=>ys(e,t)||n.get(e,t,s),has:(e,t)=>!!ys(e,t)||n.has(e,t)}));const Fn=["continue","continuePrimaryKey","advance"],vs={},vt=new WeakMap,Fs=new WeakMap,Vn={get(n,e){if(!Fn.includes(e))return n[e];let t=vs[e];return t||(t=vs[e]=function(...s){vt.set(this,Fs.get(this)[e](...s))}),t}};async function*Hn(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,Vn);for(Fs.set(t,e),Ke.set(t,yt(e));e;)yield t,e=await(vt.get(t)||e.continue()),vt.delete(t)}function bs(n,e){return e===Symbol.asyncIterator&&pt(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&pt(n,[IDBIndex,IDBObjectStore])}Us(n=>({...n,get(e,t,s){return bs(e,t)?Hn:n.get(e,t,s)},has(e,t){return bs(e,t)||n.has(e,t)}}));function Gn(n){return n>=.8?"critical":n>=.6?"high":n>=.4?"medium":"low"}class Wn{constructor(e={}){u(this,"store",new Map);u(this,"maxSize");u(this,"defaultTTL");this.maxSize=e.maxSize??1e3,this.defaultTTL=e.defaultTTL??30*60*1e3}set(e,t,s={}){!this.store.has(e)&&this.store.size>=this.maxSize&&this.evictLeastImportant();const r=Date.now(),a=s.importance??.5,i=s.expiresAt??(this.defaultTTL>0?r+this.defaultTTL:null),o={createdAt:s.createdAt??r,lastAccessedAt:r,accessCount:s.accessCount??0,importance:a,importanceLevel:Gn(a),expiresAt:i,source:s.source,tags:s.tags};this.store.set(e,{id:e,content:t,metadata:o})}get(e){const t=this.store.get(e);if(t){if(this.isExpired(t)){this.store.delete(e);return}return t.metadata.lastAccessedAt=Date.now(),t.metadata.accessCount++,t.content}}has(e){const t=this.store.get(e);return t?this.isExpired(t)?(this.store.delete(e),!1):!0:!1}delete(e){return this.store.delete(e)}clear(){this.store.clear()}keys(){return this.cleanup(),Array.from(this.store.keys())}getAll(){return this.cleanup(),new Map(this.store)}query(e={}){this.cleanup();let t=Array.from(this.store.values());e.minImportance!==void 0&&(t=t.filter(a=>a.metadata.importance>=e.minImportance)),e.tags&&e.tags.length>0&&(t=t.filter(a=>{var i;return(i=a.metadata.tags)==null?void 0:i.some(o=>e.tags.includes(o))}));const s=e.sortBy||"importance",r=e.sortOrder||"desc";return t.sort((a,i)=>{let o=0;switch(s){case"createdAt":o=a.metadata.createdAt-i.metadata.createdAt;break;case"lastAccessedAt":o=a.metadata.lastAccessedAt-i.metadata.lastAccessedAt;break;case"importance":o=a.metadata.importance-i.metadata.importance;break;case"accessCount":o=a.metadata.accessCount-i.metadata.accessCount;break}return r==="asc"?o:-o}),e.limit&&(t=t.slice(0,e.limit)),t}size(){return this.cleanup(),this.store.size}cleanup(){let e=0;for(const[t,s]of this.store.entries())this.isExpired(s)&&(this.store.delete(t),e++);return e}isExpired(e){return e.metadata.expiresAt===null?!1:Date.now()>e.metadata.expiresAt}evictLeastImportant(){if(this.store.size===0)return;let e=null,t=1/0;for(const[s,r]of this.store.entries()){const a=r.metadata.importance*Math.log(r.metadata.accessCount+1);a<t&&(t=a,e=s)}e&&this.store.delete(e)}export(){return this.cleanup(),Array.from(this.store.values())}import(e){for(const t of e)this.isExpired(t)||this.store.set(t.id,t)}}class Kn{constructor(e=128){u(this,"dimension");u(this,"vocabulary",new Map);u(this,"idf",new Map);this.dimension=e}async generateEmbedding(e){const t=this.tokenize(e),s=new Array(this.dimension).fill(0);for(const r of t){const a=this.hashString(r,this.dimension);s[a]+=1}return this.normalize(s)}async generateEmbeddings(e){return Promise.all(e.map(t=>this.generateEmbedding(t)))}calculateSimilarity(e,t){if(e.length!==t.length)throw new Error("Embedding dimensions must match");let s=0,r=0,a=0;for(let i=0;i<e.length;i++)s+=e[i]*t[i],r+=e[i]*e[i],a+=t[i]*t[i];return r===0||a===0?0:s/(Math.sqrt(r)*Math.sqrt(a))}tokenize(e){return e.toLowerCase().replace(/[^\w\s\u4e00-\u9fa5]/g," ").split(/\s+/).filter(t=>t.length>0)}hashString(e,t){let s=0;for(let r=0;r<e.length;r++){const a=e.charCodeAt(r);s=(s<<5)-s+a,s=s&s}return Math.abs(s)%t}normalize(e){const t=Math.sqrt(e.reduce((s,r)=>s+r*r,0));return t===0?e:e.map(s=>s/t)}}function Vs(n,e){if(n.length!==e.length)throw new Error("Vectors must have the same length");let t=0,s=0,r=0;for(let a=0;a<n.length;a++)t+=n[a]*e[a],s+=n[a]*n[a],r+=e[a]*e[a];return s===0||r===0?0:t/(Math.sqrt(s)*Math.sqrt(r))}function Ue(n){if(n==null)return"";if(typeof n=="string")return n;try{return JSON.stringify(n)}catch{return String(n)}}function Hs(n,e){var r;const t=Ue(n.content).toLowerCase(),s=((r=n.summary)==null?void 0:r.toLowerCase())||"";return t.includes(e)||s.includes(e)}function Ct(n,e){let t=n;return e.minImportance!==void 0&&(t=t.filter(s=>s.metadata.importance>=e.minImportance)),e.tags&&e.tags.length>0&&(t=t.filter(s=>{var r;return(r=s.metadata.tags)==null?void 0:r.some(a=>e.tags.includes(a))})),t}function Qn(n,e){const t=e.sortBy||"importance",s=e.sortOrder||"desc";return[...n].sort((r,a)=>{let i=0;switch(t){case"createdAt":i=r.metadata.createdAt-a.metadata.createdAt;break;case"lastAccessedAt":i=r.metadata.lastAccessedAt-a.metadata.lastAccessedAt;break;case"importance":i=r.metadata.importance-a.metadata.importance;break;case"accessCount":i=r.metadata.accessCount-a.metadata.accessCount;break}return s==="asc"?i:-i})}function Fe(n,e){let t=Ct(n,e);return t=Qn(t,e),e.limit&&(t=t.slice(0,e.limit)),t}class Jn{constructor(){u(this,"storage",new Map)}async save(e){this.storage.set(e.id,e)}async saveBatch(e){for(const t of e)await this.save(t)}async get(e){return this.storage.get(e)||null}async query(e={}){const t=Array.from(this.storage.values());return Fe(t,e)}async semanticSearch(e){const t=Array.from(this.storage.values());if(typeof e.query=="string"){const o=e.query.toLowerCase(),l=t.filter(d=>Hs(d,o)),c={limit:e.limit,minImportance:e.minImportance,tags:e.tags,sortBy:e.sortBy,sortOrder:e.sortOrder};return Fe(l,c)}const s=e.threshold??.7,r=Ct(t,e),a=[];for(const o of r){if(!o.embedding||o.embedding.length!==e.query.length)continue;const l=Vs(e.query,o.embedding);l>=s&&a.push({item:o,similarity:l})}a.sort((o,l)=>l.similarity-o.similarity);let i=a.map(o=>o.item);return e.limit&&(i=i.slice(0,e.limit)),i}async delete(e){return this.storage.delete(e)}async clear(){this.storage.clear()}async count(){return this.storage.size}}const Et={enabled:!0,minContentLength:400,maxSummaryLength:120,minAgeMs:24*60*60*1e3,minImportanceToPreserve:.6,maxItemsPerRun:50};class Gs{async summarize(e,t){const s=Ue(e);return s.length<=t.maxLength?s:t.maxLength<=3?s.slice(0,t.maxLength):`${s.slice(0,t.maxLength-3)}...`}}const ks=200;function Yn(){return`ltm_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`}function ws(n){return n>=.8?"critical":n>=.6?"high":n>=.4?"medium":"low"}class Xn{constructor(e,t,s,r){u(this,"adapter");u(this,"embeddingGen");u(this,"summarizer");u(this,"pruningConfig");this.adapter=e||new Jn,this.embeddingGen=t,this.summarizer=s||new Gs,this.pruningConfig={...Et,...r}}async add(e,t={}){const s=Yn(),r=Date.now(),a=t.importance??.5,i=t.summary??this.createSummary(e);let o;if(this.embeddingGen&&i)try{o=await this.embeddingGen.generateEmbedding(i)}catch(c){console.error("[LongTermMemory] Embedding generation failed:",c)}const l={id:s,content:e,summary:i,embedding:o,metadata:{createdAt:r,lastAccessedAt:r,accessCount:0,importance:a,importanceLevel:ws(a),expiresAt:null,source:t.source,tags:t.tags}};try{await this.adapter.save(l)}catch(c){throw console.error("[LongTermMemory] Save failed:",c),new Error(`Failed to save memory: ${c instanceof Error?c.message:String(c)}`)}return s}async get(e){const t=await this.adapter.get(e);return t&&(t.metadata.lastAccessedAt=Date.now(),t.metadata.accessCount++,await this.adapter.save(t)),t}async query(e={}){return this.adapter.query(e)}async search(e,t={}){const s={query:e,limit:t.limit||10,threshold:t.threshold||.7,minImportance:t.minImportance,tags:t.tags,sortBy:t.sortBy||"importance",sortOrder:t.sortOrder||"desc"};if(this.embeddingGen){const r=await this.embeddingGen.generateEmbedding(e);s.query=r}return this.adapter.semanticSearch(s)}async update(e,t){var l;const s=await this.adapter.get(e);if(!s)throw new Error(`Memory with id ${e} not found`);let r=t.summary,a=t.embedding;t.content!==void 0&&r===void 0&&(r=this.createSummary(t.content)),r!==void 0&&this.embeddingGen&&a===void 0&&(a=await this.embeddingGen.generateEmbedding(r));const i={...s.metadata,...t.metadata};((l=t.metadata)==null?void 0:l.importance)!==void 0&&t.metadata.importanceLevel===void 0&&(i.importanceLevel=ws(i.importance));const o={...s,...t,id:s.id,metadata:i};r!==void 0&&(o.summary=r),a!==void 0&&(o.embedding=a),await this.adapter.save(o)}async delete(e){return this.adapter.delete(e)}async clear(){await this.adapter.clear()}async consolidate(){const e=await this.adapter.query({sortBy:"importance",sortOrder:"asc"}),t=[],s=[];for(const r of e)r.metadata.importance<.3&&r.metadata.accessCount<2?t.push(r.id):s.push(r);for(const r of t)await this.adapter.delete(r);await this.pruneMemories(s)}async count(){return this.adapter.count()}createSummary(e){const t=Ue(e);return t.length<=ks?t:t.slice(0,ks)}shouldPrune(e,t){if(!this.pruningConfig.enabled||this.pruningConfig.minImportanceToPreserve!==void 0&&e.metadata.importance>=this.pruningConfig.minImportanceToPreserve||this.pruningConfig.minAgeMs!==void 0&&t-e.metadata.lastAccessedAt<this.pruningConfig.minAgeMs)return!1;const s=Ue(e.content);return!(s.length<this.pruningConfig.minContentLength||(e.summary??s).length<=this.pruningConfig.maxSummaryLength)}async pruneMemories(e){if(!this.pruningConfig.enabled)return;const t=Date.now(),s=[],r=this.pruningConfig.maxItemsPerRun??e.length;let a=0;for(const i of e){if(a>=r)break;if(!this.shouldPrune(i,t))continue;const l=(await this.summarizer.summarize(i.content,{maxLength:this.pruningConfig.maxSummaryLength,existingSummary:i.summary})).trim();if(!l||l===i.summary)continue;const c=l.length>this.pruningConfig.maxSummaryLength?l.slice(0,this.pruningConfig.maxSummaryLength):l,d={...i,summary:c};this.embeddingGen&&c&&(d.embedding=await this.embeddingGen.generateEmbedding(c)),s.push(d),a++}s.length>0&&await this.adapter.saveBatch(s)}}const ea="agent-memory-db",ta=1,Q="long_term_memory";class sa{constructor(){u(this,"db",null)}async init(){if(typeof indexedDB>"u")throw new Error("IndexedDB is not available in this environment.");this.db=await qn(ea,ta,{upgrade(e){if(!e.objectStoreNames.contains(Q)){const t=e.createObjectStore(Q,{keyPath:"id"});t.createIndex("createdAt","metadata.createdAt",{unique:!1}),t.createIndex("lastAccessedAt","metadata.lastAccessedAt",{unique:!1}),t.createIndex("importance","metadata.importance",{unique:!1}),t.createIndex("accessCount","metadata.accessCount",{unique:!1}),t.createIndex("tags","metadata.tags",{unique:!1,multiEntry:!0})}}})}async save(e){await this.ensureDB(),await this.db.put(Q,e)}async saveBatch(e){await this.ensureDB();const t=this.db.transaction(Q,"readwrite");for(const s of e)await t.store.put(s);await t.done}async get(e){return await this.ensureDB(),await this.db.get(Q,e)||null}async query(e={}){await this.ensureDB();const t=await this.db.getAll(Q);return Fe(t,e)}async semanticSearch(e){await this.ensureDB();const t=await this.db.getAll(Q);if(typeof e.query=="string"){const o=e.query.toLowerCase(),l=t.filter(d=>Hs(d,o)),c={limit:e.limit,minImportance:e.minImportance,tags:e.tags,sortBy:e.sortBy,sortOrder:e.sortOrder};return Fe(l,c)}const s=e.threshold??.7,r=Ct(t,e),a=[];for(const o of r){if(!o.embedding||o.embedding.length!==e.query.length)continue;const l=Vs(e.query,o.embedding);l>=s&&a.push({item:o,similarity:l})}a.sort((o,l)=>l.similarity-o.similarity);let i=a.map(o=>o.item);return e.limit&&(i=i.slice(0,e.limit)),i}async delete(e){return await this.ensureDB(),await this.db.delete(Q,e),!0}async clear(){await this.ensureDB(),await this.db.clear(Q)}async count(){return await this.ensureDB(),this.db.count(Q)}async ensureDB(){this.db||await this.init()}}const Ss={shortTermMaxSize:1e3,shortTermDefaultTTL:30*60*1e3,autoConsolidate:!0,consolidateIntervalMs:60*60*1e3,importanceThreshold:.3,pruningConfig:Et};class ra{constructor(e={},t,s){u(this,"shortTerm");u(this,"longTerm");u(this,"config");u(this,"consolidateTimer");this.config={...Ss,...e,pruningConfig:{...Ss.pruningConfig,...e.pruningConfig}},this.shortTerm=new Wn({maxSize:this.config.shortTermMaxSize,defaultTTL:this.config.shortTermDefaultTTL}),this.longTerm=new Xn(t||this.config.persistenceAdapter,s||this.config.embeddingGenerator,this.config.summarizer,this.config.pruningConfig),this.config.autoConsolidate&&this.startAutoConsolidate()}async remember(e,t={}){const s=t.importance??.5;if(t.longTerm||s>=.7)return await this.longTerm.add(e,{importance:s,tags:t.tags,source:t.source});{const r=`stm_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;return this.shortTerm.set(r,e,{importance:s,tags:t.tags,source:t.source,expiresAt:t.ttl?Date.now()+t.ttl:void 0}),r}}async recall(e){const t=[];try{if(typeof e=="string"){try{const r=await this.longTerm.search(e,{limit:10});t.push(...r)}catch(r){console.error("[MemoryManager] Long-term search failed:",r)}const s=this.shortTerm.query({tags:[e],limit:5});t.push(...s)}else{try{const r=await this.longTerm.query(e);t.push(...r)}catch(r){console.error("[MemoryManager] Long-term query failed:",r)}const s=this.shortTerm.query(e);t.push(...s)}return t.sort((s,r)=>{const a=(Date.now()-s.metadata.lastAccessedAt)/864e5,i=(Date.now()-r.metadata.lastAccessedAt)/(24*60*60*1e3),o=s.metadata.importance-a*.01;return r.metadata.importance-i*.01-o}),t}catch(s){return console.error("[MemoryManager] Recall failed:",s),t}}async promoteToLongTerm(e){const t=this.shortTerm.get(e);if(!t)return null;const r=this.shortTerm.getAll().get(e);if(!r)return null;const a=await this.longTerm.add(t,{importance:r.metadata.importance,tags:r.metadata.tags,source:r.metadata.source});return this.shortTerm.delete(e),a}async getStats(){const e=this.shortTerm.getAll();let t=0,s=0;for(const l of e.values())t+=l.metadata.accessCount,s+=l.metadata.importance;const r=e.size,a=await this.longTerm.count(),i=await this.longTerm.query({limit:1e3});let o=0;for(const l of i)o+=l.metadata.importance;return{shortTerm:{size:r,totalAccesses:t,averageImportance:r>0?s/r:0},longTerm:{count:a,averageImportance:a>0?o/a:0}}}async cleanup(){this.shortTerm.cleanup(),await this.longTerm.consolidate()}async consolidate(){const e=this.shortTerm.getAll();for(const[t,s]of e.entries())s.metadata.importance*Math.log(s.metadata.accessCount+1)>this.config.importanceThreshold*3&&await this.promoteToLongTerm(t);await this.cleanup()}startAutoConsolidate(){this.consolidateTimer=setInterval(()=>{this.consolidate().catch(e=>{console.error("[MemoryManager] Auto-consolidate failed:",e)})},this.config.consolidateIntervalMs)}stopAutoConsolidate(){this.consolidateTimer&&(clearInterval(this.consolidateTimer),this.consolidateTimer=void 0)}destroy(){this.stopAutoConsolidate(),this.shortTerm.clear()}}function na(n,e,t){return new ra(n,e,t)}const Ws="chatbox-agent-settings",xs={provider:"lm-studio",lmStudio:{baseURL:"http://127.0.0.1:6354",model:"mistralai/ministral-3-14b-reasoning"},gemini:{apiKey:"",model:"gemini-2.0-flash-exp"},openai:{apiKey:"",baseURL:"https://api.openai.com",model:"gpt-4o-mini"}};function aa(){try{const n=localStorage.getItem(Ws);if(n)return{...xs,...JSON.parse(n)}}catch(n){console.warn("Failed to load settings:",n)}return xs}function ia(n){try{localStorage.setItem(Ws,JSON.stringify(n))}catch(e){console.warn("Failed to save settings:",e)}}function oa(n){switch(n){case"lm-studio":return"LM Studio (Local)";case"gemini":return"Google Gemini";case"openai":return"OpenAI"}}const la="ChatboxAgentDB",J="conversations",ca=1;class da{constructor(){u(this,"db",null)}async getDB(){return this.db?this.db:new Promise((e,t)=>{const s=indexedDB.open(la,ca);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e(s.result)},s.onupgradeneeded=r=>{const a=r.target.result;a.objectStoreNames.contains(J)||a.createObjectStore(J,{keyPath:"id"})}})}async getAllConversations(){const e=await this.getDB();return new Promise((t,s)=>{const i=e.transaction(J,"readonly").objectStore(J).getAll();i.onerror=()=>s(i.error),i.onsuccess=()=>{const o=i.result;t(o.sort((l,c)=>c.timestamp-l.timestamp))}})}async saveConversation(e){const t=await this.getDB();return new Promise((s,r)=>{const o=t.transaction(J,"readwrite").objectStore(J).put(e);o.onerror=()=>r(o.error),o.onsuccess=()=>s()})}async deleteConversation(e){const t=await this.getDB();return new Promise((s,r)=>{const o=t.transaction(J,"readwrite").objectStore(J).delete(e);o.onerror=()=>r(o.error),o.onsuccess=()=>s()})}async clearAll(){const e=await this.getDB();return new Promise((t,s)=>{const i=e.transaction(J,"readwrite").objectStore(J).clear();i.onerror=()=>s(i.error),i.onsuccess=()=>t()})}}const st=new da;class ua{constructor(){u(this,"state");u(this,"listeners",[]);this.state={isGenerating:!1,settings:aa(),selectedProvider:"lm-studio",isStreamEnabled:!0,lastLatencyMs:null,lastTokenCount:null,conversations:[],activeConversationId:null,isInitialized:!1}}async init(){const e=await st.getAllConversations();this.setState({conversations:e,isInitialized:!0})}getState(){return{...this.state}}setState(e){const t=this.state.conversations;this.state={...this.state,...e},e.conversations&&this.persistChanges(e.conversations,t),this.notifyListeners()}async persistChanges(e,t){for(const s of e){const r=t.find(a=>a.id===s.id);(!r||JSON.stringify(r)!==JSON.stringify(s))&&await st.saveConversation(s)}for(const s of t)e.find(r=>r.id===s.id)||await st.deleteConversation(s.id)}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(){this.listeners.forEach(e=>e(this.getState()))}saveSettings(){ia(this.state.settings)}}const L=new ua,Ks="chatbox-model-history";function Qs(){try{return JSON.parse(localStorage.getItem(Ks)||"[]")}catch{return[]}}function ha(n){if(!n)return;let e=Qs();e=e.filter(t=>t!==n),e.unshift(n),e=e.slice(0,10),localStorage.setItem(Ks,JSON.stringify(e))}function Lt(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var he=Lt();function Js(n){he=n}var Ae={exec:()=>null};function A(n,e=""){let t=typeof n=="string"?n:n.source,s={replace:(r,a)=>{let i=typeof a=="string"?a:a.source;return i=i.replace(z.caret,"$1"),t=t.replace(r,i),s},getRegex:()=>new RegExp(t,e)};return s}var ma=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),z={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:n=>new RegExp(`^( {0,3}${n})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}#`),htmlBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}<(?:[a-z].*>|!--)`,"i")},pa=/^(?:[ \t]*(?:\n|$))+/,fa=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,ga=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,$e=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ya=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,It=/(?:[*+-]|\d{1,9}[.)])/,Ys=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Xs=A(Ys).replace(/bull/g,It).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),va=A(Ys).replace(/bull/g,It).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),At=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,ba=/^[^\n]+/,Rt=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,ka=A(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Rt).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),wa=A(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,It).getRegex(),Qe="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Mt=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Sa=A("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Mt).replace("tag",Qe).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),er=A(At).replace("hr",$e).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qe).getRegex(),xa=A(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",er).getRegex(),$t={blockquote:xa,code:fa,def:ka,fences:ga,heading:ya,hr:$e,html:Sa,lheading:Xs,list:wa,newline:pa,paragraph:er,table:Ae,text:ba},_s=A("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",$e).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qe).getRegex(),_a={...$t,lheading:va,table:_s,paragraph:A(At).replace("hr",$e).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",_s).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qe).getRegex()},Ta={...$t,html:A(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Mt).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:Ae,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:A(At).replace("hr",$e).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Xs).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},Ca=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,Ea=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,tr=/^( {2,}|\\)\n(?!\s*$)/,La=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,Je=/[\p{P}\p{S}]/u,Dt=/[\s\p{P}\p{S}]/u,sr=/[^\s\p{P}\p{S}]/u,Ia=A(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Dt).getRegex(),rr=/(?!~)[\p{P}\p{S}]/u,Aa=/(?!~)[\s\p{P}\p{S}]/u,Ra=/(?:[^\s\p{P}\p{S}]|~)/u,Ma=A(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",ma?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),nr=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,$a=A(nr,"u").replace(/punct/g,Je).getRegex(),Da=A(nr,"u").replace(/punct/g,rr).getRegex(),ar="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Pa=A(ar,"gu").replace(/notPunctSpace/g,sr).replace(/punctSpace/g,Dt).replace(/punct/g,Je).getRegex(),Oa=A(ar,"gu").replace(/notPunctSpace/g,Ra).replace(/punctSpace/g,Aa).replace(/punct/g,rr).getRegex(),Ba=A("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,sr).replace(/punctSpace/g,Dt).replace(/punct/g,Je).getRegex(),Na=A(/\\(punct)/,"gu").replace(/punct/g,Je).getRegex(),za=A(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),ja=A(Mt).replace("(?:-->|$)","-->").getRegex(),qa=A("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",ja).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Ve=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,Za=A(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Ve).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),ir=A(/^!?\[(label)\]\[(ref)\]/).replace("label",Ve).replace("ref",Rt).getRegex(),or=A(/^!?\[(ref)\](?:\[\])?/).replace("ref",Rt).getRegex(),Ua=A("reflink|nolink(?!\\()","g").replace("reflink",ir).replace("nolink",or).getRegex(),Ts=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,Pt={_backpedal:Ae,anyPunctuation:Na,autolink:za,blockSkip:Ma,br:tr,code:Ea,del:Ae,emStrongLDelim:$a,emStrongRDelimAst:Pa,emStrongRDelimUnd:Ba,escape:Ca,link:Za,nolink:or,punctuation:Ia,reflink:ir,reflinkSearch:Ua,tag:qa,text:La,url:Ae},Fa={...Pt,link:A(/^!?\[(label)\]\((.*?)\)/).replace("label",Ve).getRegex(),reflink:A(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Ve).getRegex()},bt={...Pt,emStrongRDelimAst:Oa,emStrongLDelim:Da,url:A(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",Ts).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:A(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",Ts).getRegex()},Va={...bt,br:A(tr).replace("{2,}","*").getRegex(),text:A(bt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},De={normal:$t,gfm:_a,pedantic:Ta},_e={normal:Pt,gfm:bt,breaks:Va,pedantic:Fa},Ha={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Cs=n=>Ha[n];function te(n,e){if(e){if(z.escapeTest.test(n))return n.replace(z.escapeReplace,Cs)}else if(z.escapeTestNoEncode.test(n))return n.replace(z.escapeReplaceNoEncode,Cs);return n}function Es(n){try{n=encodeURI(n).replace(z.percentDecode,"%")}catch{return null}return n}function Ls(n,e){var a;let t=n.replace(z.findPipe,(i,o,l)=>{let c=!1,d=o;for(;--d>=0&&l[d]==="\\";)c=!c;return c?"|":" |"}),s=t.split(z.splitPipe),r=0;if(s[0].trim()||s.shift(),s.length>0&&!((a=s.at(-1))!=null&&a.trim())&&s.pop(),e)if(s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;r<s.length;r++)s[r]=s[r].trim().replace(z.slashPipe,"|");return s}function Te(n,e,t){let s=n.length;if(s===0)return"";let r=0;for(;r<s&&n.charAt(s-r-1)===e;)r++;return n.slice(0,s-r)}function Ga(n,e){if(n.indexOf(e[1])===-1)return-1;let t=0;for(let s=0;s<n.length;s++)if(n[s]==="\\")s++;else if(n[s]===e[0])t++;else if(n[s]===e[1]&&(t--,t<0))return s;return t>0?-2:-1}function Is(n,e,t,s,r){let a=e.href,i=e.title||null,o=n[1].replace(r.other.outputLinkReplace,"$1");s.state.inLink=!0;let l={type:n[0].charAt(0)==="!"?"image":"link",raw:t,href:a,title:i,text:o,tokens:s.inlineTokens(o)};return s.state.inLink=!1,l}function Wa(n,e,t){let s=n.match(t.other.indentCodeCompensation);if(s===null)return e;let r=s[1];return e.split(`
`).map(a=>{let i=a.match(t.other.beginningSpace);if(i===null)return a;let[o]=i;return o.length>=r.length?a.slice(r.length):a}).join(`
`)}var He=class{constructor(n){u(this,"options");u(this,"rules");u(this,"lexer");this.options=n||he}space(n){let e=this.rules.block.newline.exec(n);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(n){let e=this.rules.block.code.exec(n);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:Te(t,`
`)}}}fences(n){let e=this.rules.block.fences.exec(n);if(e){let t=e[0],s=Wa(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(n){let e=this.rules.block.heading.exec(n);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let s=Te(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(n){let e=this.rules.block.hr.exec(n);if(e)return{type:"hr",raw:Te(e[0],`
`)}}blockquote(n){let e=this.rules.block.blockquote.exec(n);if(e){let t=Te(e[0],`
`).split(`
`),s="",r="",a=[];for(;t.length>0;){let i=!1,o=[],l;for(l=0;l<t.length;l++)if(this.rules.other.blockquoteStart.test(t[l]))o.push(t[l]),i=!0;else if(!i)o.push(t[l]);else break;t=t.slice(l);let c=o.join(`
`),d=c.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${c}`:c,r=r?`${r}
${d}`:d;let p=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(d,a,!0),this.lexer.state.top=p,t.length===0)break;let h=a.at(-1);if((h==null?void 0:h.type)==="code")break;if((h==null?void 0:h.type)==="blockquote"){let m=h,g=m.raw+`
`+t.join(`
`),y=this.blockquote(g);a[a.length-1]=y,s=s.substring(0,s.length-m.raw.length)+y.raw,r=r.substring(0,r.length-m.text.length)+y.text;break}else if((h==null?void 0:h.type)==="list"){let m=h,g=m.raw+`
`+t.join(`
`),y=this.list(g);a[a.length-1]=y,s=s.substring(0,s.length-h.raw.length)+y.raw,r=r.substring(0,r.length-m.raw.length)+y.raw,t=g.substring(a.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:a,text:r}}}list(n){var t,s;let e=this.rules.block.list.exec(n);if(e){let r=e[1].trim(),a=r.length>1,i={type:"list",raw:"",ordered:a,start:a?+r.slice(0,-1):"",loose:!1,items:[]};r=a?`\\d{1,9}\\${r.slice(-1)}`:`\\${r}`,this.options.pedantic&&(r=a?r:"[*+-]");let o=this.rules.other.listItemRegex(r),l=!1;for(;n;){let d=!1,p="",h="";if(!(e=o.exec(n))||this.rules.block.hr.test(n))break;p=e[0],n=n.substring(p.length);let m=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,R=>" ".repeat(3*R.length)),g=n.split(`
`,1)[0],y=!m.trim(),w=0;if(this.options.pedantic?(w=2,h=m.trimStart()):y?w=e[1].length+1:(w=e[2].search(this.rules.other.nonSpaceChar),w=w>4?1:w,h=m.slice(w),w+=e[1].length),y&&this.rules.other.blankLine.test(g)&&(p+=g+`
`,n=n.substring(g.length+1),d=!0),!d){let R=this.rules.other.nextBulletRegex(w),$=this.rules.other.hrRegex(w),D=this.rules.other.fencesBeginRegex(w),q=this.rules.other.headingBeginRegex(w),K=this.rules.other.htmlBeginRegex(w);for(;n;){let B=n.split(`
`,1)[0],Z;if(g=B,this.options.pedantic?(g=g.replace(this.rules.other.listReplaceNesting,"  "),Z=g):Z=g.replace(this.rules.other.tabCharGlobal,"    "),D.test(g)||q.test(g)||K.test(g)||R.test(g)||$.test(g))break;if(Z.search(this.rules.other.nonSpaceChar)>=w||!g.trim())h+=`
`+Z.slice(w);else{if(y||m.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||D.test(m)||q.test(m)||$.test(m))break;h+=`
`+g}!y&&!g.trim()&&(y=!0),p+=B+`
`,n=n.substring(B.length+1),m=Z.slice(w)}}i.loose||(l?i.loose=!0:this.rules.other.doubleBlankLine.test(p)&&(l=!0)),i.items.push({type:"list_item",raw:p,task:!!this.options.gfm&&this.rules.other.listIsTask.test(h),loose:!1,text:h,tokens:[]}),i.raw+=p}let c=i.items.at(-1);if(c)c.raw=c.raw.trimEnd(),c.text=c.text.trimEnd();else return;i.raw=i.raw.trimEnd();for(let d of i.items){if(this.lexer.state.top=!1,d.tokens=this.lexer.blockTokens(d.text,[]),d.task){if(d.text=d.text.replace(this.rules.other.listReplaceTask,""),((t=d.tokens[0])==null?void 0:t.type)==="text"||((s=d.tokens[0])==null?void 0:s.type)==="paragraph"){d.tokens[0].raw=d.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),d.tokens[0].text=d.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let h=this.lexer.inlineQueue.length-1;h>=0;h--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[h].src)){this.lexer.inlineQueue[h].src=this.lexer.inlineQueue[h].src.replace(this.rules.other.listReplaceTask,"");break}}let p=this.rules.other.listTaskCheckbox.exec(d.raw);if(p){let h={type:"checkbox",raw:p[0]+" ",checked:p[0]!=="[ ]"};d.checked=h.checked,i.loose?d.tokens[0]&&["paragraph","text"].includes(d.tokens[0].type)&&"tokens"in d.tokens[0]&&d.tokens[0].tokens?(d.tokens[0].raw=h.raw+d.tokens[0].raw,d.tokens[0].text=h.raw+d.tokens[0].text,d.tokens[0].tokens.unshift(h)):d.tokens.unshift({type:"paragraph",raw:h.raw,text:h.raw,tokens:[h]}):d.tokens.unshift(h)}}if(!i.loose){let p=d.tokens.filter(m=>m.type==="space"),h=p.length>0&&p.some(m=>this.rules.other.anyLine.test(m.raw));i.loose=h}}if(i.loose)for(let d of i.items){d.loose=!0;for(let p of d.tokens)p.type==="text"&&(p.type="paragraph")}return i}}html(n){let e=this.rules.block.html.exec(n);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(n){let e=this.rules.block.def.exec(n);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:r}}}table(n){var i;let e=this.rules.block.table.exec(n);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Ls(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),r=(i=e[3])!=null&&i.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],a={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(let o of s)this.rules.other.tableAlignRight.test(o)?a.align.push("right"):this.rules.other.tableAlignCenter.test(o)?a.align.push("center"):this.rules.other.tableAlignLeft.test(o)?a.align.push("left"):a.align.push(null);for(let o=0;o<t.length;o++)a.header.push({text:t[o],tokens:this.lexer.inline(t[o]),header:!0,align:a.align[o]});for(let o of r)a.rows.push(Ls(o,a.header.length).map((l,c)=>({text:l,tokens:this.lexer.inline(l),header:!1,align:a.align[c]})));return a}}lheading(n){let e=this.rules.block.lheading.exec(n);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(n){let e=this.rules.block.paragraph.exec(n);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(n){let e=this.rules.block.text.exec(n);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(n){let e=this.rules.inline.escape.exec(n);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(n){let e=this.rules.inline.tag.exec(n);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(n){let e=this.rules.inline.link.exec(n);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let a=Te(t.slice(0,-1),"\\");if((t.length-a.length)%2===0)return}else{let a=Ga(e[2],"()");if(a===-2)return;if(a>-1){let i=(e[0].indexOf("!")===0?5:4)+e[1].length+a;e[2]=e[2].substring(0,a),e[0]=e[0].substring(0,i).trim(),e[3]=""}}let s=e[2],r="";if(this.options.pedantic){let a=this.rules.other.pedanticHrefTitle.exec(s);a&&(s=a[1],r=a[3])}else r=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),Is(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:r&&r.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(n,e){let t;if((t=this.rules.inline.reflink.exec(n))||(t=this.rules.inline.nolink.exec(n))){let s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),r=e[s.toLowerCase()];if(!r){let a=t[0].charAt(0);return{type:"text",raw:a,text:a}}return Is(t,r,t[0],this.lexer,this.rules)}}emStrong(n,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(n);if(!(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!t||this.rules.inline.punctuation.exec(t))){let r=[...s[0]].length-1,a,i,o=r,l=0,c=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,e=e.slice(-1*n.length+r);(s=c.exec(e))!=null;){if(a=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!a)continue;if(i=[...a].length,s[3]||s[4]){o+=i;continue}else if((s[5]||s[6])&&r%3&&!((r+i)%3)){l+=i;continue}if(o-=i,o>0)continue;i=Math.min(i,i+o+l);let d=[...s[0]][0].length,p=n.slice(0,r+s.index+d+i);if(Math.min(r,i)%2){let m=p.slice(1,-1);return{type:"em",raw:p,text:m,tokens:this.lexer.inlineTokens(m)}}let h=p.slice(2,-2);return{type:"strong",raw:p,text:h,tokens:this.lexer.inlineTokens(h)}}}}codespan(n){let e=this.rules.inline.code.exec(n);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(t),r=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&r&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(n){let e=this.rules.inline.br.exec(n);if(e)return{type:"br",raw:e[0]}}del(n){let e=this.rules.inline.del.exec(n);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(n){let e=this.rules.inline.autolink.exec(n);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(n){var t;let e;if(e=this.rules.inline.url.exec(n)){let s,r;if(e[2]==="@")s=e[0],r="mailto:"+s;else{let a;do a=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(a!==e[0]);s=e[0],e[1]==="www."?r="http://"+e[0]:r=e[0]}return{type:"link",raw:e[0],text:s,href:r,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(n){let e=this.rules.inline.text.exec(n);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},H=class kt{constructor(e){u(this,"tokens");u(this,"options");u(this,"state");u(this,"inlineQueue");u(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||he,this.options.tokenizer=this.options.tokenizer||new He,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:z,block:De.normal,inline:_e.normal};this.options.pedantic?(t.block=De.pedantic,t.inline=_e.pedantic):this.options.gfm&&(t.block=De.gfm,this.options.breaks?t.inline=_e.breaks:t.inline=_e.gfm),this.tokenizer.rules=t}static get rules(){return{block:De,inline:_e}}static lex(e,t){return new kt(t).lex(e)}static lexInline(e,t){return new kt(t).inlineTokens(e)}lex(e){e=e.replace(z.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let s=this.inlineQueue[t];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],s=!1){var r,a,i;for(this.options.pedantic&&(e=e.replace(z.tabCharGlobal,"    ").replace(z.spaceLine,""));e;){let o;if((a=(r=this.options.extensions)==null?void 0:r.block)!=null&&a.some(c=>(o=c.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.space(e)){e=e.substring(o.raw.length);let c=t.at(-1);o.raw.length===1&&c!==void 0?c.raw+=`
`:t.push(o);continue}if(o=this.tokenizer.code(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(o=this.tokenizer.fences(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.heading(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.hr(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.blockquote(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.list(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.html(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.def(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.raw,this.inlineQueue.at(-1).src=c.text):this.tokens.links[o.tag]||(this.tokens.links[o.tag]={href:o.href,title:o.title},t.push(o));continue}if(o=this.tokenizer.table(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.lheading(e)){e=e.substring(o.raw.length),t.push(o);continue}let l=e;if((i=this.options.extensions)!=null&&i.startBlock){let c=1/0,d=e.slice(1),p;this.options.extensions.startBlock.forEach(h=>{p=h.call({lexer:this},d),typeof p=="number"&&p>=0&&(c=Math.min(c,p))}),c<1/0&&c>=0&&(l=e.substring(0,c+1))}if(this.state.top&&(o=this.tokenizer.paragraph(l))){let c=t.at(-1);s&&(c==null?void 0:c.type)==="paragraph"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o),s=l.length!==e.length,e=e.substring(o.raw.length);continue}if(o=this.tokenizer.text(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(e){let c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}else throw new Error(c)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var l,c,d,p,h;let s=e,r=null;if(this.tokens.links){let m=Object.keys(this.tokens.links);if(m.length>0)for(;(r=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)m.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(r=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,r.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let a;for(;(r=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)a=r[2]?r[2].length:0,s=s.slice(0,r.index+a)+"["+"a".repeat(r[0].length-a-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=((c=(l=this.options.hooks)==null?void 0:l.emStrongMask)==null?void 0:c.call({lexer:this},s))??s;let i=!1,o="";for(;e;){i||(o=""),i=!1;let m;if((p=(d=this.options.extensions)==null?void 0:d.inline)!=null&&p.some(y=>(m=y.call({lexer:this},e,t))?(e=e.substring(m.raw.length),t.push(m),!0):!1))continue;if(m=this.tokenizer.escape(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.tag(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.link(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(m.raw.length);let y=t.at(-1);m.type==="text"&&(y==null?void 0:y.type)==="text"?(y.raw+=m.raw,y.text+=m.text):t.push(m);continue}if(m=this.tokenizer.emStrong(e,s,o)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.codespan(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.br(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.del(e)){e=e.substring(m.raw.length),t.push(m);continue}if(m=this.tokenizer.autolink(e)){e=e.substring(m.raw.length),t.push(m);continue}if(!this.state.inLink&&(m=this.tokenizer.url(e))){e=e.substring(m.raw.length),t.push(m);continue}let g=e;if((h=this.options.extensions)!=null&&h.startInline){let y=1/0,w=e.slice(1),R;this.options.extensions.startInline.forEach($=>{R=$.call({lexer:this},w),typeof R=="number"&&R>=0&&(y=Math.min(y,R))}),y<1/0&&y>=0&&(g=e.substring(0,y+1))}if(m=this.tokenizer.inlineText(g)){e=e.substring(m.raw.length),m.raw.slice(-1)!=="_"&&(o=m.raw.slice(-1)),i=!0;let y=t.at(-1);(y==null?void 0:y.type)==="text"?(y.raw+=m.raw,y.text+=m.text):t.push(m);continue}if(e){let y="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(y);break}else throw new Error(y)}}return t}},Ge=class{constructor(n){u(this,"options");u(this,"parser");this.options=n||he}space(n){return""}code({text:n,lang:e,escaped:t}){var a;let s=(a=(e||"").match(z.notSpaceStart))==null?void 0:a[0],r=n.replace(z.endingNewline,"")+`
`;return s?'<pre><code class="language-'+te(s)+'">'+(t?r:te(r,!0))+`</code></pre>
`:"<pre><code>"+(t?r:te(r,!0))+`</code></pre>
`}blockquote({tokens:n}){return`<blockquote>
${this.parser.parse(n)}</blockquote>
`}html({text:n}){return n}def(n){return""}heading({tokens:n,depth:e}){return`<h${e}>${this.parser.parseInline(n)}</h${e}>
`}hr(n){return`<hr>
`}list(n){let e=n.ordered,t=n.start,s="";for(let i=0;i<n.items.length;i++){let o=n.items[i];s+=this.listitem(o)}let r=e?"ol":"ul",a=e&&t!==1?' start="'+t+'"':"";return"<"+r+a+`>
`+s+"</"+r+`>
`}listitem(n){return`<li>${this.parser.parse(n.tokens)}</li>
`}checkbox({checked:n}){return"<input "+(n?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:n}){return`<p>${this.parser.parseInline(n)}</p>
`}table(n){let e="",t="";for(let r=0;r<n.header.length;r++)t+=this.tablecell(n.header[r]);e+=this.tablerow({text:t});let s="";for(let r=0;r<n.rows.length;r++){let a=n.rows[r];t="";for(let i=0;i<a.length;i++)t+=this.tablecell(a[i]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:n}){return`<tr>
${n}</tr>
`}tablecell(n){let e=this.parser.parseInline(n.tokens),t=n.header?"th":"td";return(n.align?`<${t} align="${n.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:n}){return`<strong>${this.parser.parseInline(n)}</strong>`}em({tokens:n}){return`<em>${this.parser.parseInline(n)}</em>`}codespan({text:n}){return`<code>${te(n,!0)}</code>`}br(n){return"<br>"}del({tokens:n}){return`<del>${this.parser.parseInline(n)}</del>`}link({href:n,title:e,tokens:t}){let s=this.parser.parseInline(t),r=Es(n);if(r===null)return s;n=r;let a='<a href="'+n+'"';return e&&(a+=' title="'+te(e)+'"'),a+=">"+s+"</a>",a}image({href:n,title:e,text:t,tokens:s}){s&&(t=this.parser.parseInline(s,this.parser.textRenderer));let r=Es(n);if(r===null)return te(t);n=r;let a=`<img src="${n}" alt="${t}"`;return e&&(a+=` title="${te(e)}"`),a+=">",a}text(n){return"tokens"in n&&n.tokens?this.parser.parseInline(n.tokens):"escaped"in n&&n.escaped?n.text:te(n.text)}},Ot=class{strong({text:n}){return n}em({text:n}){return n}codespan({text:n}){return n}del({text:n}){return n}html({text:n}){return n}text({text:n}){return n}link({text:n}){return""+n}image({text:n}){return""+n}br(){return""}checkbox({raw:n}){return n}},G=class wt{constructor(e){u(this,"options");u(this,"renderer");u(this,"textRenderer");this.options=e||he,this.options.renderer=this.options.renderer||new Ge,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Ot}static parse(e,t){return new wt(t).parse(e)}static parseInline(e,t){return new wt(t).parseInline(e)}parse(e){var s,r;let t="";for(let a=0;a<e.length;a++){let i=e[a];if((r=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&r[i.type]){let l=i,c=this.options.extensions.renderers[l.type].call({parser:this},l);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(l.type)){t+=c||"";continue}}let o=i;switch(o.type){case"space":{t+=this.renderer.space(o);break}case"hr":{t+=this.renderer.hr(o);break}case"heading":{t+=this.renderer.heading(o);break}case"code":{t+=this.renderer.code(o);break}case"table":{t+=this.renderer.table(o);break}case"blockquote":{t+=this.renderer.blockquote(o);break}case"list":{t+=this.renderer.list(o);break}case"checkbox":{t+=this.renderer.checkbox(o);break}case"html":{t+=this.renderer.html(o);break}case"def":{t+=this.renderer.def(o);break}case"paragraph":{t+=this.renderer.paragraph(o);break}case"text":{t+=this.renderer.text(o);break}default:{let l='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return t}parseInline(e,t=this.renderer){var r,a;let s="";for(let i=0;i<e.length;i++){let o=e[i];if((a=(r=this.options.extensions)==null?void 0:r.renderers)!=null&&a[o.type]){let c=this.options.extensions.renderers[o.type].call({parser:this},o);if(c!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(o.type)){s+=c||"";continue}}let l=o;switch(l.type){case"escape":{s+=t.text(l);break}case"html":{s+=t.html(l);break}case"link":{s+=t.link(l);break}case"image":{s+=t.image(l);break}case"checkbox":{s+=t.checkbox(l);break}case"strong":{s+=t.strong(l);break}case"em":{s+=t.em(l);break}case"codespan":{s+=t.codespan(l);break}case"br":{s+=t.br(l);break}case"del":{s+=t.del(l);break}case"text":{s+=t.text(l);break}default:{let c='Token with "'+l.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return s}},Pe,Ee=(Pe=class{constructor(n){u(this,"options");u(this,"block");this.options=n||he}preprocess(n){return n}postprocess(n){return n}processAllTokens(n){return n}emStrongMask(n){return n}provideLexer(){return this.block?H.lex:H.lexInline}provideParser(){return this.block?G.parse:G.parseInline}},u(Pe,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),u(Pe,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),Pe),Ka=class{constructor(...n){u(this,"defaults",Lt());u(this,"options",this.setOptions);u(this,"parse",this.parseMarkdown(!0));u(this,"parseInline",this.parseMarkdown(!1));u(this,"Parser",G);u(this,"Renderer",Ge);u(this,"TextRenderer",Ot);u(this,"Lexer",H);u(this,"Tokenizer",He);u(this,"Hooks",Ee);this.use(...n)}walkTokens(n,e){var s,r;let t=[];for(let a of n)switch(t=t.concat(e.call(this,a)),a.type){case"table":{let i=a;for(let o of i.header)t=t.concat(this.walkTokens(o.tokens,e));for(let o of i.rows)for(let l of o)t=t.concat(this.walkTokens(l.tokens,e));break}case"list":{let i=a;t=t.concat(this.walkTokens(i.items,e));break}default:{let i=a;(r=(s=this.defaults.extensions)==null?void 0:s.childTokens)!=null&&r[i.type]?this.defaults.extensions.childTokens[i.type].forEach(o=>{let l=i[o].flat(1/0);t=t.concat(this.walkTokens(l,e))}):i.tokens&&(t=t.concat(this.walkTokens(i.tokens,e)))}}return t}use(...n){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return n.forEach(t=>{let s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(r=>{if(!r.name)throw new Error("extension name required");if("renderer"in r){let a=e.renderers[r.name];a?e.renderers[r.name]=function(...i){let o=r.renderer.apply(this,i);return o===!1&&(o=a.apply(this,i)),o}:e.renderers[r.name]=r.renderer}if("tokenizer"in r){if(!r.level||r.level!=="block"&&r.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let a=e[r.level];a?a.unshift(r.tokenizer):e[r.level]=[r.tokenizer],r.start&&(r.level==="block"?e.startBlock?e.startBlock.push(r.start):e.startBlock=[r.start]:r.level==="inline"&&(e.startInline?e.startInline.push(r.start):e.startInline=[r.start]))}"childTokens"in r&&r.childTokens&&(e.childTokens[r.name]=r.childTokens)}),s.extensions=e),t.renderer){let r=this.defaults.renderer||new Ge(this.defaults);for(let a in t.renderer){if(!(a in r))throw new Error(`renderer '${a}' does not exist`);if(["options","parser"].includes(a))continue;let i=a,o=t.renderer[i],l=r[i];r[i]=(...c)=>{let d=o.apply(r,c);return d===!1&&(d=l.apply(r,c)),d||""}}s.renderer=r}if(t.tokenizer){let r=this.defaults.tokenizer||new He(this.defaults);for(let a in t.tokenizer){if(!(a in r))throw new Error(`tokenizer '${a}' does not exist`);if(["options","rules","lexer"].includes(a))continue;let i=a,o=t.tokenizer[i],l=r[i];r[i]=(...c)=>{let d=o.apply(r,c);return d===!1&&(d=l.apply(r,c)),d}}s.tokenizer=r}if(t.hooks){let r=this.defaults.hooks||new Ee;for(let a in t.hooks){if(!(a in r))throw new Error(`hook '${a}' does not exist`);if(["options","block"].includes(a))continue;let i=a,o=t.hooks[i],l=r[i];Ee.passThroughHooks.has(a)?r[i]=c=>{if(this.defaults.async&&Ee.passThroughHooksRespectAsync.has(a))return(async()=>{let p=await o.call(r,c);return l.call(r,p)})();let d=o.call(r,c);return l.call(r,d)}:r[i]=(...c)=>{if(this.defaults.async)return(async()=>{let p=await o.apply(r,c);return p===!1&&(p=await l.apply(r,c)),p})();let d=o.apply(r,c);return d===!1&&(d=l.apply(r,c)),d}}s.hooks=r}if(t.walkTokens){let r=this.defaults.walkTokens,a=t.walkTokens;s.walkTokens=function(i){let o=[];return o.push(a.call(this,i)),r&&(o=o.concat(r.call(this,i))),o}}this.defaults={...this.defaults,...s}}),this}setOptions(n){return this.defaults={...this.defaults,...n},this}lexer(n,e){return H.lex(n,e??this.defaults)}parser(n,e){return G.parse(n,e??this.defaults)}parseMarkdown(n){return(e,t)=>{let s={...t},r={...this.defaults,...s},a=this.onError(!!r.silent,!!r.async);if(this.defaults.async===!0&&s.async===!1)return a(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return a(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return a(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(r.hooks&&(r.hooks.options=r,r.hooks.block=n),r.async)return(async()=>{let i=r.hooks?await r.hooks.preprocess(e):e,o=await(r.hooks?await r.hooks.provideLexer():n?H.lex:H.lexInline)(i,r),l=r.hooks?await r.hooks.processAllTokens(o):o;r.walkTokens&&await Promise.all(this.walkTokens(l,r.walkTokens));let c=await(r.hooks?await r.hooks.provideParser():n?G.parse:G.parseInline)(l,r);return r.hooks?await r.hooks.postprocess(c):c})().catch(a);try{r.hooks&&(e=r.hooks.preprocess(e));let i=(r.hooks?r.hooks.provideLexer():n?H.lex:H.lexInline)(e,r);r.hooks&&(i=r.hooks.processAllTokens(i)),r.walkTokens&&this.walkTokens(i,r.walkTokens);let o=(r.hooks?r.hooks.provideParser():n?G.parse:G.parseInline)(i,r);return r.hooks&&(o=r.hooks.postprocess(o)),o}catch(i){return a(i)}}}onError(n,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,n){let s="<p>An error occurred:</p><pre>"+te(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}},de=new Ka;function M(n,e){return de.parse(n,e)}M.options=M.setOptions=function(n){return de.setOptions(n),M.defaults=de.defaults,Js(M.defaults),M};M.getDefaults=Lt;M.defaults=he;M.use=function(...n){return de.use(...n),M.defaults=de.defaults,Js(M.defaults),M};M.walkTokens=function(n,e){return de.walkTokens(n,e)};M.parseInline=de.parseInline;M.Parser=G;M.parser=G.parse;M.Renderer=Ge;M.TextRenderer=Ot;M.Lexer=H;M.lexer=H.lex;M.Tokenizer=He;M.Hooks=Ee;M.parse=M;M.options;M.setOptions;M.use;M.walkTokens;M.parseInline;G.parse;H.lex;M.setOptions({breaks:!0,gfm:!0});class Qa{constructor(e){this.listEl=e}appendMessage(e,t){const s=`msg-${Date.now()}`,r=document.createElement("div");r.className=`message-row ${e}`,r.id=s;const a=e==="ai"?'<div class="avatar-mark"></div>':"U",i=e==="ai"?"Assistant":"You";return r.innerHTML=`
            <div class="message-inner">
                <div class="message-avatar ${e}">
                    ${a}
                </div>
                <div class="message-body">
                    <div class="message-header">
                        <span class="role-pill ${e}">${i}</span>
                        <span class="message-divider"></span>
                    </div>
                    <div class="message-content prose">${this.formatContent(t)}</div>
                </div>
            </div>
        `,this.listEl.appendChild(r),s}streamUpdate(e,t){const s=document.getElementById(e);if(!s)return;const r=s.querySelector(".message-content");if(!r)return;const a=this.parseThinkingContent(t),i=this.formatContent(a.content);if(a.thinking){this.renderThinkingBlock(r,a.thinking,i,!1);return}r.innerHTML=i}updateMessage(e,t,s=!1,r){const a=document.getElementById(e);if(!a)return;const i=a.querySelector(".message-body"),o=a.querySelector(".message-content");if(!i||!o)return;const l=this.parseThinkingContent(t),c=this.formatContent(l.content);if(l.thinking?this.renderThinkingBlock(o,l.thinking,c,!0):o.innerHTML=c,s&&o.classList.add("text-red-500"),r&&a.classList.contains("ai")){const d=document.createElement("div");d.className="message-meta",d.innerHTML=`
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                ${r}
            `,i.appendChild(d)}}clear(){this.listEl.innerHTML=""}formatContent(e){if(!e)return"";try{return M.parse(e)}catch{return e.replace(/\n/g,"<br>")}}parseThinkingContent(e){const t=/<think>([\s\S]*?)<\/think>/gi,s=e.match(t);if(!s)return{thinking:"",content:e};const r=s.map(i=>i.replace(/<\/?think>/gi,"").trim()).join(`

`),a=e.replace(t,"").trim();return{thinking:r,content:a}}renderThinkingBlock(e,t,s,r){const a=e.querySelector(".thinking-process"),i=r?(a==null?void 0:a.hasAttribute("open"))??!1:!1;e.innerHTML=`
            <div class="thinking-wrapper">
                <details class="thinking-process">
                    <summary>
                        <span class="thinking-label">💭 Reasoning</span>
                        <span class="thinking-hint">Click to expand</span>
                    </summary>
                    <div class="thinking-content">${this.escapeHtml(t)}</div>
                </details>
                <div class="assistant-content">${s||'<span class="muted-text">Generating response...</span>'}</div>
            </div>
        `;const o=e.querySelector(".thinking-process");o&&i&&o.setAttribute("open","")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}const As="chatbox-sidebar-open";class Ja{constructor(e,t){u(this,"isOpen");var r;this.sidebar=e,this.overlay=t;const s=localStorage.getItem(As);this.isOpen=s!==null?s==="true":window.innerWidth>=768,(r=this.overlay)==null||r.addEventListener("click",()=>this.close()),this.sidebar.style.transition="none",this.applyState(),this.sidebar.offsetHeight,requestAnimationFrame(()=>{this.sidebar.style.transition=""})}toggle(){this.isOpen=!this.isOpen,this.persist(),this.applyState()}open(){this.isOpen=!0,this.persist(),this.applyState()}close(){this.isOpen=!1,this.persist(),this.applyState()}applyState(){var t,s,r;window.innerWidth<768?(this.isOpen?(this.sidebar.classList.remove("-translate-x-full"),(t=this.overlay)==null||t.classList.add("active"),document.body.style.overflow="hidden"):(this.sidebar.classList.add("-translate-x-full"),(s=this.overlay)==null||s.classList.remove("active"),document.body.style.overflow=""),document.body.classList.remove("sidebar-collapsed")):(this.sidebar.classList.remove("-translate-x-full"),(r=this.overlay)==null||r.classList.remove("active"),document.body.style.overflow="",document.body.classList.toggle("sidebar-collapsed",!this.isOpen))}persist(){localStorage.setItem(As,String(this.isOpen))}}class Ya{constructor(e){u(this,"activeFilter","all");u(this,"searchQuery","");u(this,"counts",{all:0,step:0,event:0,error:0});this.options=e,this.options.filterButtons.forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.filter;this.activeFilter=s||"all",this.options.filterButtons.forEach(r=>r.classList.remove("active")),t.classList.add("active"),this.applyFilter()})}),this.options.searchInput.addEventListener("input",()=>{this.searchQuery=this.options.searchInput.value.toLowerCase(),this.applyFilter()}),this.updateEmptyStates()}addStep(e,t,s){var o;const r=document.createElement("div");r.className="debug-step-item",r.dataset.filter="step";const i=t==="running"?"status-running":"status-completed";r.innerHTML=`
            <div class="debug-item-header">
                <span class="step-indicator ${i}"></span>
                <div class="debug-item-title">
                    <span class="node-id">${e}</span>
                    <span class="node-status">${t}</span>
                </div>
                ${s?'<button class="detail-toggle">Data</button>':""}
            </div>
            ${s?`<div class="debug-item-detail hidden"><pre>${this.formatData(s)}</pre></div>`:""}
        `,s&&((o=r.querySelector(".detail-toggle"))==null||o.addEventListener("click",l=>{const c=r.querySelector(".debug-item-detail");c==null||c.classList.toggle("hidden"),l.target.classList.toggle("active")})),this.options.stepsList.appendChild(r),this.options.stepsList.scrollTop=this.options.stepsList.scrollHeight,this.updateCounts(),this.applyFilter(),this.updateEmptyStates()}updateStep(e,t){const r=Array.from(this.options.stepsList.querySelectorAll(".debug-step-item")).reverse().find(a=>{var i,o;return((i=a.querySelector(".node-id"))==null?void 0:i.textContent)===e&&((o=a.querySelector(".node-status"))==null?void 0:o.textContent)==="running"});if(r){const a=t.success!==!1,i=r.querySelector(".step-indicator"),o=r.querySelector(".node-status");if(i&&(i.className=`step-indicator ${a?"status-completed":"status-failed"}`),o&&(o.textContent=a?"completed":"failed"),!r.querySelector(".detail-toggle")){const l=r.querySelector(".debug-item-header"),c=document.createElement("button");c.className="detail-toggle",c.textContent="Result",c.onclick=()=>{let d=r.querySelector(".debug-item-detail");d||(d=document.createElement("div"),d.className="debug-item-detail",d.innerHTML=`<pre>${this.formatData(t)}</pre>`,r.appendChild(d)),d.classList.toggle("hidden"),c.classList.toggle("active")},l==null||l.appendChild(c)}a||(r.dataset.type="error")}else this.addStep(e,t.success!==!1?"completed":"failed",t);this.updateCounts(),this.applyFilter(),this.updateEmptyStates()}addEvent(e){var a;const t=document.createElement("div"),s=this.getEventType(e),r=typeof e.summary=="string"?e.summary:this.formatMetrics(e);t.className=`debug-event type-${s}`,t.dataset.filter="event",t.dataset.type=s,t.innerHTML=`
            <div class="debug-item-header">
                <span class="event-time">${this.formatRelativeTime(e.timestamp||Date.now())}</span>
                <span class="event-badge">${s.toUpperCase()}</span>
                <div class="event-title"><strong>${e.type}</strong></div>
                <button class="detail-toggle">JSON</button>
            </div>
            <div class="debug-item-detail hidden">
                ${r?`<div class="event-summary">${r}</div>`:""}
                <pre>${this.formatData(e)}</pre>
            </div>
        `,(a=t.querySelector(".detail-toggle"))==null||a.addEventListener("click",i=>{const o=t.querySelector(".debug-item-detail");o==null||o.classList.toggle("hidden"),i.target.classList.toggle("active")}),this.options.eventsContainer.appendChild(t),this.options.eventsContainer.scrollTop=this.options.eventsContainer.scrollHeight,this.updateCounts(),this.applyFilter(),this.updateEmptyStates()}clear(){this.options.stepsList.innerHTML="",this.options.eventsContainer.innerHTML="",this.counts={all:0,step:0,event:0,error:0},this.updateCounts(),this.updateEmptyStates()}getCounts(){return{...this.counts}}exportLogs(){const e={timestamp:new Date().toISOString(),steps:Array.from(this.options.stepsList.children).map(a=>{var i,o,l;return{text:(o=(i=a.querySelector(".debug-item-title"))==null?void 0:i.textContent)==null?void 0:o.trim(),data:(l=a.querySelector("pre"))==null?void 0:l.textContent}}),events:Array.from(this.options.eventsContainer.children).map(a=>{var i,o,l;return{type:(i=a.querySelector(".event-title strong"))==null?void 0:i.textContent,time:(o=a.querySelector(".event-time"))==null?void 0:o.textContent,data:(l=a.querySelector("pre"))==null?void 0:l.textContent}})},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`debug-logs-${Date.now()}.json`,r.click(),URL.revokeObjectURL(s)}applyFilter(){[...Array.from(this.options.stepsList.children),...Array.from(this.options.eventsContainer.children)].forEach(t=>{var a;const s=this.activeFilter==="all"||this.activeFilter==="error"&&t.dataset.type==="error"||t.dataset.filter===this.activeFilter,r=!this.searchQuery||((a=t.textContent)==null?void 0:a.toLowerCase().includes(this.searchQuery));t.style.display=s&&r?"":"none"})}updateCounts(){this.counts.step=this.options.stepsList.children.length,this.counts.event=this.options.eventsContainer.children.length,this.counts.all=this.counts.step+this.counts.event,this.counts.error=document.querySelectorAll('.debug-drawer [data-type="error"]').length,this.notifyCountsChange(),this.options.filterButtons.forEach(e=>{const t=e.dataset.filter,s=e.querySelector(".count");t&&s&&(s.textContent=String(this.counts[t]))})}updateEmptyStates(){this.options.stepsEmpty&&this.options.stepsEmpty.classList.toggle("hidden",this.counts.step>0),this.options.eventsEmpty&&this.options.eventsEmpty.classList.toggle("hidden",this.counts.event>0)}notifyCountsChange(){var e,t;(t=(e=this.options).onCountsChange)==null||t.call(e,{...this.counts})}getEventType(e){var s;const t=((s=e.type)==null?void 0:s.toLowerCase())||"";return t.includes("error")||t.includes("fail")?"error":t.includes("complete")||t.includes("success")?"success":t.includes("warn")?"warning":"info"}formatRelativeTime(e){const t=Math.floor((Date.now()-e)/1e3);if(t<5)return"now";if(t<60)return`${t}s`;const s=Math.floor(t/60);return s<60?`${s}m`:new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})}formatData(e){try{return JSON.stringify(e,null,2)}catch{return String(e)}}formatMetrics(e){var r;const t=[];typeof e.duration=="number"&&t.push(`${(e.duration/1e3).toFixed(2)}s`);const s=((r=e.usage)==null?void 0:r.totalTokens)??e.totalTokens;return typeof s=="number"&&t.push(`${s.toLocaleString()} tokens`),t.length?t.join(" • "):null}}class Xa{constructor(e,t,s){u(this,"tempSettings");u(this,"selectedProvider","lm-studio");this.modal=e,this.onSave=s,t.forEach(r=>{r.addEventListener("click",()=>{const a=r.getAttribute("data-provider");this.selectedProvider=a||"lm-studio",this.updateProviderSelection(t)})})}open(e){this.tempSettings=JSON.parse(JSON.stringify(e)),this.selectedProvider=e.provider,this.populateForm(),this.updateProviderSelection(),this.updateModelDatalist(),this.modal.classList.remove("hidden")}close(){this.modal.classList.add("hidden")}save(){var e;if(this.tempSettings){if(this.tempSettings.provider=this.selectedProvider,this.tempSettings.lmStudio.baseURL=document.getElementById("lm-studio-url").value||"http://127.0.0.1:6354",this.tempSettings.lmStudio.model=document.getElementById("lm-studio-model").value||"mistralai/ministral-3-14b-reasoning",this.tempSettings.lmStudio.model&&ha(this.tempSettings.lmStudio.model),this.tempSettings.gemini.apiKey=document.getElementById("gemini-api-key").value,this.tempSettings.gemini.model=document.getElementById("gemini-model").value,this.tempSettings.openai.apiKey=document.getElementById("openai-api-key").value,this.tempSettings.openai.baseURL=document.getElementById("openai-base-url").value||"https://api.openai.com",this.tempSettings.openai.model=document.getElementById("openai-model").value,this.selectedProvider==="gemini"&&!this.tempSettings.gemini.apiKey){alert("Please enter your Gemini API key");return}if(this.selectedProvider==="openai"&&!this.tempSettings.openai.apiKey){alert("Please enter your OpenAI API key");return}(e=this.onSave)==null||e.call(this,this.tempSettings),this.close()}}populateForm(){this.tempSettings&&(document.getElementById("lm-studio-url").value=this.tempSettings.lmStudio.baseURL,document.getElementById("lm-studio-model").value=this.tempSettings.lmStudio.model,document.getElementById("gemini-api-key").value=this.tempSettings.gemini.apiKey,document.getElementById("gemini-model").value=this.tempSettings.gemini.model,document.getElementById("openai-api-key").value=this.tempSettings.openai.apiKey,document.getElementById("openai-base-url").value=this.tempSettings.openai.baseURL,document.getElementById("openai-model").value=this.tempSettings.openai.model)}updateProviderSelection(e){(e||document.querySelectorAll(".provider-btn")).forEach(r=>{r.getAttribute("data-provider")===this.selectedProvider?(r.classList.add("border-accent","bg-accent/10"),r.classList.remove("border-white/10")):(r.classList.remove("border-accent","bg-accent/10"),r.classList.add("border-white/10"))});const s={"lm-studio":document.getElementById("lm-studio-settings"),gemini:document.getElementById("gemini-settings"),openai:document.getElementById("openai-settings")};Object.entries(s).forEach(([r,a])=>{a&&a.classList.toggle("hidden",r!==this.selectedProvider)})}updateModelDatalist(){const e=document.getElementById("lm-studio-model-history");if(!e)return;const t=Qs();e.innerHTML=t.map(s=>`<option value="${s}">`).join("")}}class ei{constructor(e,t){this.container=e,this.callbacks=t}render(e,t){if(this.container){if(e.length===0){this.container.innerHTML=`
                <div class="history-empty">
                    No conversations yet
                </div>
            `;return}this.container.innerHTML=e.map(s=>`
            <div class="history-item ${s.id===t?"active":""}" data-id="${s.id}">
                <span class="history-dot"></span>
                <span class="history-item-title">${this.escapeHtml(s.title)}</span>
                <div class="history-item-actions">
                    <button class="icon-btn xs rename-conv-btn" title="Rename" data-id="${s.id}">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20h9"></path>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                        </svg>
                    </button>
                    <button class="icon-btn xs delete-conv-btn" title="Delete" data-id="${s.id}">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </div>
            </div>
        `).join(""),this.bindEvents(e)}}bindEvents(e){this.container&&(this.container.querySelectorAll(".history-item").forEach(t=>{t.addEventListener("click",s=>{var i,o;if(s.target.closest(".history-item-actions"))return;const a=t.dataset.id;a&&((o=(i=this.callbacks).onSelect)==null||o.call(i,a))})}),this.container.querySelectorAll(".delete-conv-btn").forEach(t=>{t.addEventListener("click",s=>{var a,i;s.stopPropagation();const r=t.dataset.id;r&&((i=(a=this.callbacks).onDelete)==null||i.call(a,r))})}),this.container.querySelectorAll(".rename-conv-btn").forEach(t=>{t.addEventListener("click",s=>{var o,l;s.stopPropagation();const r=t.dataset.id;if(!r)return;const a=e.find(c=>c.id===r),i=prompt("Rename conversation:",a==null?void 0:a.title);i&&i.trim()&&((l=(o=this.callbacks).onRename)==null||l.call(o,r,i.trim()))})}))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class ti{constructor(e,t){var s;this.container=e,this.scrollButton=t,this.container.addEventListener("scroll",()=>this.checkScroll()),(s=this.scrollButton)==null||s.addEventListener("click",()=>this.scrollToBottom()),this.checkScroll()}scrollToBottom(e="smooth"){this.container.scrollTo({top:this.container.scrollHeight,behavior:e})}isNearBottom(e=150){return this.container.scrollHeight-this.container.scrollTop-this.container.clientHeight<e}checkScroll(){var e;(e=this.scrollButton)==null||e.classList.toggle("hidden",this.isNearBottom())}}function lr(n){if(n==null)return"";if(typeof n=="string")return n;try{return JSON.stringify(n)}catch{return String(n)}}function si(n){const e=lr(n);return e.length<=4e3?e:`${e.slice(0,4e3)}...`}function ri(n,e){return n.length<=e?n:`${n.slice(0,e-3)}...`}function St(n){const e=Number.isFinite(n)?n:0;return`${Math.round(e*100)}%`}function rt(n){const e=Math.floor((Date.now()-n)/1e3);if(e<10)return"just now";if(e<60)return`${e}s ago`;const t=Math.floor(e/60);if(t<60)return`${t}m ago`;const s=Math.floor(t/60);return s<24?`${s}h ago`:`${Math.floor(s/24)}d ago`}function ne(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}function ni(n){return n.length?`<div class="memory-tags">${n.map(e=>`<span class="memory-tag">${ne(e)}</span>`).join("")}</div>`:""}function Rs(n,e){const t=n.metadata.tags||[],s=n.summary||lr(n.content),r=ri(s,180),a=St(n.metadata.importance),i=rt(n.metadata.lastAccessedAt),o=n.metadata.importanceLevel?` (${n.metadata.importanceLevel})`:"",l=n.metadata.source?` • ${ne(n.metadata.source)}`:"",c=ne(si(n.content)),d=e==="short"?`
            <button class="icon-btn xs" data-action="promote" data-id="${ne(n.id)}" title="Promote to long-term" aria-label="Promote to long-term">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19V5"></path>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
            </button>
            <button class="icon-btn xs" data-action="delete" data-id="${ne(n.id)}" title="Delete memory" aria-label="Delete memory">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        `:`
            <button class="icon-btn xs" data-action="delete" data-id="${ne(n.id)}" title="Delete memory" aria-label="Delete memory">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        `;return`
        <article class="memory-item">
            <div class="memory-item-header">
                <span class="memory-pill ${e}">${e==="short"?"Short-term":"Long-term"}</span>
                <span class="memory-id">${ne(n.id)}</span>
                <span class="memory-score">${a}${o}</span>
                <div class="memory-actions">
                    ${d}
                </div>
            </div>
            <div class="memory-item-body">
                <p class="memory-preview">${ne(r)}</p>
                ${ni(t)}
                <div class="memory-meta">Accessed ${i} • ${n.metadata.accessCount} reads${l}</div>
                <details class="memory-details">
                    <summary>Details</summary>
                    <div class="memory-detail-grid">
                        <div>Created: ${rt(n.metadata.createdAt)}</div>
                        <div>Last accessed: ${rt(n.metadata.lastAccessedAt)}</div>
                    </div>
                    <pre>${c}</pre>
                </details>
            </div>
        </article>
    `}class ai{constructor(e){u(this,"callbacks",{});u(this,"snapshot",{shortTerm:[],longTerm:[]});u(this,"activeScope","all");u(this,"searchQuery","");u(this,"refreshToken",0);u(this,"searchTimer");u(this,"searchInput");u(this,"filterButtons");u(this,"shortSection");u(this,"longSection");u(this,"shortList");u(this,"longList");u(this,"shortEmpty");u(this,"longEmpty");u(this,"shortCount");u(this,"longCount");u(this,"refreshBtn");u(this,"addToggleBtn");u(this,"addForm");u(this,"addBtn");u(this,"addCancelBtn");u(this,"scopeSelect");u(this,"contentInput");u(this,"tagsInput");u(this,"importanceInput");u(this,"importanceValue");u(this,"clearShortBtn");u(this,"clearLongBtn");u(this,"consolidateBtn");this.drawer=e,this.searchInput=e.querySelector("#memory-search-input"),this.filterButtons=e.querySelectorAll(".memory-filter"),this.shortSection=e.querySelector('[data-scope-section="short"]'),this.longSection=e.querySelector('[data-scope-section="long"]'),this.shortList=e.querySelector("#memory-short-list"),this.longList=e.querySelector("#memory-long-list"),this.shortEmpty=e.querySelector("#memory-short-empty"),this.longEmpty=e.querySelector("#memory-long-empty"),this.shortCount=e.querySelector("#memory-short-count"),this.longCount=e.querySelector("#memory-long-count"),this.refreshBtn=e.querySelector("#memory-refresh-btn"),this.addToggleBtn=e.querySelector("#memory-add-toggle"),this.addForm=e.querySelector("#memory-add-form"),this.addBtn=e.querySelector("#memory-add-btn"),this.addCancelBtn=e.querySelector("#memory-add-cancel"),this.scopeSelect=e.querySelector("#memory-scope-select"),this.contentInput=e.querySelector("#memory-content-input"),this.tagsInput=e.querySelector("#memory-tags-input"),this.importanceInput=e.querySelector("#memory-importance-input"),this.importanceValue=e.querySelector("#memory-importance-value"),this.clearShortBtn=e.querySelector("#memory-clear-short-btn"),this.clearLongBtn=e.querySelector("#memory-clear-long-btn"),this.consolidateBtn=e.querySelector("#memory-consolidate-btn"),this.bindEvents()}setCallbacks(e){this.callbacks=e}async refresh(e){if(!this.callbacks.onRefresh)return;const t=++this.refreshToken;this.setLoading(!0);try{const s=await this.callbacks.onRefresh(e??this.searchQuery);if(t!==this.refreshToken)return;this.snapshot=s,this.render()}catch(s){console.error("[MemoryPanel] Refresh failed:",s)}finally{t===this.refreshToken&&this.setLoading(!1)}}bindEvents(){var e,t,s,r,a,i,o,l,c,d,p;this.filterButtons.forEach(h=>{h.addEventListener("click",()=>{const m=h.dataset.scope;this.activeScope=m||"all",this.filterButtons.forEach(g=>g.classList.remove("active")),h.classList.add("active"),this.applyScopeFilter()})}),(e=this.searchInput)==null||e.addEventListener("input",()=>{var h;this.searchQuery=((h=this.searchInput)==null?void 0:h.value.trim().toLowerCase())||"",this.queueRefresh()}),(t=this.refreshBtn)==null||t.addEventListener("click",()=>this.refresh()),(s=this.addToggleBtn)==null||s.addEventListener("click",()=>{var m,g,y;const h=!((m=this.addForm)!=null&&m.classList.contains("hidden"));(g=this.addForm)==null||g.classList.toggle("hidden",h),(y=this.addToggleBtn)==null||y.classList.toggle("active",!h)}),(r=this.addCancelBtn)==null||r.addEventListener("click",()=>this.resetForm(!0)),(a=this.addBtn)==null||a.addEventListener("click",()=>this.handleAdd()),(i=this.importanceInput)==null||i.addEventListener("input",()=>{!this.importanceValue||!this.importanceInput||(this.importanceValue.textContent=St(parseFloat(this.importanceInput.value)))}),(o=this.clearShortBtn)==null||o.addEventListener("click",()=>this.handleClear("short")),(l=this.clearLongBtn)==null||l.addEventListener("click",()=>this.handleClear("long")),(c=this.consolidateBtn)==null||c.addEventListener("click",()=>this.handleConsolidate()),(d=this.shortList)==null||d.addEventListener("click",h=>this.handleListAction(h,"short")),(p=this.longList)==null||p.addEventListener("click",h=>this.handleListAction(h,"long"))}async handleAdd(){var a,i;if(!this.callbacks.onAdd||!this.contentInput||!this.scopeSelect)return;const e=this.contentInput.value.trim();if(!e){alert("Please enter memory content.");return}const t=this.scopeSelect.value==="long"?"long":"short",s=this.parseTags(((a=this.tagsInput)==null?void 0:a.value)||""),r=parseFloat(((i=this.importanceInput)==null?void 0:i.value)||"0.5");try{await this.callbacks.onAdd({scope:t,content:e,tags:s,importance:r}),this.resetForm(),await this.refresh()}catch(o){console.error("[MemoryPanel] Add failed:",o),alert("Failed to add memory. Check console for details.")}}async handleClear(e){!this.callbacks.onClear||!confirm(`Clear all ${e==="short"?"short-term":"long-term"} memory?`)||(await this.callbacks.onClear(e),await this.refresh())}async handleConsolidate(){this.callbacks.onConsolidate&&(await this.callbacks.onConsolidate(),await this.refresh())}async handleListAction(e,t){const s=e.target,r=s==null?void 0:s.closest("button[data-action]");if(!r)return;const a=r.dataset.action,i=r.dataset.id;if(!(!a||!i)){if(a==="delete"&&this.callbacks.onDelete){if(!confirm("Delete this memory item?"))return;await this.callbacks.onDelete(t,i),await this.refresh()}a==="promote"&&this.callbacks.onPromote&&(await this.callbacks.onPromote(i),await this.refresh())}}render(){var s,r;const e=this.snapshot.shortTerm||[],t=this.snapshot.longTerm||[];this.shortList&&(this.shortList.innerHTML=e.map(a=>Rs(a,"short")).join("")),this.longList&&(this.longList.innerHTML=t.map(a=>Rs(a,"long")).join("")),(s=this.shortEmpty)==null||s.classList.toggle("hidden",e.length>0),(r=this.longEmpty)==null||r.classList.toggle("hidden",t.length>0),this.updateCounts(e.length,t.length),this.applyScopeFilter()}applyScopeFilter(){var s,r;const e=this.activeScope==="all"||this.activeScope==="short",t=this.activeScope==="all"||this.activeScope==="long";(s=this.shortSection)==null||s.classList.toggle("hidden",!e),(r=this.longSection)==null||r.classList.toggle("hidden",!t)}updateCounts(e,t){const s=e+t;this.filterButtons.forEach(r=>{const a=r.dataset.scope,i=r.querySelector(".count");i&&(a==="short"?i.textContent=String(e):a==="long"?i.textContent=String(t):i.textContent=String(s))}),this.shortCount&&(this.shortCount.textContent=String(e)),this.longCount&&(this.longCount.textContent=String(t))}setLoading(e){this.drawer.setAttribute("aria-busy",String(e)),this.drawer.classList.toggle("is-loading",e)}queueRefresh(){window.clearTimeout(this.searchTimer),this.searchTimer=window.setTimeout(()=>this.refresh(),250)}resetForm(e){var t,s;this.contentInput&&(this.contentInput.value=""),this.tagsInput&&(this.tagsInput.value=""),this.importanceInput&&(this.importanceInput.value="0.5"),this.importanceValue&&(this.importanceValue.textContent=St(.5)),e&&((t=this.addForm)==null||t.classList.add("hidden"),(s=this.addToggleBtn)==null||s.classList.remove("active"))}parseTags(e){return e.split(",").map(t=>t.trim()).filter(Boolean)}}class ii{constructor(e,t){u(this,"graph",null);u(this,"svg",null);u(this,"nodeEls",new Map);u(this,"statusMap",new Map);this.container=e,this.emptyState=t}setGraph(e){this.graph=e,this.render()}reset(){this.statusMap.clear(),this.nodeEls.forEach(e=>e.setAttribute("data-status","idle"))}handleEvent(e){if(e.nodeId){if(e.type==="node_start"){this.updateNodeStatus(e.nodeId,"running");return}if(e.type==="node_end"){const t=e.status==="success"?"success":e.status==="failure"?"failure":e.status==="warning"?"warning":"idle";this.updateNodeStatus(e.nodeId,t)}}}updateNodeStatus(e,t){this.statusMap.set(e,t);const s=this.nodeEls.get(e);s&&s.setAttribute("data-status",t)}render(){if(this.container.innerHTML="",this.nodeEls.clear(),!this.graph||this.graph.nodes.length===0){this.container.classList.add("hidden"),this.emptyState.classList.remove("hidden");return}this.emptyState.classList.add("hidden"),this.container.classList.remove("hidden");const e=this.buildLayout(this.graph),t=280,s=Math.max(200,e.length*80+30),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox",`0 0 ${t} ${s}`),r.setAttribute("width","100%"),r.setAttribute("height",String(s)),r.classList.add("graph-svg"),this.svg=r,r.appendChild(this.buildDefs()),this.renderEdges(r,e),this.renderNodes(r,e),this.container.appendChild(r)}buildLayout(e){return e.nodes.map((a,i)=>{const l=20+i*70;return{id:a.id,name:a.name,x:60,y:l}})}buildDefs(){const e=document.createElementNS("http://www.w3.org/2000/svg","defs"),t=document.createElementNS("http://www.w3.org/2000/svg","marker");t.setAttribute("id","graph-arrow"),t.setAttribute("viewBox","0 0 10 10"),t.setAttribute("refX","8"),t.setAttribute("refY","5"),t.setAttribute("markerWidth","6"),t.setAttribute("markerHeight","6"),t.setAttribute("orient","auto");const s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),s.setAttribute("fill","currentColor"),t.appendChild(s),e.appendChild(t),e}renderEdges(e,t){const s=new Map(t.map(i=>[i.id,i])),r=160,a=36;for(const i of this.graph.edges){const o=s.get(i.from),l=s.get(i.to);if(!o||!l)continue;const c=o.x+r/2,d=o.y+a,p=l.x+r/2,h=l.y,m=document.createElementNS("http://www.w3.org/2000/svg","path"),g=(d+h)/2,y=`M ${c} ${d} C ${c} ${g} ${p} ${g} ${p} ${h}`;m.setAttribute("d",y),m.setAttribute("class","graph-edge"),m.setAttribute("marker-end","url(#graph-arrow)"),i.condition&&m.classList.add("graph-edge-conditional"),e.appendChild(m)}}renderNodes(e,t){for(const a of t){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","graph-node"),i.setAttribute("data-status",this.statusMap.get(a.id)??"idle");const o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",String(a.x)),o.setAttribute("y",String(a.y)),o.setAttribute("width",String(160)),o.setAttribute("height",String(36)),o.setAttribute("rx","10"),o.setAttribute("ry","10"),o.setAttribute("class","graph-node-rect");const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",String(a.x+160/2)),l.setAttribute("y",String(a.y+36/2+4)),l.setAttribute("text-anchor","middle"),l.setAttribute("class","graph-node-label"),l.textContent=a.name,i.appendChild(o),i.appendChild(l),e.appendChild(i),this.nodeEls.set(a.id,i)}}}class oi{constructor(e){u(this,"metrics",{duration:0,tokens:0,toolCalls:0,errors:0,audits:0,memorySaves:0,memoryRecalls:0});u(this,"elements");this.container=e,this.elements={duration:this.getEl("dashboard-duration"),tokens:this.getEl("dashboard-tokens"),toolCalls:this.getEl("dashboard-toolcalls"),errors:this.getEl("dashboard-errors"),audits:this.getEl("dashboard-audit"),memorySaves:this.getEl("dashboard-mem-save"),memoryRecalls:this.getEl("dashboard-mem-recall")},this.render()}reset(){this.metrics={duration:0,tokens:0,toolCalls:0,errors:0,audits:0,memorySaves:0,memoryRecalls:0},this.render()}handleEvent(e){if(e.type==="health_metrics"&&e.metadata){const t=e.metadata;this.metrics.duration=this.asNumber(t.totalDurationMs,this.metrics.duration),this.metrics.tokens=this.asNumber(t.tokenCount,this.metrics.tokens),this.metrics.toolCalls=this.asNumber(t.toolCallCount,this.metrics.toolCalls),this.metrics.errors=this.asNumber(t.errorCount,this.metrics.errors),this.render();return}e.type==="tool_call"&&(this.metrics.toolCalls+=1),e.type==="error"&&(this.metrics.errors+=1),e.type==="audit"&&(this.metrics.audits+=1),e.type==="memory_save"&&(this.metrics.memorySaves+=1),e.type==="memory_recall"&&(this.metrics.memoryRecalls+=1),this.render()}render(){this.elements.duration.textContent=this.formatMs(this.metrics.duration),this.elements.tokens.textContent=this.formatNumber(this.metrics.tokens),this.elements.toolCalls.textContent=this.formatNumber(this.metrics.toolCalls),this.elements.errors.textContent=this.formatNumber(this.metrics.errors),this.elements.audits.textContent=this.formatNumber(this.metrics.audits),this.elements.memorySaves.textContent=this.formatNumber(this.metrics.memorySaves),this.elements.memoryRecalls.textContent=this.formatNumber(this.metrics.memoryRecalls)}formatNumber(e){return e.toLocaleString()}formatMs(e){return e?e<1e3?`${e} ms`:`${(e/1e3).toFixed(2)} s`:"0 ms"}asNumber(e,t){return typeof e=="number"&&!Number.isNaN(e)?e:t}getEl(e){const t=this.container.querySelector(`#${e}`);if(!t)throw new Error(`Dashboard element not found: ${e}`);return t}}class li{constructor(){u(this,"sidebar");u(this,"debugDrawer");u(this,"debugOverlay");u(this,"dashboardDrawer");u(this,"dashboardOverlay");u(this,"memoryDrawer");u(this,"memoryOverlay");u(this,"chatContainer");u(this,"messagesList");u(this,"userInput");u(this,"sendBtn");u(this,"welcomeScreen");u(this,"stepsList");u(this,"eventsContainer");u(this,"scrollBottomBtn");u(this,"currentProviderEl");u(this,"currentModelEl");u(this,"modelLatencyEl");u(this,"streamStatusText");u(this,"settingsModal");u(this,"sidebarOverlay");u(this,"promptLibraryPanel");u(this,"promptLibraryBtn");u(this,"closePromptLibraryBtn");u(this,"stopBtn");u(this,"composerHint");u(this,"debugBadge");u(this,"memoryToggleBtn");u(this,"dashboardToggleBtn");u(this,"moreActionsWrapper");u(this,"moreActionsBtn");u(this,"unreadDebugEvents",0);u(this,"isPromptLibraryOpen",!1);u(this,"messageView");u(this,"sidebarManager");u(this,"debugConsole");u(this,"memoryPanel");u(this,"settingsPanel");u(this,"historyView");u(this,"chatViewport");u(this,"graphViewer");u(this,"dashboardPanel");u(this,"onSendMessage");u(this,"onNewChat");u(this,"onSettingsSave");u(this,"onStreamToggle");u(this,"onConversationSelect");u(this,"onConversationDelete");u(this,"onConversationRename");var s,r,a,i;this.sidebar=document.getElementById("sidebar"),this.debugDrawer=document.getElementById("debug-drawer"),this.debugOverlay=document.getElementById("debug-overlay"),this.dashboardDrawer=document.getElementById("dashboard-drawer"),this.dashboardOverlay=document.getElementById("dashboard-overlay"),this.memoryDrawer=document.getElementById("memory-drawer"),this.memoryOverlay=document.getElementById("memory-overlay"),this.chatContainer=document.getElementById("chat-container"),this.messagesList=document.getElementById("messages-list"),this.userInput=document.getElementById("user-input"),this.sendBtn=document.getElementById("send-btn"),this.welcomeScreen=document.getElementById("welcome-screen"),this.stepsList=document.getElementById("steps-list"),this.eventsContainer=document.getElementById("events-container"),this.scrollBottomBtn=document.getElementById("scroll-bottom-btn"),this.currentProviderEl=document.getElementById("current-provider"),this.currentModelEl=document.getElementById("current-model"),this.modelLatencyEl=document.getElementById("model-latency"),this.streamStatusText=document.getElementById("stream-status-text"),this.settingsModal=document.getElementById("settings-modal"),this.sidebarOverlay=document.getElementById("sidebar-overlay"),this.promptLibraryPanel=document.getElementById("prompt-library-panel"),this.promptLibraryBtn=document.getElementById("prompt-library-btn"),this.closePromptLibraryBtn=document.getElementById("close-prompt-library-btn"),this.stopBtn=document.getElementById("stop-btn"),this.composerHint=document.getElementById("composer-hint"),this.debugBadge=document.getElementById("debug-badge"),this.memoryToggleBtn=document.getElementById("toggle-memory-btn"),this.dashboardToggleBtn=document.getElementById("toggle-dashboard-btn"),this.moreActionsWrapper=document.getElementById("top-actions-overflow"),this.moreActionsBtn=document.getElementById("more-actions-btn"),(s=this.promptLibraryBtn)==null||s.setAttribute("aria-expanded","false"),(r=this.memoryToggleBtn)==null||r.setAttribute("aria-expanded","false"),(a=this.dashboardToggleBtn)==null||a.setAttribute("aria-expanded","false"),(i=this.moreActionsBtn)==null||i.setAttribute("aria-expanded","false");const e=document.getElementById("graph-viewer"),t=document.getElementById("graph-empty");this.messageView=new Qa(this.messagesList),this.sidebarManager=new Ja(this.sidebar,this.sidebarOverlay),document.documentElement.classList.remove("sidebar-will-collapse","sidebar-will-hide"),this.chatViewport=new ti(this.chatContainer,this.scrollBottomBtn),this.debugConsole=new Ya({stepsList:this.stepsList,eventsContainer:this.eventsContainer,filterButtons:this.debugDrawer.querySelectorAll(".filter-tab"),searchInput:document.getElementById("debug-search-input"),stepsEmpty:document.getElementById("steps-empty"),eventsEmpty:document.getElementById("events-empty"),onCountsChange:o=>this.handleDebugCountsChange(o)}),this.memoryPanel=new ai(this.memoryDrawer),this.dashboardPanel=new oi(this.dashboardDrawer),this.settingsPanel=new Xa(this.settingsModal,document.querySelectorAll(".provider-btn"),o=>{var l;return(l=this.onSettingsSave)==null?void 0:l.call(this,o)}),this.historyView=new ei(document.getElementById("history-list"),{onSelect:o=>{var l;return(l=this.onConversationSelect)==null?void 0:l.call(this,o)},onDelete:o=>{var l;return(l=this.onConversationDelete)==null?void 0:l.call(this,o)},onRename:(o,l)=>{var c;return(c=this.onConversationRename)==null?void 0:c.call(this,o,l)}}),this.graphViewer=new ii(e,t),this.restoreHintState(),this.updateDebugBadge(0),this.bindCoreEvents(),this.updateProviderDisplay()}setCallbacks(e){Object.assign(this,e)}setMemoryCallbacks(e){this.memoryPanel.setCallbacks(e)}bindCoreEvents(){var h,m,g,y,w,R,$,D,q,K,B,Z,re,Se,me,Nt,zt,jt,qt,Zt,Ut,Ft,Vt,Ht,Gt,Wt,Kt;this.userInput.addEventListener("input",()=>{this.userInput.style.height="auto",this.userInput.style.height=Math.min(this.userInput.scrollHeight,200)+"px";const C=L.getState();this.sendBtn.disabled=this.userInput.value.trim().length===0||C.isGenerating}),this.userInput.addEventListener("keydown",C=>{C.key==="Enter"&&!C.shiftKey&&(C.preventDefault(),this.handleSend())}),this.sendBtn.addEventListener("click",()=>this.handleSend()),(h=this.stopBtn)==null||h.addEventListener("click",()=>{var C;return(C=this.onStopGeneration)==null?void 0:C.call(this)}),(m=document.getElementById("toggle-sidebar-btn"))==null||m.addEventListener("click",()=>this.sidebarManager.toggle()),(g=document.getElementById("mobile-menu-btn"))==null||g.addEventListener("click",()=>this.sidebarManager.toggle());const e=document.getElementById("debug-search-input"),t=()=>{this.setMoreActionsOpen(!1),!this.isDebugDrawerOpen()&&(this.isMemoryDrawerOpen()&&this.setMemoryDrawerOpen(!1),this.setDebugDrawerOpen(!0),this.unreadDebugEvents=0,this.updateDebugBadge(0))},s=()=>{this.isDebugDrawerOpen()&&this.setDebugDrawerOpen(!1)},r=()=>{if(this.setMoreActionsOpen(!1),this.isDebugDrawerOpen()){this.setDebugDrawerOpen(!1);return}this.isDashboardDrawerOpen()&&this.setDashboardDrawerOpen(!1),this.isMemoryDrawerOpen()&&this.setMemoryDrawerOpen(!1),this.setDebugDrawerOpen(!0),this.unreadDebugEvents=0,this.updateDebugBadge(0)};(y=document.getElementById("toggle-debug-btn"))==null||y.addEventListener("click",r),(w=document.getElementById("close-debug-btn"))==null||w.addEventListener("click",s),(R=this.debugOverlay)==null||R.addEventListener("click",s);const a=()=>{if(this.setMoreActionsOpen(!1),this.isDashboardDrawerOpen()){this.setDashboardDrawerOpen(!1);return}this.isDebugDrawerOpen()&&this.setDebugDrawerOpen(!1),this.isMemoryDrawerOpen()&&this.setMemoryDrawerOpen(!1),this.setDashboardDrawerOpen(!0)},i=()=>{this.isDashboardDrawerOpen()&&this.setDashboardDrawerOpen(!1)};($=this.dashboardToggleBtn)==null||$.addEventListener("click",a),(D=document.getElementById("close-dashboard-btn"))==null||D.addEventListener("click",i),(q=this.dashboardOverlay)==null||q.addEventListener("click",i);const o=()=>{if(this.setMoreActionsOpen(!1),this.isMemoryDrawerOpen()){this.setMemoryDrawerOpen(!1);return}this.isDashboardDrawerOpen()&&this.setDashboardDrawerOpen(!1),this.isDebugDrawerOpen()&&this.setDebugDrawerOpen(!1),this.setMemoryDrawerOpen(!0),this.memoryPanel.refresh()},l=()=>{this.isMemoryDrawerOpen()&&this.setMemoryDrawerOpen(!1)};(K=this.memoryToggleBtn)==null||K.addEventListener("click",o),(B=document.getElementById("close-memory-btn"))==null||B.addEventListener("click",l),(Z=this.memoryOverlay)==null||Z.addEventListener("click",l);const c=C=>{C==null||C.stopPropagation(),this.setMoreActionsOpen(!this.isMoreActionsOpen())};(re=this.moreActionsBtn)==null||re.addEventListener("click",c),document.addEventListener("click",C=>{var pe;this.isMoreActionsOpen()&&((pe=this.moreActionsWrapper)!=null&&pe.contains(C.target)||this.setMoreActionsOpen(!1))});const d=()=>{var C;L.getState().isGenerating||((C=this.onNewChat)==null||C.call(this),window.innerWidth<768&&this.sidebarManager.close())};(Se=document.getElementById("new-chat-btn"))==null||Se.addEventListener("click",d),(me=this.promptLibraryBtn)==null||me.addEventListener("click",()=>{var C;this.togglePromptLibrary(),(C=this.onPromptLibrary)==null||C.call(this)}),(Nt=this.closePromptLibraryBtn)==null||Nt.addEventListener("click",()=>this.togglePromptLibrary(!1)),(zt=document.getElementById("attach-btn"))==null||zt.addEventListener("click",()=>this.flashHint()),(jt=document.getElementById("dismiss-hint-btn"))==null||jt.addEventListener("click",()=>this.dismissHint());let p;window.addEventListener("resize",()=>{clearTimeout(p),p=setTimeout(()=>{this.chatViewport.checkScroll(),this.sidebarManager.applyState(),this.setMoreActionsOpen(!1)},150)}),(qt=document.getElementById("settings-btn"))==null||qt.addEventListener("click",()=>this.openSettings()),(Zt=document.getElementById("model-selector"))==null||Zt.addEventListener("click",()=>this.openSettings()),(Ut=document.getElementById("close-settings-btn"))==null||Ut.addEventListener("click",()=>this.settingsPanel.close()),(Ft=document.getElementById("cancel-settings-btn"))==null||Ft.addEventListener("click",()=>this.settingsPanel.close()),(Vt=document.getElementById("settings-overlay"))==null||Vt.addEventListener("click",()=>this.settingsPanel.close()),(Ht=document.getElementById("save-settings-btn"))==null||Ht.addEventListener("click",()=>this.settingsPanel.save()),(Gt=document.getElementById("stream-toggle-btn"))==null||Gt.addEventListener("click",()=>{var C;return(C=this.onStreamToggle)==null?void 0:C.call(this)}),document.addEventListener("keydown",C=>{var xe;const pe=C.key.toLowerCase();if((C.metaKey||C.ctrlKey)&&pe==="k"){C.preventDefault(),t(),e==null||e.focus(),e==null||e.select();return}if((C.metaKey||C.ctrlKey)&&pe==="n"){C.preventDefault(),d();return}if(C.key==="Escape"){if(L.getState().isGenerating){(xe=this.onStopGeneration)==null||xe.call(this);return}if(this.isMoreActionsOpen()){this.setMoreActionsOpen(!1);return}if(this.isPromptLibraryOpen){this.togglePromptLibrary(!1);return}if(this.isMemoryDrawerOpen()){this.setMemoryDrawerOpen(!1);return}if(this.isDebugDrawerOpen()){this.setDebugDrawerOpen(!1);return}this.settingsModal.classList.contains("hidden")||this.settingsPanel.close(),window.innerWidth<768&&this.sidebarManager.close()}}),document.querySelectorAll(".prompt-card").forEach(C=>{C.addEventListener("click",()=>{if(L.getState().isGenerating)return;const xe=C.dataset.prompt;xe&&(this.userInput.value=xe,this.userInput.dispatchEvent(new Event("input")),this.togglePromptLibrary(!1),this.handleSend())})}),(Wt=document.getElementById("clear-debug-btn"))==null||Wt.addEventListener("click",()=>{confirm("Clear all debug logs?")&&(this.debugConsole.clear(),this.unreadDebugEvents=0,this.updateDebugBadge(0))}),(Kt=document.getElementById("export-btn"))==null||Kt.addEventListener("click",()=>{this.debugConsole.exportLogs()})}async handleSend(){var s;const e=this.userInput.value.trim(),t=L.getState();!e||t.isGenerating||(this.togglePromptLibrary(!1),this.userInput.value="",this.userInput.style.height="auto",this.sendBtn.disabled=!0,await((s=this.onSendMessage)==null?void 0:s.call(this,e)))}openSettings(){const e=L.getState();this.settingsPanel.open(e.settings)}appendMessage(e,t){return this.messageView.appendMessage(e,t)}streamUpdate(e,t){this.messageView.streamUpdate(e,t)}updateMessage(e,t,s=!1,r){this.messageView.updateMessage(e,t,s,r)}hideWelcomeScreen(){this.welcomeScreen.classList.add("hidden")}scrollToBottom(e="smooth"){this.chatViewport.scrollToBottom(e)}getIsNearBottom(){return this.chatViewport.isNearBottom()}addDebugStep(e,t){this.debugConsole.addStep(e,t)}updateDebugStep(e,t){this.debugConsole.updateStep(e,t)}addDebugEvent(e){this.debugConsole.addEvent(e),this.graphViewer.handleEvent(e),this.dashboardPanel.handleEvent(e),this.debugDrawer.classList.contains("translate-x-full")&&(this.unreadDebugEvents+=1,this.updateDebugBadge(this.unreadDebugEvents))}setGraphDefinition(e){this.graphViewer.setGraph(e)}clearMessages(){this.messageView.clear(),this.debugConsole.clear(),this.graphViewer.reset(),this.dashboardPanel.reset(),this.welcomeScreen.classList.remove("hidden"),this.userInput.value="",this.togglePromptLibrary(!1),this.unreadDebugEvents=0,this.updateDebugBadge(0)}focusInput(){this.userInput.focus()}enableInput(){this.setGenerating(!1),this.userInput.focus()}updateProviderDisplay(){const e=L.getState();this.currentProviderEl&&(this.currentProviderEl.textContent=oa(e.settings.provider)),this.currentModelEl&&(this.currentModelEl.textContent=this.getActiveModelLabel(e.settings)),this.modelLatencyEl&&(this.modelLatencyEl.textContent=this.formatLatency(e.lastLatencyMs))}updateStreamToggle(e){const t=document.getElementById("stream-toggle-btn"),s=document.getElementById("stream-status-dot");this.streamStatusText&&(this.streamStatusText.textContent=e?"ON":"OFF"),t&&s&&(t.classList.toggle("active",e),s.classList.toggle("on",e))}renderHistoryList(e,t){this.historyView.render(e,t)}setGenerating(e){var s;const t=this.userInput.value.trim().length>0;this.sendBtn.disabled=e||!t,(s=this.stopBtn)==null||s.classList.toggle("hidden",!e),this.userInput.classList.toggle("is-generating",e),this.userInput.setAttribute("aria-busy",String(e)),e&&this.togglePromptLibrary(!1)}getActiveModelLabel(e){switch(e.provider){case"gemini":return e.gemini.model||"Gemini";case"openai":return e.openai.model||"OpenAI";case"lm-studio":default:return e.lmStudio.model||"LM Studio"}}formatLatency(e){return typeof e!="number"||e<=0?"-- ms":e<1e3?`${Math.round(e)} ms`:`${(e/1e3).toFixed(2)} s`}togglePromptLibrary(e){var s,r;if(!this.promptLibraryPanel)return;const t=e!==void 0?e:this.promptLibraryPanel.classList.contains("hidden");this.isPromptLibraryOpen=t,this.promptLibraryPanel.classList.toggle("hidden",!t),(s=this.promptLibraryBtn)==null||s.setAttribute("aria-expanded",String(t)),(r=this.promptLibraryBtn)==null||r.classList.toggle("active",t)}dismissHint(){document.body.classList.add("hint-dismissed"),localStorage.setItem("chatbox-hint-dismissed","1")}restoreHintState(){localStorage.getItem("chatbox-hint-dismissed")==="1"&&document.body.classList.add("hint-dismissed")}flashHint(){!this.composerHint||document.body.classList.contains("hint-dismissed")||(this.composerHint.classList.add("highlight"),setTimeout(()=>{var e;return(e=this.composerHint)==null?void 0:e.classList.remove("highlight")},1200))}setMemoryDrawerOpen(e){var t,s,r;this.memoryDrawer.classList.toggle("translate-x-full",!e),(t=this.memoryOverlay)==null||t.classList.toggle("active",e),(s=this.memoryToggleBtn)==null||s.classList.toggle("active",e),(r=this.memoryToggleBtn)==null||r.setAttribute("aria-expanded",String(e))}isMemoryDrawerOpen(){return!this.memoryDrawer.classList.contains("translate-x-full")}setDebugDrawerOpen(e){var t;this.debugDrawer.classList.toggle("translate-x-full",!e),(t=this.debugOverlay)==null||t.classList.toggle("active",e)}isDebugDrawerOpen(){return!this.debugDrawer.classList.contains("translate-x-full")}setDashboardDrawerOpen(e){var t,s,r;this.dashboardDrawer.classList.toggle("translate-x-full",!e),(t=this.dashboardOverlay)==null||t.classList.toggle("active",e),(s=this.dashboardToggleBtn)==null||s.classList.toggle("active",e),(r=this.dashboardToggleBtn)==null||r.setAttribute("aria-expanded",String(e))}isDashboardDrawerOpen(){return!this.dashboardDrawer.classList.contains("translate-x-full")}setMoreActionsOpen(e){!this.moreActionsWrapper||!this.moreActionsBtn||(this.moreActionsWrapper.classList.toggle("is-open",e),this.moreActionsBtn.setAttribute("aria-expanded",String(e)))}isMoreActionsOpen(){var e;return!!((e=this.moreActionsWrapper)!=null&&e.classList.contains("is-open"))}updateDebugBadge(e){this.debugBadge&&(this.debugBadge.textContent=String(e),this.debugBadge.classList.toggle("hidden",e<=0))}handleDebugCountsChange(e){e.event===0&&(this.unreadDebugEvents=0,this.updateDebugBadge(0))}}let X;const T=new li,ci=new sa,di=new Kn(128),F=na({persistenceAdapter:ci,summarizer:new Gs,pruningConfig:Et},void 0,di);async function ui(){hi(),mi(),await L.init(),Bt(),xi(),T.focusInput(),L.subscribe(e=>{T.updateStreamToggle(e.isStreamEnabled),T.updateProviderDisplay(),T.setGenerating(e.isGenerating),T.renderHistoryList(e.conversations,e.activeConversationId)});const n=L.getState();T.renderHistoryList(n.conversations,n.activeConversationId)}function hi(){T.setCallbacks({onSendMessage:_i,onNewChat:cr,onSettingsSave:Ai,onStreamToggle:Ri,onStopGeneration:Ti,onPromptLibrary:()=>T.focusInput(),onConversationSelect:Ei,onConversationDelete:Li,onConversationRename:Ii})}function mi(){T.setMemoryCallbacks({onRefresh:pi,onAdd:yi,onDelete:vi,onPromote:bi,onClear:ki,onConsolidate:wi})}async function pi(n){const e=(n==null?void 0:n.trim().toLowerCase())||"",t=F.shortTerm.query({sortBy:"lastAccessedAt",sortOrder:"desc"}),s=e?t.filter(a=>fi(a,e)):t,r=e?await F.longTerm.search(e,{limit:200}):await F.longTerm.query({sortBy:"lastAccessedAt",sortOrder:"desc",limit:200});return{shortTerm:s,longTerm:r}}function fi(n,e){const t=gi(n.content).toLowerCase(),s=(n.metadata.tags||[]).join(" ").toLowerCase();return t.includes(e)||s.includes(e)}function gi(n){if(n==null)return"";if(typeof n=="string")return n;try{return JSON.stringify(n)}catch{return String(n)}}async function yi(n){const e=n.tags.length>0?n.tags:void 0,t={importance:n.importance,tags:e};if(n.scope==="long"){await Promise.resolve(F.remember(n.content,{...t,longTerm:!0}));return}const s=`stm_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;F.shortTerm.set(s,n.content,t)}async function vi(n,e){if(n==="short"){F.shortTerm.delete(e);return}await F.longTerm.delete(e)}async function bi(n){await F.promoteToLongTerm(n)}async function ki(n){if(n==="short"){F.shortTerm.clear();return}await F.longTerm.clear()}async function wi(){await F.consolidate()}function Si(n){switch(n.provider){case"gemini":return{type:"gemini",apiKey:n.gemini.apiKey,model:n.gemini.model};case"openai":return{type:"openai",apiKey:n.openai.apiKey,baseURL:n.openai.baseURL,model:n.openai.model};case"lm-studio":default:return{type:"lm-studio",baseURL:n.lmStudio.baseURL,model:n.lmStudio.model}}}function Bt(){const n=L.getState(),e=Si(n.settings),t=Dn();X=Rn({provider:e,tools:t,mode:"auto",systemPrompt:"You are a helpful AI assistant. Respond in the same language as the user.",streaming:n.isStreamEnabled,memory:F,enableMemory:!0,enableChatMemory:!0,chatMemorySavePolicy:{saveUserPreferences:!0,saveConversationTurns:!0,saveIntentMessages:!0,minMessageLength:10},chatMemoryRecallPolicy:{limit:5,minImportance:.7},confirmTool:async s=>{const r=[s.confirmationMessage||"Tool execution requires confirmation.",`Tool: ${s.toolName}`,`Step: ${s.stepDescription}`].join(`
`);return{approved:window.confirm(r)}},hooks:{onNodeStart:s=>T.addDebugStep(s,"running"),onNodeEnd:(s,r)=>T.updateDebugStep(s,r)}}),X.getEventStream().on("*",s=>{T.addDebugEvent(s)}),T.setGraphDefinition(X.getGraphDefinition()??null),console.log("[Demo] Agent initialized with provider:",e.type),L.setState({lastLatencyMs:null,lastTokenCount:null})}function xi(){const n=L.getState();T.updateProviderDisplay(),T.updateStreamToggle(n.isStreamEnabled),T.setGenerating(n.isGenerating)}async function _i(n){var t;L.setState({isGenerating:!0}),T.hideWelcomeScreen(),T.appendMessage("user",n),T.scrollToBottom();const e=T.appendMessage("ai",'<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>');T.scrollToBottom();try{const s=L.getState();let r="";const a=await X.chat(n,{stream:s.isStreamEnabled,onStream:m=>{const g=T.getIsNearBottom();r+=m,T.streamUpdate(e,r),g&&T.scrollToBottom("auto")}}),i=((t=a.usage)==null?void 0:t.totalTokens)??null,o=a.duration/1e3,l=i!==null&&o>0?(i/o).toFixed(1):null,c=a.mode==="agent"?"🤖 Agent":"💬 Chat",p=[a.aborted?"Stopped":c,typeof i=="number"?`${i} tokens`:null,`${o.toFixed(2)}s`,l?`${l} t/s`:null].filter(Boolean).join(" • "),h=a.aborted?r||"Generation stopped.":a.content;if(a.aborted){const m=X.getHistory(),g=m[m.length-1];if(g&&g.role==="assistant"&&(g.content=h,X.setHistory(m)),h)try{await F.remember({user:n,assistant:h,interrupted:!0},{tags:["conversation-turn","interrupted"],importance:.6,longTerm:!1})}catch(y){console.warn("[Demo] Failed to save interrupted conversation to memory:",y)}}T.updateMessage(e,h,!1,p||void 0),L.setState({lastLatencyMs:a.duration,lastTokenCount:i}),Ci()}catch(s){console.error("[Demo] Error:",s),T.updateMessage(e,`**Error:** ${s instanceof Error?s.message:String(s)}`,!0)}finally{L.setState({isGenerating:!1}),T.enableInput()}}function Ti(){if(L.getState().isGenerating)try{X.getAbortController().abort("User stopped generation")}catch(e){console.warn("[Demo] Abort failed:",e)}finally{L.setState({isGenerating:!1}),T.enableInput()}}function Ci(){var o;const n=L.getState(),e=X.getHistory(),t=n.activeConversationId||`conv-${Date.now()}`,s=[...n.conversations],r=s.findIndex(l=>l.id===t),a=((o=e.find(l=>l.role==="user"))==null?void 0:o.content)||"New conversation",i=a.slice(0,30)+(a.length>30?"...":"");r>=0?s[r]={...s[r],messages:e,timestamp:Date.now()}:s.unshift({id:t,title:i,messages:e,timestamp:Date.now()}),L.setState({conversations:s,activeConversationId:t})}function cr(){T.clearMessages(),X.clearHistory(),L.setState({activeConversationId:null,lastLatencyMs:null,lastTokenCount:null}),T.focusInput()}function Ei(n){const t=L.getState().conversations.find(s=>s.id===n);t&&(T.clearMessages(),T.hideWelcomeScreen(),t.messages.forEach(s=>{s.role==="user"?T.appendMessage("user",s.content):s.role==="assistant"&&T.appendMessage("ai",s.content)}),X.setHistory(t.messages),L.setState({activeConversationId:n}),T.scrollToBottom(),T.focusInput())}function Li(n){if(!confirm("Are you sure you want to delete this conversation?"))return;const e=L.getState(),t=e.conversations.filter(s=>s.id!==n);e.activeConversationId===n&&cr(),L.setState({conversations:t})}function Ii(n,e){const s=L.getState().conversations.map(r=>r.id===n?{...r,title:e}:r);L.setState({conversations:s})}function Ai(n){L.setState({settings:n}),L.saveSettings(),Bt()}function Ri(){const n=L.getState();L.setState({isStreamEnabled:!n.isStreamEnabled}),Bt()}ui();
